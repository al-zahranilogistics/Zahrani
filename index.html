<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alzahrani Logistics | PetroWeb Update System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- ุฅุถุงูุฉ SheetJS ููุฑุงุกุฉ ูููุงุช Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #1a237e;
            --secondary: #0d47a1;
            --success: #2e7d32;
            --danger: #c62828;
            --warning: #f57c00;
            --info: #0277bd;
            --light: #f5f5f5;
            --dark: #121212;
            --border: #e0e0e0;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --radius: 12px;
            --glow: 0 0 20px rgba(26, 35, 126, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', 'Cairo', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            color: #333;
        }

        /* Language Toggle */
        .lang-toggle {
            position: fixed;
            top: 25px;
            right: 25px;
            z-index: 1000;
            background: white;
            border-radius: 50px;
            padding: 6px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 2px;
            border: 1px solid #e0e0e0;
        }

        .lang-btn {
            background: none;
            border: none;
            width: 46px;
            height: 46px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            transition: all 0.3s ease;
            color: #555;
        }

        .lang-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            transform: scale(1.05);
            box-shadow: var(--glow);
        }

        .lang-btn:hover:not(.active) {
            background: #f0f0f0;
            color: var(--primary);
        }

        /* Header & Logo */
        header {
            background: white;
            padding: 25px 0 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-bottom: 3px solid var(--primary);
        }

        .logo-container {
            max-width: 800px;
            margin: 0 auto 20px;
            padding: 0 20px;
            text-align: center;
        }

        .logo-main {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 25px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .logo-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            border: 5px solid white;
            box-shadow: var(--glow), 0 0 30px rgba(26, 35, 126, 0.4);
            animation: glowPulse 3s infinite alternate;
            transition: all 0.3s ease;
        }

        @keyframes glowPulse {
            0% { box-shadow: var(--glow), 0 0 20px rgba(26, 35, 126, 0.3); }
            100% { box-shadow: var(--glow), 0 0 40px rgba(26, 35, 126, 0.6); }
        }

        .logo-circle:hover {
            transform: scale(1.05);
            box-shadow: var(--glow), 0 0 50px rgba(26, 35, 126, 0.7);
        }

        .logo-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .logo-text {
            text-align: center;
        }

        .logo-arabic {
            color: var(--primary);
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 5px;
            font-family: 'Cairo', sans-serif;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .logo-english {
            color: var(--secondary);
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .logo-subtitle {
            color: #666;
            font-size: 1.2rem;
            font-weight: 500;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            padding: 2px 0;
        }

        .system-title {
            text-align: center;
            color: var(--primary);
            font-size: 1.8rem;
            margin: 10px auto 25px;
            padding: 12px 30px;
            background: rgba(26, 35, 126, 0.05);
            border-radius: var(--radius);
            display: inline-block;
            border-right: 4px solid var(--primary);
            border-left: 4px solid var(--primary);
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 25px;
        }

        /* Auth Container */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 70vh;
            padding: 20px;
        }

        .auth-box {
            background: white;
            border-radius: var(--radius);
            padding: 40px;
            width: 100%;
            max-width: 480px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 35px;
            border-bottom: 2px solid #eee;
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 18px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            color: #666;
        }

        .auth-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: rgba(26, 35, 126, 0.03);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            color: var(--dark);
            font-weight: 600;
            font-size: 1rem;
        }

        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background: #fafafa;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
        }

        .btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            letter-spacing: 0.3px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(26, 35, 126, 0.2);
        }

        .btn-success { background: linear-gradient(135deg, var(--success), #4caf50); }
        .btn-warning { background: linear-gradient(135deg, var(--warning), #ff9800); }
        .btn-danger { background: linear-gradient(135deg, var(--danger), #f44336); }
        .btn-info { background: linear-gradient(135deg, var(--info), #29b6f6); }

        /* Dashboard */
        .dashboard {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .user-info {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            border-right: 5px solid var(--primary);
        }

        .user-details h3 {
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 1.5rem;
        }

        .user-details p {
            color: #666;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-details i {
            color: var(--secondary);
        }

        .logout-btn {
            background: linear-gradient(135deg, #d32f2f, #f44336);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(211, 47, 47, 0.3);
        }

        /* Dashboard Navigation */
        .dashboard-nav {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 35px;
        }

        .nav-btn {
            background: white;
            border: none;
            padding: 30px 20px;
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            border-top: 4px solid transparent;
        }

        .nav-btn:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.12);
        }

        .nav-btn.vehicle { border-top-color: #4caf50; }
        .nav-btn.records { border-top-color: #2196f3; }
        .nav-btn.admin { border-top-color: #ff9800; }
        .nav-btn.profile { border-top-color: #9c27b0; }
        .nav-btn.excel { border-top-color: #009688; }
        .nav-btn.chip { border-top-color: #ff5722; }
        .nav-btn.status { border-top-color: #673ab7; }

        .nav-btn i {
            font-size: 46px;
            margin-bottom: 5px;
        }

        .nav-btn.vehicle i { color: #4caf50; }
        .nav-btn.records i { color: #2196f3; }
        .nav-btn.admin i { color: #ff9800; }
        .nav-btn.profile i { color: #9c27b0; }
        .nav-btn.excel i { color: #009688; }
        .nav-btn.chip i { color: #ff5722; }
        .nav-btn.status i { color: #673ab7; }

        .nav-btn span {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
        }

        .nav-btn p {
            color: #666;
            font-size: 0.95rem;
            margin-top: 5px;
            line-height: 1.4;
        }

        /* Content Sections */
        .content-section {
            background: white;
            border-radius: var(--radius);
            padding: 35px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            display: none;
            border: 1px solid #eee;
        }

        .content-section.active {
            display: block;
            animation: slideUp 0.4s ease;
        }

        .section-title {
            color: var(--primary);
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
            font-size: 1.7rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .section-title i {
            color: var(--secondary);
            background: rgba(26, 35, 126, 0.08);
            padding: 12px;
            border-radius: 10px;
        }

        /* Vehicle Form */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .file-upload-area {
            border: 3px dashed #bdbdbd;
            border-radius: var(--radius);
            padding: 50px 30px;
            text-align: center;
            margin: 30px 0;
            cursor: pointer;
            transition: all 0.3s;
            background: #f9f9f9;
        }

        .file-upload-area:hover {
            border-color: var(--primary);
            background: rgba(26, 35, 126, 0.02);
        }

        .file-upload-area i {
            font-size: 60px;
            color: #757575;
            margin-bottom: 20px;
        }

        .file-upload-area h4 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1.4rem;
        }

        .file-upload-area p {
            color: #666;
            margin-bottom: 20px;
        }

        /* Project Selection */
        .project-selection {
            margin: 20px 0;
        }

        .project-search {
            position: relative;
            margin-bottom: 15px;
        }

        .project-search input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            background: #fafafa;
        }

        .project-search i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .projects-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            background: #f9f9f9;
        }

        .project-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-item:hover {
            background: #e3f2fd;
            transform: translateX(-5px);
        }

        .project-item.selected {
            background: #e8f5e9;
            border-right: 4px solid #4caf50;
            font-weight: 500;
        }

        .project-item:last-child {
            border-bottom: none;
        }

        /* Custom Option Styles */
        .custom-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .custom-option input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .custom-option .btn-add {
            background: var(--success);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .custom-option .btn-add:hover {
            background: #2e7d32;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius);
            border: 1px solid #eee;
            margin-top: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        .data-table thead {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .data-table th {
            padding: 18px 20px;
            text-align: right;
            color: white;
            font-weight: 600;
            font-size: 1.05rem;
            border: none;
        }

        .data-table tbody tr {
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }

        .data-table tbody tr:hover {
            background: #f9f9f9;
        }

        .data-table td {
            padding: 18px 20px;
            text-align: right;
            color: #444;
            vertical-align: middle;
        }

        .timestamp-cell {
            direction: ltr;
            text-align: left;
            font-family: monospace;
            font-size: 0.95rem;
            color: #666;
            background: #f8f9fa;
            border-radius: 4px;
            padding: 8px 12px;
            display: inline-block;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            min-width: 90px;
            justify-content: center;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .edit-btn { background: linear-gradient(135deg, #ff9800, #ffb74d); }
        .delete-btn { background: linear-gradient(135deg, #f44336, #ef5350); }
        .approve-btn { background: linear-gradient(135deg, #4caf50, #66bb6a); }
        .update-btn { background: linear-gradient(135deg, #2196f3, #42a5f5); }
        .view-btn { background: linear-gradient(135deg, #9c27b0, #ab47bc); }
        .download-btn { background: linear-gradient(135deg, #607d8b, #78909c); }

        /* Admin Specific */
        .admin-only {
            border-left: 5px solid var(--warning);
            position: relative;
        }

        .admin-only::before {
            content: "๐";
            position: absolute;
            top: -12px;
            left: -15px;
            background: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* Status Badges */
        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            display: inline-block;
        }

        .status-active { background: #e8f5e9; color: #2e7d32; }
        .status-pending { background: #fff3e0; color: #ef6c00; }
        .status-inactive { background: #ffebee; color: #c62828; }
        .status-working { background: #e3f2fd; color: #1565c0; }
        .status-stopped { background: #fce4ec; color: #ad1457; }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius);
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: slideUp 0.4s ease;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: var(--radius) var(--radius) 0 0;
        }

        .modal-header h2 {
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close-modal:hover {
            background: #f5f5f5;
            color: var(--danger);
        }

        .modal-body {
            padding: 30px;
        }

        /* Messages */
        .message {
            padding: 18px 25px;
            border-radius: var(--radius);
            margin: 20px 0;
            display: none;
            align-items: center;
            gap: 15px;
            font-weight: 500;
            border: 1px solid transparent;
        }

        .message i {
            font-size: 22px;
        }

        .success {
            background: #e8f5e9;
            color: #2e7d32;
            border-color: #c8e6c9;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            border-color: #ffcdd2;
        }

        .info {
            background: #e3f2fd;
            color: #1565c0;
            border-color: #bbdefb;
        }

        /* Excel Preview */
        .excel-preview {
            margin-top: 30px;
        }

        .preview-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        /* Excel Upload Buttons */
        .excel-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        /* Excel Template Download */
        .template-download {
            background: #f8f9fa;
            border-radius: var(--radius);
            padding: 25px;
            margin: 20px 0;
            border: 2px solid var(--primary);
        }

        .template-download h3 {
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Vehicle Status Section */
        .vehicle-status-section {
            background: #f8f9fa;
            border-radius: var(--radius);
            padding: 25px;
            margin: 20px 0;
            border: 2px solid #e0e0e0;
        }

        .chip-request-section {
            background: #fff8e1;
            border-radius: var(--radius);
            padding: 25px;
            margin: 20px 0;
            border: 2px solid #ffd54f;
        }

        /* Bulk Update Styles */
        .selection-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .selection-option {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .selection-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .selection-option.active {
            border-color: var(--primary);
            background: rgba(26, 35, 126, 0.05);
            box-shadow: 0 4px 12px rgba(26, 35, 126, 0.15);
        }

        .selection-option i {
            font-size: 24px;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .selection-option span {
            font-weight: 600;
            color: var(--dark);
        }

        .selection-option small {
            color: #666;
            font-size: 0.85rem;
            line-height: 1.3;
        }

        /* Checkbox Styles */
        .vehicle-checkbox {
            text-align: center;
        }

        .vehicle-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Vehicle Count */
        #vehicleCountInfo {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        #vehicleCountInfo > div {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: 600;
        }

        #updateInfo {
            padding: 8px 12px;
            background: #fff3e0;
            border-radius: 6px;
            border: 1px solid #ffb74d;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #updateInfo i {
            color: #ff9800;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* RTL/LTR Support */
        [dir="rtl"] {
            text-align: right;
        }

        [dir="ltr"] {
            text-align: left;
        }

        [dir="ltr"] .lang-toggle {
            right: auto;
            left: 25px;
        }

        [dir="ltr"] .user-info {
            border-right: none;
            border-left: 5px solid var(--primary);
        }

        [dir="ltr"] .admin-only {
            border-left: none;
            border-right: 5px solid var(--warning);
        }

        [dir="ltr"] .admin-only::before {
            left: auto;
            right: -15px;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .dashboard-nav {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            }
            
            .content-section {
                padding: 25px;
            }
            
            .selection-options {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .auth-box {
                padding: 30px 25px;
                margin: 15px;
            }
            
            .user-info {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .logo-main {
                gap: 15px;
            }
            
            .logo-circle {
                width: 100px;
                height: 100px;
            }
            
            .logo-arabic {
                font-size: 2.2rem;
            }
            
            .logo-english {
                font-size: 1.6rem;
            }
            
            .nav-btn {
                padding: 25px 15px;
            }
            
            .excel-actions {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 8px;
            }
            
            .selection-options {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .lang-toggle {
                top: 15px;
                right: 15px;
            }
            
            .lang-btn {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .action-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Language Toggle -->
    <div class="lang-toggle">
        <button class="lang-btn active" onclick="changeLanguage('ar')" data-lang="ar">
            <i class="fas fa-language"></i>
        </button>
        <button class="lang-btn" onclick="changeLanguage('en')" data-lang="en">
            <i class="fas fa-language"></i>
        </button>
    </div>

    <!-- Header with Logo -->
    <header>
        <div class="logo-container">
            <div class="logo-main">
                <div class="logo-circle">
                    <img src="https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=375,fit=crop,q=95/dOqNLp8LNNTl7Vlk/alzahrani-logistics-corporate-logo-photoroom-AR03Qav69VTGKk9B.png" alt="ุดุนุงุฑ ุงูุฒูุฑุงูู ููุฌุณุชูู">
                </div>
                <div class="logo-text">
                    <div class="logo-arabic">ุงูุฒูุฑุงูู ููุฌุณุชูู</div>
                    <div class="logo-english">Alzahrani Logistics</div>
                    <div class="logo-subtitle" data-i18n="systemSubtitle">ูุธุงู ุชุญุฏูุซ ุจูุงูุงุช ุงููููุฏ ูุงููุฑูุจุงุช</div>
                </div>
            </div>
            <div class="system-title">
                <i class="fas fa-gas-pump"></i>
                <span data-i18n="systemTitle">ูุธุงู ุชุญุฏูุซ ุจูุงูุงุช ุงููููุฏ ูุงููุฑูุจุงุช</span>
            </div>
        </div>
    </header>

    <!-- Login/Register Container -->
    <div class="container auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="showAuthForm('login')" data-i18n="login">ุชุณุฌูู ุงูุฏุฎูู</div>
                <div class="auth-tab" onclick="showAuthForm('register')" data-i18n="register">ุชุณุฌูู ูุดุฑู ุฌุฏูุฏ</div>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="auth-form active">
                <div class="form-group">
                    <label class="form-label" data-i18n="username">ุงุณู ุงููุณุชุฎุฏู</label>
                    <input type="text" id="loginUsername" class="form-input" placeholder="ุฃุฏุฎู ุงุณู ุงููุณุชุฎุฏู" data-i18n-ph="enterUsername">
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="password">ูููุฉ ุงููุฑูุฑ</label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ" data-i18n-ph="enterPassword">
                </div>
                <button type="submit" class="btn">
                    <i class="fas fa-sign-in-alt"></i>
                    <span data-i18n="loginBtn">ุฏุฎูู ุฅูู ุงููุธุงู</span>
                </button>
            </form>

            <!-- Register Form -->
            <form id="registerForm" class="auth-form">
                <div class="form-group">
                    <label class="form-label" data-i18n="username">ุงุณู ุงููุณุชุฎุฏู</label>
                    <input type="text" id="regUsername" class="form-input" placeholder="ุงุฎุชุฑ ุงุณู ูุณุชุฎุฏู ูุฑูุฏ" data-i18n-ph="chooseUsername">
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="password">ูููุฉ ุงููุฑูุฑ</label>
                    <input type="password" id="regPassword" class="form-input" placeholder="ูููุฉ ูุฑูุฑ ูููุฉ" data-i18n-ph="strongPassword">
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="project">ุงููุดุฑูุน ุงููุณุคูู ุนูู</label>
                    <div class="project-selection">
                        <div class="project-search">
                            <i class="fas fa-search"></i>
                            <input type="text" id="projectSearch" placeholder="ุงุจุญุซ ุนู ุงููุดุฑูุน..." onkeyup="filterProjects()" data-i18n-ph="searchProject">
                        </div>
                        <div class="projects-list" id="projectsList">
                            <!-- Projects will be populated by JavaScript -->
                        </div>
                        <!-- Custom Project Input -->
                        <div class="custom-option">
                            <input type="text" id="customProjectInput" placeholder="ุฃุถู ูุดุฑูุน ุฌุฏูุฏ ูุฏููุงู..." data-i18n-ph="addCustomProject">
                            <button type="button" class="btn-add" onclick="addCustomProject()">
                                <i class="fas fa-plus"></i> <span data-i18n="add">ุฅุถุงูุฉ</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="area">ุงูููุทูุฉ</label>
                    <div style="position: relative;">
                        <select id="regArea" class="form-input" required>
                            <option value="" data-i18n="selectArea">ุงุฎุชุฑ ุงูููุทูุฉ</option>
                        </select>
                        <!-- Custom Area Input -->
                        <div class="custom-option" style="margin-top: 10px;">
                            <input type="text" id="customAreaInput" placeholder="ุฃุถู ููุทูุฉ ุฌุฏูุฏุฉ ูุฏููุงู..." data-i18n-ph="addCustomArea">
                            <button type="button" class="btn-add" onclick="addCustomArea()">
                                <i class="fas fa-plus"></i> <span data-i18n="add">ุฅุถุงูุฉ</span>
                            </button>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-user-plus"></i>
                    <span data-i18n="registerBtn">ุชุณุฌูู ุงููุดุฑู ุงูุฌุฏูุฏ</span>
                </button>
            </form>

            <!-- Messages -->
            <div id="authMessage" class="message"></div>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="container dashboard" id="dashboard">
        <!-- User Info -->
        <div class="user-info">
            <div class="user-details">
                <h3 id="userName"></h3>
                <p>
                    <i class="fas fa-user-tag"></i>
                    <span id="userRole"></span>
                    | 
                    <i class="fas fa-project-diagram"></i>
                    <span id="userProject"></span>
                    |
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="userArea"></span>
                </p>
            </div>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span data-i18n="logout">ุชุณุฌูู ุงูุฎุฑูุฌ</span>
            </button>
        </div>

        <!-- Navigation -->
        <div class="dashboard-nav">
            <button class="nav-btn vehicle" onclick="showSection('vehicleSection')">
                <i class="fas fa-truck-moving"></i>
                <span data-i18n="addVehicle">ุฅุถุงูุฉ ูุฑูุจุฉ ุฌุฏูุฏุฉ</span>
                <p data-i18n="addVehicleDesc">ุฅุฏุฎุงู ุจูุงูุงุช ูุฑูุจุฉ ุฌุฏูุฏุฉ ูุฏููุงู</p>
            </button>
            
            <button class="nav-btn excel" onclick="showSection('excelSection')">
                <i class="fas fa-file-excel"></i>
                <span data-i18n="uploadExcel">ุฑูุน ููู ุฅูุณู</span>
                <p data-i18n="uploadExcelDesc">ุฑูุน ููู ุฅูุณู ูุญุชูู ุนูู ุจูุงูุงุช ูุฑูุจุงุช</p>
            </button>
            
            <button class="nav-btn records" onclick="showSection('recordsSection')">
                <i class="fas fa-database"></i>
                <span data-i18n="viewRecords">ุนุฑุถ ุฌููุน ุงูุณุฌูุงุช</span>
                <p data-i18n="viewRecordsDesc">ุนุฑุถ ูุชุนุฏูู ุณุฌูุงุช ุงููุฑูุจุงุช</p>
            </button>
            
            <button class="nav-btn status" onclick="showSection('vehicleStatusSection')">
                <i class="fas fa-car-battery"></i>
                <span data-i18n="vehicleStatus">ุญุงูุฉ ุงููุฑูุจุฉ</span>
                <p data-i18n="vehicleStatusDesc">ุชุญุฏูุซ ุญุงูุฉ ุงููุฑูุจุฉ (ุชุนูู/ูุชูููุฉ)</p>
            </button>
            
            <button class="nav-btn chip" onclick="showSection('chipRequestSection')">
                <i class="fas fa-sim-card"></i>
                <span data-i18n="chipRequest">ุทูุจ ุดุฑูุญุฉ</span>
                <p data-i18n="chipRequestDesc">ุทูุจ ุดุฑูุญุฉ ุฌุฏูุฏุฉ ุฃู ุงุณุชุจุฏุงู ุชุงููุฉ</p>
            </button>
            
            <button class="nav-btn admin" onclick="showSection('adminSection')" id="adminNavBtn">
                <i class="fas fa-crown"></i>
                <span data-i18n="adminPanel">ููุญุฉ ุชุญูู ุงููุณุคูู</span>
                <p data-i18n="adminPanelDesc">ุฅุฏุงุฑุฉ ุงููุดุฑููู ูุงูุตูุงุญูุงุช</p>
            </button>
            
            <button class="nav-btn profile" onclick="showSection('profileSection')">
                <i class="fas fa-user-cog"></i>
                <span data-i18n="updateProfile">ุงูููู ุงูุดุฎุตู</span>
                <p data-i18n="updateProfileDesc">ุชุญุฏูุซ ุจูุงูุงุช ุงูุญุณุงุจ ุงูุดุฎุตู</p>
            </button>
        </div>

        <!-- Vehicle Entry Section -->
        <div id="vehicleSection" class="content-section">
            <h2 class="section-title">
                <i class="fas fa-truck-moving"></i>
                <span data-i18n="vehicleEntry">ุฅุฏุฎุงู ุจูุงูุงุช ูุฑูุจุฉ ุฌุฏูุฏุฉ</span>
            </h2>
            <form id="vehicleForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" data-i18n="plateNumber">ุฑูู ุงูููุญุฉ</label>
                        <input type="text" id="plateNumber" class="form-input" placeholder="ูุซุงู: ABC 1234" data-i18n-ph="plateExample" maxlength="10" oninput="validatePlateNumberInput(this)">
                        <div id="plateWarning" style="color: #d32f2f; font-size: 0.85rem; margin-top: 5px; display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="area">ุงูููุทูุฉ</label>
                        <div style="position: relative;">
                            <select id="vehicleArea" class="form-input" required>
                                <option value="" data-i18n="selectArea">ุงุฎุชุฑ ุงูููุทูุฉ</option>
                            </select>
                            <!-- Custom Area Input -->
                            <div class="custom-option" style="margin-top: 10px;">
                                <input type="text" id="vehicleCustomAreaInput" placeholder="ุฃุถู ููุทูุฉ ุฌุฏูุฏุฉ ูุฏููุงู..." data-i18n-ph="addCustomArea">
                                <button type="button" class="btn-add" onclick="addCustomVehicleArea()">
                                    <i class="fas fa-plus"></i> <span data-i18n="add">ุฅุถุงูุฉ</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Project Selection with Search -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" data-i18n="previousProject">ุงููุดุฑูุน ุงูุณุงุจู</label>
                        <div class="project-selection">
                            <div class="project-search">
                                <i class="fas fa-search"></i>
                                <input type="text" id="prevProjectSearch" placeholder="ุงุจุญุซ ุนู ุงููุดุฑูุน ุงูุณุงุจู..." onkeyup="filterPrevProjects()" data-i18n-ph="searchPreviousProject">
                            </div>
                            <div class="projects-list" id="prevProjectsList" style="max-height: 200px;">
                                <!-- Previous projects will be populated by JavaScript -->
                            </div>
                        </div>
                        <input type="hidden" id="previousProject">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" data-i18n="currentProject">ุงููุดุฑูุน ุงูุญุงูู</label>
                        <div class="project-selection">
                            <div class="project-search">
                                <i class="fas fa-search"></i>
                                <input type="text" id="currProjectSearch" placeholder="ุงุจุญุซ ุนู ุงููุดุฑูุน ุงูุญุงูู..." onkeyup="filterCurrProjects()" data-i18n-ph="searchCurrentProject">
                            </div>
                            <div class="projects-list" id="currProjectsList" style="max-height: 200px;">
                                <!-- Current projects will be populated by JavaScript -->
                            </div>
                        </div>
                        <input type="hidden" id="currentProject">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" data-i18n="additionalInfo">ูุนูููุงุช ุฅุถุงููุฉ (ุงุฎุชูุงุฑู)</label>
                        <input type="text" id="additionalInfo" class="form-input" placeholder="ููุงุญุธุงุช ุฅุถุงููุฉ ุนู ุงููุฑูุจุฉ" data-i18n-ph="additionalNotes">
                    </div>
                </div>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i>
                    <span data-i18n="saveVehicle">ุญูุธ ุจูุงูุงุช ุงููุฑูุจุฉ</span>
                </button>
            </form>
        </div>

        <!-- Excel Upload Section -->
        <div id="excelSection" class="content-section">
            <h2 class="section-title">
                <i class="fas fa-file-excel"></i>
                <span data-i18n="uploadExcel">ุฑูุน ููู ุฅูุณู ููุจูุงูุงุช</span>
            </h2>
            
            <!-- Excel Template Download -->
            <div class="template-download">
                <h3><i class="fas fa-download"></i> <span data-i18n="downloadTemplate">ุชุญููู ูุงูุจ Excel</span></h3>
                <p data-i18n="templateDescription">ูู ุจุชุญููู ุงููุงูุจ ูููุฆู ุจุงูุจูุงูุงุช ุซู ุงุฑูุนู ูููุธุงู</p>
                <div class="excel-actions">
                    <button class="btn btn-info" onclick="downloadExcelTemplate()">
                        <i class="fas fa-file-download"></i>
                        <span data-i18n="downloadTemplateBtn">ุชุญููู ูุงูุจ Excel</span>
                    </button>
                    <button class="btn btn-warning" onclick="downloadExcelTemplateWithData()">
                        <i class="fas fa-database"></i>
                        <span data-i18n="downloadWithData">ุชุญููู ูุน ุงูุจูุงูุงุช ุงูุญุงููุฉ</span>
                    </button>
                </div>
            </div>
            
            <div class="file-upload-area" onclick="document.getElementById('excelFileInput').click()" id="excelDropArea">
                <i class="fas fa-file-upload"></i>
                <h4 data-i18n="dropFile">ุงุณุญุจ ูุฃููุช ููู ุฅูุณู ููุง</h4>
                <p data-i18n="clickToUpload">ุฃู ุงููุฑ ูุงุฎุชูุงุฑ ุงูููู ูู ุงูุฌูุงุฒ</p>
                <p style="color: #666; font-size: 0.9rem;" data-i18n="excelFormat">
                    ูุฌุจ ุฃู ูุญุชูู ุงูููู ุนูู ุงูุฃุนูุฏุฉ ุงูุชุงููุฉ:<br>
                    <strong>ุฑูู ุงูููุญุฉ</strong>ุ <strong>ุงููุดุฑูุน ุงูุณุงุจู</strong>ุ <strong>ุงููุดุฑูุน ุงูุญุงูู</strong>ุ <strong>ุงูููุทูุฉ</strong>ุ <strong>ุญุงูุฉ ุงููุฑูุจุฉ</strong>
                </p>
                <p style="color: var(--warning); font-size: 0.85rem;">
                    <i class="fas fa-info-circle"></i> ูููู ุฃู ุชููู ุงูุฃุนูุฏุฉ ุจุฃู ุชุฑุชูุจ
                </p>
                <input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleExcelFileSelect(event)">
            </div>
            
            <!-- Excel Preview Table -->
            <div class="excel-preview" id="excelPreview" style="display: none;">
                <div class="preview-title">
                    <h3><i class="fas fa-table"></i> <span data-i18n="previewData">ูุนุงููุฉ ุงูุจูุงูุงุช</span></h3>
                    <div class="excel-actions">
                        <button class="btn btn-success" onclick="uploadExcelData()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span data-i18n="uploadData">ุฑูุน ุงูุจูุงูุงุช ุฅูู ุงููุธุงู</span>
                        </button>
                        <button class="btn btn-warning" onclick="updateExcelData()">
                            <i class="fas fa-sync-alt"></i>
                            <span data-i18n="updateData">ุชุญุฏูุซ ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ</span>
                        </button>
                    </div>
                </div>
                <div id="excelStats" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e0e0e0;">
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div><strong>ุนุฏุฏ ุงููุฑูุจุงุช:</strong> <span id="vehicleCount">0</span></div>
                        <div><strong>ุฅุฏุฎุงูุงุช ุฌุฏูุฏุฉ:</strong> <span id="newEntriesCount">0</span></div>
                        <div><strong>ุชุญุฏูุซุงุช:</strong> <span id="updateEntriesCount">0</span></div>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table" id="excelPreviewTable">
                        <thead>
                            <tr>
                                <th data-i18n="plateNumber">ุฑูู ุงูููุญุฉ</th>
                                <th data-i18n="previousProject">ุงููุดุฑูุน ุงูุณุงุจู</th>
                                <th data-i18n="currentProject">ุงููุดุฑูุน ุงูุญุงูู</th>
                                <th data-i18n="area">ุงูููุทูุฉ</th>
                                <th data-i18n="vehicleStatus">ุญุงูุฉ ุงููุฑูุจุฉ</th>
                                <th data-i18n="action">ุงูุฅุฌุฑุงุก</th>
                                <th>ููุงุญุธุงุช</th>
                            </tr>
                        </thead>
                        <tbody id="excelPreviewBody">
                            <!-- Excel data will be previewed here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Records Section -->
        <div id="recordsSection" class="content-section">
            <h2 class="section-title">
                <i class="fas fa-database"></i>
                <span data-i18n="vehicleRecords">ุณุฌูุงุช ุงููุฑูุจุงุช</span>
            </h2>
            <div class="form-row" style="margin-bottom: 30px;">
                <div class="form-group">
                    <label class="form-label" data-i18n="filterBy">ุชุตููุฉ ุญุณุจ:</label>
                    <select id="filterArea" class="form-input" onchange="filterRecords()">
                        <option value="" data-i18n="allAreas">ุฌููุน ุงูููุงุทู</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="filterByProject">ุชุตููุฉ ุจุงููุดุฑูุน:</label>
                    <select id="filterProject" class="form-input" onchange="filterRecords()">
                        <option value="" data-i18n="allProjects">ุฌููุน ุงููุดุงุฑูุน</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="filterByStatus">ุชุตููุฉ ุจุงูุญุงูุฉ:</label>
                    <select id="filterStatus" class="form-input" onchange="filterRecords()">
                        <option value="" data-i18n="allStatuses">ุฌููุน ุงูุญุงูุงุช</option>
                        <option value="working" data-i18n="working">ุชุนูู</option>
                        <option value="stopped" data-i18n="stopped">ูุชูููุฉ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="searchPlate">ุจุญุซ ุจุฑูู ุงูููุญุฉ:</label>
                    <input type="text" id="searchPlate" class="form-input" placeholder="ุงุจุญุซ ุจุฑูู ุงูููุญุฉ..." onkeyup="filterRecords()" data-i18n-ph="searchPlateNumber">
                </div>
            </div>
            
            <div class="excel-actions" style="margin-bottom: 20px;">
                <button class="btn btn-info" onclick="downloadAllRecords()">
                    <i class="fas fa-file-excel"></i>
                    <span data-i18n="downloadRecords">ุชุญููู ุงูุณุฌูุงุช ูููู Excel</span>
                </button>
            </div>
            
            <div class="table-container">
                <table class="data-table" id="recordsTable">
                    <thead>
                        <tr>
                            <th data-i18n="plateNumber">ุฑูู ุงูููุญุฉ</th>
                            <th data-i18n="area">ุงูููุทูุฉ</th>
                            <th data-i18n="previousProject">ุงููุดุฑูุน ุงูุณุงุจู</th>
                            <th data-i18n="currentProject">ุงููุดุฑูุน ุงูุญุงูู</th>
                            <th data-i18n="vehicleStatus">ุญุงูุฉ ุงููุฑูุจุฉ</th>
                            <th data-i18n="lastUpdate">ุขุฎุฑ ุชุญุฏูุซ</th>
                            <th data-i18n="updatedBy">ูุญุฏุซ ุจูุงุณุทุฉ</th>
                            <th data-i18n="actions">ุงูุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="recordsBody">
                        <!-- Records will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Vehicle Status Section -->
        <div id="vehicleStatusSection" class="content-section">
            <h2 class="section-title">
                <i class="fas fa-car-battery"></i>
                <span data-i18n="updateVehicleStatus">ุชุญุฏูุซ ุญุงูุฉ ุงููุฑูุจุฉ</span>
            </h2>
            
            <!-- Individual Status Update -->
            <div class="vehicle-status-section">
                <form id="vehicleStatusForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" data-i18n="plateNumber">ุฑูู ุงูููุญุฉ</label>
                            <input type="text" id="statusPlateNumber" class="form-input" placeholder="ุฃุฏุฎู ุฑูู ุงูููุญุฉ" data-i18n-ph="enterPlateNumber" oninput="searchVehicleForStatus()">
                            <div id="vehicleStatusResult" style="margin-top: 10px;"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-i18n="vehicleStatus">ุญุงูุฉ ุงููุฑูุจุฉ</label>
                            <select id="vehicleStatus" class="form-input" required>
                                <option value="" data-i18n="selectStatus">ุงุฎุชุฑ ุงูุญุงูุฉ</option>
                                <option value="working" data-i18n="working">ุชุนูู/Working</option>
                                <option value="stopped" data-i18n="stopped">ูุชูููุฉ/Stopped</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" data-i18n="statusNotes">ููุงุญุธุงุช ุงูุญุงูุฉ (ุงุฎุชูุงุฑู)</label>
                            <textarea id="statusNotes" class="form-input" rows="3" placeholder="ุฃุฏุฎู ููุงุญุธุงุช ุนู ุญุงูุฉ ุงููุฑูุจุฉ..." data-i18n-ph="enterStatusNotes"></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-sync-alt"></i>
                        <span data-i18n="updateStatus">ุชุญุฏูุซ ุญุงูุฉ ุงููุฑูุจุฉ</span>
                    </button>
                </form>
            </div>
            
            <!-- Bulk Update Controls -->
            <div class="bulk-update-section" style="background: #f8f9fa; border-radius: var(--radius); padding: 25px; margin: 40px 0 20px; border: 2px solid #e0e0e0;">
                <h3 style="color: var(--primary); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-sync-alt"></i>
                    <span data-i18n="bulkUpdate">ุชุญุฏูุซ ุฌูุงุนู ูููุฑูุจุงุช</span>
                </h3>
                
                <!-- Selection Options -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" data-i18n="updateOption">ุฎูุงุฑ ุงูุชุญุฏูุซ:</label>
                        <div class="selection-options">
                            <button type="button" class="selection-option active" onclick="selectUpdateOption('all', this)">
                                <i class="fas fa-globe"></i>
                                <span data-i18n="allVehicles">ุงููู</span>
                                <small data-i18n="allVehiclesDesc">ุชุญุฏูุซ ุฌููุน ุงููุฑูุจุงุช</small>
                            </button>
                            <button type="button" class="selection-option" onclick="selectUpdateOption('working', this)">
                                <i class="fas fa-play-circle"></i>
                                <span data-i18n="workingOnly">ุงูุชู ุชุนูู ููุท</span>
                                <small data-i18n="workingOnlyDesc">ุชุญุฏูุซ ุงููุฑูุจุงุช ุงูุชู ุญุงูุฉูุง "ุชุนูู"</small>
                            </button>
                            <button type="button" class="selection-option" onclick="selectUpdateOption('stopped', this)">
                                <i class="fas fa-stop-circle"></i>
                                <span data-i18n="stoppedOnly">ุงููุชูููุฉ ููุท</span>
                                <small data-i18n="stoppedOnlyDesc">ุชุญุฏูุซ ุงููุฑูุจุงุช ุงูุชู ุญุงูุฉูุง "ูุชูููุฉ"</small>
                            </button>
                            <button type="button" class="selection-option" onclick="selectUpdateOption('manual', this)">
                                <i class="fas fa-hand-pointer"></i>
                                <span data-i18n="manualSelect">ุงููุญุฏุฏุฉ ูุฏููุงู</span>
                                <small data-i18n="manualSelectDesc">ุชุญุฏูุฏ ูุฑูุจุงุช ูุญุฏุฏุฉ ูู ุงูุฌุฏูู</small>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- New Status Selection -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" data-i18n="newStatus">ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ:</label>
                        <select id="bulkNewStatus" class="form-input" style="width: 100%;" onchange="updateVehicleSelection()">
                            <option value="" data-i18n="selectStatus">ุงุฎุชุฑ ุงูุญุงูุฉ</option>
                            <option value="working" data-i18n="working">ุชุนูู/Working</option>
                            <option value="stopped" data-i18n="stopped">ูุชูููุฉ/Stopped</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="bulkNotes">ููุงุญุธุงุช ุงูุชุญุฏูุซ:</label>
                        <textarea id="bulkStatusNotes" class="form-input" rows="2" placeholder="ุฃุฏุฎู ููุงุญุธุงุช ุนุงูุฉ ููุชุญุฏูุซ..." data-i18n-ph="enterBulkNotes"></textarea>
                    </div>
                </div>
                
                <!-- Vehicle Count and Actions -->
                <div class="form-row" style="align-items: center;">
                    <div class="form-group" style="flex: 1;">
                        <div id="vehicleCountInfo">
                            <div style="background: var(--info); color: white; padding: 8px 15px; border-radius: 6px;">
                                <i class="fas fa-car"></i>
                                <span id="selectedCount">0</span> / <span id="totalCount">0</span>
                                <span data-i18n="vehicles">ูุฑูุจุฉ</span>
                            </div>
                            <div id="updateInfo">
                                <i class="fas fa-info-circle"></i>
                                <span data-i18n="smartUpdate">ุณูุชู ุชุญุฏูุซ ููุท ุงููุฑูุจุงุช ุงูุชู ุชุญุชุงุฌ ููุชุบููุฑ</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-warning" onclick="confirmBulkUpdate()" id="bulkUpdateBtn" disabled>
                            <i class="fas fa-sync-alt"></i>
                            <span data-i18n="updateSelected">ุชุญุฏูุซ ุงููุฑูุจุงุช ุงููุญุฏุฏุฉ</span>
                            (<span id="bulkCount">0</span>)
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Vehicle Selection Table -->
            <div class="table-container" style="margin-top: 20px;" id="selectionTableContainer">
                <table class="data-table" id="selectionTable">
                    <thead>
                        <tr>
                            <th width="50" id="selectAllHeader" style="display: none;">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)">
                            </th>
                            <th data-i18n="plateNumber">ุฑูู ุงูููุญุฉ</th>
                            <th data-i18n="area">ุงูููุทูุฉ</th>
                            <th data-i18n="currentProject">ุงููุดุฑูุน ุงูุญุงูู</th>
                            <th data-i18n="vehicleStatus">ุญุงูุฉ ุงููุฑูุจุฉ</th>
                            <th data-i18n="lastUpdate">ุขุฎุฑ ุชุญุฏูุซ</th>
                            <th width="100" data-i18n="needsUpdate">ูุญุชุงุฌ ุชุญุฏูุซุ</th>
                        </tr>
                    </thead>
                    <tbody id="selectionBody">
                        <!-- Vehicles will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Recent Status Updates -->
            <h3 style="margin: 40px 0 20px; color: var(--info); display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-history"></i>
                <span data-i18n="recentStatusUpdates">ุขุฎุฑ ุชุญุฏูุซุงุช ุงูุญุงูุฉ</span>
            </h3>
            <div class="table-container">
                <table class="data-table" id="statusHistoryTable">
                    <thead>
                        <tr>
                            <th data-i18n="plateNumber">ุฑูู ุงูููุญุฉ</th>
                            <th data-i18n="vehicleStatus">ุญุงูุฉ ุงููุฑูุจุฉ</th>
                            <th data-i18n="statusNotes">ููุงุญุธุงุช ุงูุญุงูุฉ</th>
                            <th data-i18n="updatedBy">ูุญุฏุซ ุจูุงุณุทุฉ</th>
                            <th data-i18n="updateDate">ุชุงุฑูุฎ ุงูุชุญุฏูุซ</th>
                        </tr>
                    </thead>
                    <tbody id="statusHistoryBody">
                        <!-- Status history will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Chip Request Section -->
        <div id="chipRequestSection" class="content-section">
            <h2 class="section-title">
                <i class="fas fa-sim-card"></i>
                <span data-i18n="chipRequest">ุทูุจ ุดุฑูุญุฉ ูููุฑูุจุฉ</span>
            </h2>
            
            <div class="chip-request-section">
                <form id="chipRequestForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" data-i18n="plateNumber">ุฑูู ููุญุฉ ุงููุฑูุจุฉ</label>
                            <input type="text" id="chipPlateNumber" class="form-input" placeholder="ุฃุฏุฎู ุฑูู ููุญุฉ ุงููุฑูุจุฉ" data-i18n-ph="enterVehiclePlate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-i18n="requestType">ููุน ุงูุทูุจ</label>
                            <select id="requestType" class="form-input" required>
                                <option value="" data-i18n="selectRequestType">ุงุฎุชุฑ ููุน ุงูุทูุจ</option>
                                <option value="new" data-i18n="newChip">ุดุฑูุญุฉ ุฌุฏูุฏุฉ/New Chip</option>
                                <option value="damaged" data-i18n="damagedChip">ุดุฑูุญุฉ ุชุงููุฉ/Damaged Chip</option>
                                <option value="replacement" data-i18n="chipReplacement">ุงุณุชุจุฏุงู ุดุฑูุญุฉ/Chip Replacement</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" data-i18n="currentChipNumber">ุฑูู ุงูุดุฑูุญุฉ ุงูุญุงูู (ุฅู ูุฌุฏ)</label>
                            <input type="text" id="currentChipNumber" class="form-input" placeholder="ุฃุฏุฎู ุฑูู ุงูุดุฑูุญุฉ ุงูุญุงูู" data-i18n-ph="enterCurrentChip">
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-i18n="requestNotes">ููุงุญุธุงุช ุงูุทูุจ</label>
                            <textarea id="requestNotes" class="form-input" rows="3" placeholder="ุฃุฏุฎู ููุงุญุธุงุช ุฅุถุงููุฉ ุนู ุงูุทูุจ..." data-i18n-ph="enterRequestNotes"></textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" data-i18n="urgentRequest">ุทูุจ ุนุงุฌู</label>
                            <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                                <input type="checkbox" id="urgentRequest" style="width: 20px; height: 20px;">
                                <label for="urgentRequest" data-i18n="urgentRequestLabel">ูุฐุง ุงูุทูุจ ุนุงุฌู</label>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-paper-plane"></i>
                        <span data-i18n="submitRequest">ุฅุฑุณุงู ุทูุจ ุงูุดุฑูุญุฉ</span>
                    </button>
                </form>
            </div>
            
            <!-- Recent Chip Requests -->
            <h3 style="margin: 40px 0 20px; color: var(--warning); display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-list"></i>
                <span data-i18n="recentChipRequests">ุทูุจุงุช ุงูุดุฑูุญุฉ ุงูุฃุฎูุฑุฉ</span>
            </h3>
            <div class="table-container">
                <table class="data-table" id="chipRequestsTable">
                    <thead>
                        <tr>
                            <th data-i18n="plateNumber">ุฑูู ุงูููุญุฉ</th>
                            <th data-i18n="requestType">ููุน ุงูุทูุจ</th>
                            <th data-i18n="currentChipNumber">ุฑูู ุงูุดุฑูุญุฉ ุงูุญุงูู</th>
                            <th data-i18n="requestNotes">ููุงุญุธุงุช ุงูุทูุจ</th>
                            <th data-i18n="urgentRequest">ุทูุจ ุนุงุฌู</th>
                            <th data-i18n="requestStatus">ุญุงูุฉ ุงูุทูุจ</th>
                            <th data-i18n="requestedBy">ููุฏู ุงูุทูุจ</th>
                            <th data-i18n="requestDate">ุชุงุฑูุฎ ุงูุทูุจ</th>
                        </tr>
                    </thead>
                    <tbody id="chipRequestsBody">
                        <!-- Chip requests will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Admin Section -->
        <div id="adminSection" class="content-section admin-only">
            <h2 class="section-title">
                <i class="fas fa-crown"></i>
                <span data-i18n="adminPanel">ููุญุฉ ุชุญูู ุงููุณุคูู</span>
            </h2>
            
            <!-- Quick Actions -->
            <div class="form-row" style="margin-bottom: 30px;">
                <div class="form-group">
                    <button class="btn btn-info" onclick="downloadAllDataExcel()">
                        <i class="fas fa-file-excel"></i>
                        <span data-i18n="downloadAllData">ุชุญููู ุฌููุน ุงูุจูุงูุงุช</span>
                    </button>
                </div>
                <div class="form-group">
                    <button class="btn btn-warning" onclick="downloadUsersDataExcel()">
                        <i class="fas fa-users"></i>
                        <span data-i18n="downloadUsersData">ุชุญููู ุจูุงูุงุช ุงููุณุชุฎุฏููู</span>
                    </button>
                </div>
                <div class="form-group">
                    <button class="btn btn-success" onclick="downloadChipRequestsExcel()">
                        <i class="fas fa-sim-card"></i>
                        <span data-i18n="downloadChipRequests">ุชุญููู ุทูุจุงุช ุงูุดุฑุงุฆุญ</span>
                    </button>
                </div>
            </div>
            
            <!-- Pending Approvals -->
            <h3 style="margin: 25px 0 20px; color: var(--warning); display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-user-clock"></i>
                <span data-i18n="pendingApprovals">ุทูุจุงุช ุงูุชุณุฌูู ููุฏ ุงูุงูุชุธุงุฑ</span>
                <span class="status-badge status-pending" id="pendingCount">0</span>
            </h3>
            <div class="table-container">
                <table class="data-table" id="pendingTable">
                    <thead>
                        <tr>
                            <th data-i18n="username">ุงุณู ุงููุณุชุฎุฏู</th>
                            <th data-i18n="password">ูููุฉ ุงููุฑูุฑ</th>
                            <th data-i18n="project">ุงููุดุฑูุน</th>
                            <th data-i18n="area">ุงูููุทูุฉ</th>
                            <th data-i18n="registerDate">ุชุงุฑูุฎ ุงูุชุณุฌูู</th>
                            <th data-i18n="actions">ุงูุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="pendingBody">
                        <!-- Pending approvals will be loaded here -->
                    </tbody>
                </table>
            </div>

            <!-- All Users -->
            <h3 style="margin: 40px 0 20px; color: var(--primary); display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-users"></i>
                <span data-i18n="allUsers">ุฌููุน ุงููุณุชุฎุฏููู</span>
                <span class="status-badge status-active" id="usersCount">0</span>
            </h3>
            <div class="form-row" style="margin-bottom: 20px;">
                <div class="form-group">
                    <label class="form-label" data-i18n="filterByUser">ุชุตููุฉ ุจุงููุณุชุฎุฏู:</label>
                    <select id="filterAdminUser" class="form-input" onchange="filterAdminUserData()">
                        <option value="" data-i18n="allUsers">ุฌููุน ุงููุณุชุฎุฏููู</option>
                    </select>
                </div>
                <div class="form-group">
                    <button class="btn btn-info" onclick="downloadUserSpecificData()" style="margin-top: 28px;">
                        <i class="fas fa-download"></i>
                        <span data-i18n="downloadUserData">ุชุญููู ุจูุงูุงุช ุงููุณุชุฎุฏู ุงููุญุฏุฏ</span>
                    </button>
                </div>
            </div>
            <div class="table-container">
                <table class="data-table" id="usersTable">
                    <thead>
                        <tr>
                            <th data-i18n="username">ุงุณู ุงููุณุชุฎุฏู</th>
                            <th data-i18n="password">ูููุฉ ุงููุฑูุฑ</th>
                            <th data-i18n="project">ุงููุดุฑูุน</th>
                            <th data-i18n="area">ุงูููุทูุฉ</th>
                            <th data-i18n="status">ุงูุญุงูุฉ</th>
                            <th data-i18n="lastLogin">ุขุฎุฑ ุฏุฎูู</th>
                            <th data-i18n="actions">ุงูุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="usersBody">
                        <!-- Users will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <!-- User Vehicle Data -->
            <h3 style="margin: 40px 0 20px; color: var(--info); display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-truck"></i>
                <span data-i18n="userVehicleData">ุจูุงูุงุช ุงููุฑูุจุงุช ูููุณุชุฎุฏููู</span>
                <span class="status-badge status-active" id="vehicleDataCount">0</span>
            </h3>
            <div class="form-row" style="margin-bottom: 20px;">
                <div class="form-group">
                    <label class="form-label" data-i18n="filterByUser">ุชุตููุฉ ุจุงููุณุชุฎุฏู:</label>
                    <select id="filterUserVehicles" class="form-input" onchange="filterUserVehicleData()">
                        <option value="" data-i18n="allUsers">ุฌููุน ุงููุณุชุฎุฏููู</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="filterByDate">ุชุตููุฉ ุจุงูุชุงุฑูุฎ:</label>
                    <input type="date" id="filterDate" class="form-input" onchange="filterUserVehicleData()">
                </div>
                <div class="form-group">
                    <button class="btn btn-info" onclick="downloadFilteredVehicleData()" style="margin-top: 28px;">
                        <i class="fas fa-download"></i>
                        <span data-i18n="downloadFilteredData">ุชุญููู ุงูุจูุงูุงุช ุงููุตูุงุฉ</span>
                    </button>
                </div>
            </div>
            <div class="table-container">
                <table class="data-table" id="userVehicleDataTable">
                    <thead>
                        <tr>
                            <th data-i18n="username">ุงุณู ุงููุณุชุฎุฏู</th>
                            <th data-i18n="plateNumber">ุฑูู ุงูููุญุฉ</th>
                            <th data-i18n="area">ุงูููุทูุฉ</th>
                            <th data-i18n="previousProject">ุงููุดุฑูุน ุงูุณุงุจู</th>
                            <th data-i18n="currentProject">ุงููุดุฑูุน ุงูุญุงูู</th>
                            <th data-i18n="vehicleStatus">ุญุงูุฉ ุงููุฑูุจุฉ</th>
                            <th data-i18n="lastUpdate">ุขุฎุฑ ุชุญุฏูุซ</th>
                            <th data-i18n="updateHistory">ุณุฌู ุงูุชุญุฏูุซุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="userVehicleDataBody">
                        <!-- User vehicle data will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Chip Requests Management -->
            <h3 style="margin: 40px 0 20px; color: #ff5722; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-sim-card"></i>
                <span data-i18n="chipRequestsManagement">ุฅุฏุงุฑุฉ ุทูุจุงุช ุงูุดุฑุงุฆุญ</span>
                <span class="status-badge status-pending" id="chipRequestsCount">0</span>
            </h3>
            <div class="form-row" style="margin-bottom: 20px;">
                <div class="form-group">
                    <label class="form-label" data-i18n="filterByStatus">ุชุตููุฉ ุจุญุงูุฉ ุงูุทูุจ:</label>
                    <select id="filterChipStatus" class="form-input" onchange="filterChipRequests()">
                        <option value="" data-i18n="allStatuses">ุฌููุน ุงูุญุงูุงุช</option>
                        <option value="pending" data-i18n="pending">ููุฏ ุงูุงูุชุธุงุฑ</option>
                        <option value="approved" data-i18n="approved">ูุนุชูุฏุฉ</option>
                        <option value="rejected" data-i18n="rejected">ูุฑููุถุฉ</option>
                        <option value="completed" data-i18n="completed">ููุชููุฉ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="filterByUrgent">ุทูุจุงุช ุนุงุฌูุฉ ููุท:</label>
                    <select id="filterUrgent" class="form-input" onchange="filterChipRequests()">
                        <option value="" data-i18n="all">ุงููู</option>
                        <option value="yes" data-i18n="yes">ูุนู</option>
                        <option value="no" data-i18n="no">ูุง</option>
                    </select>
                </div>
            </div>
            <div class="table-container">
                <table class="data-table" id="adminChipRequestsTable">
                    <thead>
                        <tr>
                            <th data-i18n="plateNumber">ุฑูู ุงูููุญุฉ</th>
                            <th data-i18n="requestType">ููุน ุงูุทูุจ</th>
                            <th data-i18n="currentChipNumber">ุฑูู ุงูุดุฑูุญุฉ ุงูุญุงูู</th>
                            <th data-i18n="requestNotes">ููุงุญุธุงุช ุงูุทูุจ</th>
                            <th data-i18n="urgentRequest">ุทูุจ ุนุงุฌู</th>
                            <th data-i18n="requestedBy">ููุฏู ุงูุทูุจ</th>
                            <th data-i18n="requestDate">ุชุงุฑูุฎ ุงูุทูุจ</th>
                            <th data-i18n="requestStatus">ุญุงูุฉ ุงูุทูุจ</th>
                            <th data-i18n="actions">ุงูุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="adminChipRequestsBody">
                        <!-- Admin chip requests will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Profile Section -->
        <div id="profileSection" class="content-section">
            <h2 class="section-title">
                <i class="fas fa-user-cog"></i>
                <span data-i18n="updateProfile">ุชุญุฏูุซ ุงูููู ุงูุดุฎุตู</span>
            </h2>
            <form id="profileForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" data-i18n="username">ุงุณู ุงููุณุชุฎุฏู</label>
                        <input type="text" id="profileUsername" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="newPassword">ูููุฉ ูุฑูุฑ ุฌุฏูุฏุฉ (ุงุฎุชูุงุฑู)</label>
                        <input type="password" id="profilePassword" class="form-input" placeholder="ุงุชุฑูู ูุงุฑุบุงู ุฅุฐุง ูู ุชุฑุฏ ุงูุชุบููุฑ" data-i18n-ph="leaveEmpty">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" data-i18n="project">ุงููุดุฑูุน</label>
                        <div class="project-selection">
                            <div class="project-search">
                                <i class="fas fa-search"></i>
                                <input type="text" id="profileProjectSearch" placeholder="ุงุจุญุซ ุนู ุงููุดุฑูุน..." onkeyup="filterProfileProjects()" data-i18n-ph="searchProject">
                            </div>
                            <div class="projects-list" id="profileProjectsList">
                                <!-- Profile projects will be populated by JavaScript -->
                            </div>
                        </div>
                        <input type="hidden" id="profileProject">
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="area">ุงูููุทูุฉ</label>
                        <select id="profileArea" class="form-input" required>
                            <option value="" data-i18n="selectArea">ุงุฎุชุฑ ุงูููุทูุฉ</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" data-i18n="currentPassword">ูููุฉ ุงููุฑูุฑ ุงูุญุงููุฉ (ูุทููุจุฉ ููุชุบููุฑ)</label>
                        <input type="password" id="currentPassword" class="form-input" placeholder="ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ ุงูุญุงููุฉ ููุชุฃููุฏ" data-i18n-ph="enterCurrentPassword">
                    </div>
                </div>
                <button type="submit" class="btn btn-warning">
                    <i class="fas fa-sync-alt"></i>
                    <span data-i18n="updateProfileBtn">ุชุญุฏูุซ ุจูุงูุงุช ุงูุญุณุงุจ</span>
                </button>
            </form>
        </div>

        <!-- Dashboard Messages -->
        <div id="dashboardMessage" class="message"></div>
    </div>

    <!-- Edit Vehicle Modal -->
    <div id="editModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-edit"></i> <span data-i18n="editVehicle">ุชุนุฏูู ุจูุงูุงุช ุงููุฑูุจุฉ</span></h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editId">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" data-i18n="plateNumber">ุฑูู ุงูููุญุฉ</label>
                            <input type="text" id="editPlate" class="form-input" required oninput="validateEditPlateNumberInput(this)">
                            <div id="editPlateWarning" style="color: #d32f2f; font-size: 0.85rem; margin-top: 5px; display: none;"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-i18n="area">ุงูููุทูุฉ</label>
                            <div style="position: relative;">
                                <select id="editArea" class="form-input" required></select>
                                <div class="custom-option" style="margin-top: 10px;">
                                    <input type="text" id="editCustomAreaInput" placeholder="ุฃุถู ููุทูุฉ ุฌุฏูุฏุฉ ูุฏููุงู..." data-i18n-ph="addCustomArea">
                                    <button type="button" class="btn-add" onclick="addCustomEditArea()">
                                        <i class="fas fa-plus"></i> <span data-i18n="add">ุฅุถุงูุฉ</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" data-i18n="previousProject">ุงููุดุฑูุน ุงูุณุงุจู</label>
                            <div class="project-selection">
                                <div class="project-search">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="editPrevProjectSearch" placeholder="ุงุจุญุซ ุนู ุงููุดุฑูุน ุงูุณุงุจู..." onkeyup="filterEditPrevProjects()" data-i18n-ph="searchPreviousProject">
                                </div>
                                <div class="projects-list" id="editPrevProjectsList" style="max-height: 200px;">
                                    <!-- Edit previous projects will be populated by JavaScript -->
                                </div>
                            </div>
                            <input type="hidden" id="editPrevProject">
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-i18n="currentProject">ุงููุดุฑูุน ุงูุญุงูู</label>
                            <div class="project-selection">
                                <div class="project-search">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="editCurrProjectSearch" placeholder="ุงุจุญุซ ุนู ุงููุดุฑูุน ุงูุญุงูู..." onkeyup="filterEditCurrProjects()" data-i18n-ph="searchCurrentProject">
                                </div>
                                <div class="projects-list" id="editCurrProjectsList" style="max-height: 200px;">
                                    <!-- Edit current projects will be populated by JavaScript -->
                                </div>
                            </div>
                            <input type="hidden" id="editCurrProject">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" data-i18n="vehicleStatus">ุญุงูุฉ ุงููุฑูุจุฉ</label>
                            <select id="editVehicleStatus" class="form-input">
                                <option value="" data-i18n="selectStatus">ุงุฎุชุฑ ุงูุญุงูุฉ</option>
                                <option value="working" data-i18n="working">ุชุนูู/Working</option>
                                <option value="stopped" data-i18n="stopped">ูุชูููุฉ/Stopped</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-i18n="additionalInfo">ูุนูููุงุช ุฅุถุงููุฉ</label>
                            <input type="text" id="editAdditionalInfo" class="form-input" placeholder="ููุงุญุธุงุช ุฅุถุงููุฉ" data-i18n-ph="additionalNotes">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ุชุณุฌูู ุงูุชุญุฏูุซ</label>
                            <p style="color: #666; font-size: 0.95rem; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                                <i class="fas fa-info-circle"></i>
                                <span data-i18n="updateNote">ุณูุชู ุชุณุฌูู ุชุงุฑูุฎ ูููุช ุงูุชุญุฏูุซ ุชููุงุฆูุงู ูุน ุงุณู ุงููุณุชุฎุฏู ุงูุฐู ูุงู ุจุงูุชุญุฏูุซ.</span>
                            </p>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i>
                        <span data-i18n="saveChanges">ุญูุธ ุงูุชุนุฏููุงุช</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyACA66gHN4i3fSKlon4hHx6_izNGKDdqWY",
            authDomain: "syst-petro.firebaseapp.com",
            databaseURL: "https://syst-petro-default-rtdb.firebaseio.com",
            projectId: "syst-petro",
            storageBucket: "syst-petro.firebasestorage.app",
            messagingSenderId: "163734828682",
            appId: "1:163734828682:web:9cec04f1d7a34da56e1f73"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Translation Object - ูุงูู ุงูุชุฑุฌูุฉ
        const translations = {
            ar: {
                // Authentication
                login: "ุชุณุฌูู ุงูุฏุฎูู",
                register: "ุชุณุฌูู ูุดุฑู ุฌุฏูุฏ",
                username: "ุงุณู ุงููุณุชุฎุฏู",
                password: "ูููุฉ ุงููุฑูุฑ",
                newPassword: "ูููุฉ ูุฑูุฑ ุฌุฏูุฏุฉ",
                currentPassword: "ูููุฉ ุงููุฑูุฑ ุงูุญุงููุฉ",
                logout: "ุชุณุฌูู ุงูุฎุฑูุฌ",
                loginBtn: "ุฏุฎูู ุฅูู ุงููุธุงู",
                registerBtn: "ุชุณุฌูู ุงููุดุฑู ุงูุฌุฏูุฏ",
                
                // Project & Area
                project: "ุงููุดุฑูุน",
                area: "ุงูููุทูุฉ",
                selectArea: "ุงุฎุชุฑ ุงูููุทูุฉ",
                selectProject: "ุงุฎุชุฑ ุงููุดุฑูุน",
                
                // Dashboard Navigation
                addVehicle: "ุฅุถุงูุฉ ูุฑูุจุฉ ุฌุฏูุฏุฉ",
                addVehicleDesc: "ุฅุฏุฎุงู ุจูุงูุงุช ูุฑูุจุฉ ุฌุฏูุฏุฉ ูุฏููุงู",
                uploadExcel: "ุฑูุน ููู ุฅูุณู",
                uploadExcelDesc: "ุฑูุน ููู ุฅูุณู ูุญุชูู ุนูู ุจูุงูุงุช ูุฑูุจุงุช",
                viewRecords: "ุนุฑุถ ุฌููุน ุงูุณุฌูุงุช",
                viewRecordsDesc: "ุนุฑุถ ูุชุนุฏูู ุณุฌูุงุช ุงููุฑูุจุงุช",
                adminPanel: "ููุญุฉ ุชุญูู ุงููุณุคูู",
                adminPanelDesc: "ุฅุฏุงุฑุฉ ุงููุดุฑููู ูุงูุตูุงุญูุงุช",
                updateProfile: "ุงูููู ุงูุดุฎุตู",
                updateProfileDesc: "ุชุญุฏูุซ ุจูุงูุงุช ุงูุญุณุงุจ ุงูุดุฎุตู",
                vehicleStatus: "ุญุงูุฉ ุงููุฑูุจุฉ",
                vehicleStatusDesc: "ุชุญุฏูุซ ุญุงูุฉ ุงููุฑูุจุฉ (ุชุนูู/ูุชูููุฉ)",
                chipRequest: "ุทูุจ ุดุฑูุญุฉ",
                chipRequestDesc: "ุทูุจ ุดุฑูุญุฉ ุฌุฏูุฏุฉ ุฃู ุงุณุชุจุฏุงู ุชุงููุฉ",
                
                // Vehicle Entry
                vehicleEntry: "ุฅุฏุฎุงู ุจูุงูุงุช ูุฑูุจุฉ ุฌุฏูุฏุฉ",
                plateNumber: "ุฑูู ุงูููุญุฉ",
                previousProject: "ุงููุดุฑูุน ุงูุณุงุจู",
                currentProject: "ุงููุดุฑูุน ุงูุญุงูู",
                additionalInfo: "ูุนูููุงุช ุฅุถุงููุฉ",
                saveVehicle: "ุญูุธ ุจูุงูุงุช ุงููุฑูุจุฉ",
                
                // Excel Upload
                dropFile: "ุงุณุญุจ ูุฃููุช ููู ุฅูุณู ููุง",
                clickToUpload: "ุฃู ุงููุฑ ูุงุฎุชูุงุฑ ุงูููู ูู ุงูุฌูุงุฒ",
                excelFormat: "ูุฌุจ ุฃู ูุญุชูู ุงูููู ุนูู ุงูุฃุนูุฏุฉ ุงูุชุงููุฉ:<br><strong>ุฑูู ุงูููุญุฉ</strong>ุ <strong>ุงููุดุฑูุน ุงูุณุงุจู</strong>ุ <strong>ุงููุดุฑูุน ุงูุญุงูู</strong>ุ <strong>ุงูููุทูุฉ</strong>ุ <strong>ุญุงูุฉ ุงููุฑูุจุฉ</strong>",
                previewData: "ูุนุงููุฉ ุงูุจูุงูุงุช",
                uploadData: "ุฑูุน ุงูุจูุงูุงุช ุฅูู ุงููุธุงู",
                updateData: "ุชุญุฏูุซ ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ",
                downloadTemplate: "ุชุญููู ูุงูุจ Excel",
                templateDescription: "ูู ุจุชุญููู ุงููุงูุจ ูููุฆู ุจุงูุจูุงูุงุช ุซู ุงุฑูุนู ูููุธุงู",
                downloadTemplateBtn: "ุชุญููู ูุงูุจ Excel",
                downloadWithData: "ุชุญููู ูุน ุงูุจูุงูุงุช ุงูุญุงููุฉ",
                action: "ุงูุฅุฌุฑุงุก",
                newEntry: "ุฅุฏุฎุงู ุฌุฏูุฏ",
                updateExisting: "ุชุญุฏูุซ ููุฌูุฏ",
                noVehicle: "ูุง ููุฌุฏ",
                downloadRecords: "ุชุญููู ุงูุณุฌูุงุช ูููู Excel",
                
                // Vehicle Status
                updateVehicleStatus: "ุชุญุฏูุซ ุญุงูุฉ ุงููุฑูุจุฉ",
                vehicleStatus: "ุญุงูุฉ ุงููุฑูุจุฉ",
                selectStatus: "ุงุฎุชุฑ ุงูุญุงูุฉ",
                working: "ุชุนูู",
                stopped: "ูุชูููุฉ",
                statusNotes: "ููุงุญุธุงุช ุงูุญุงูุฉ",
                enterStatusNotes: "ุฃุฏุฎู ููุงุญุธุงุช ุนู ุญุงูุฉ ุงููุฑูุจุฉ...",
                updateStatus: "ุชุญุฏูุซ ุญุงูุฉ ุงููุฑูุจุฉ",
                recentStatusUpdates: "ุขุฎุฑ ุชุญุฏูุซุงุช ุงูุญุงูุฉ",
                enterPlateNumber: "ุฃุฏุฎู ุฑูู ุงูููุญุฉ",
                updateDate: "ุชุงุฑูุฎ ุงูุชุญุฏูุซ",
                allStatuses: "ุฌููุน ุงูุญุงูุงุช",
                
                // Chip Request
                chipRequest: "ุทูุจ ุดุฑูุญุฉ ูููุฑูุจุฉ",
                requestType: "ููุน ุงูุทูุจ",
                selectRequestType: "ุงุฎุชุฑ ููุน ุงูุทูุจ",
                newChip: "ุดุฑูุญุฉ ุฌุฏูุฏุฉ",
                damagedChip: "ุดุฑูุญุฉ ุชุงููุฉ",
                chipReplacement: "ุงุณุชุจุฏุงู ุดุฑูุญุฉ",
                currentChipNumber: "ุฑูู ุงูุดุฑูุญุฉ ุงูุญุงูู",
                enterCurrentChip: "ุฃุฏุฎู ุฑูู ุงูุดุฑูุญุฉ ุงูุญุงูู",
                requestNotes: "ููุงุญุธุงุช ุงูุทูุจ",
                enterRequestNotes: "ุฃุฏุฎู ููุงุญุธุงุช ุฅุถุงููุฉ ุนู ุงูุทูุจ...",
                urgentRequest: "ุทูุจ ุนุงุฌู",
                urgentRequestLabel: "ูุฐุง ุงูุทูุจ ุนุงุฌู",
                submitRequest: "ุฅุฑุณุงู ุทูุจ ุงูุดุฑูุญุฉ",
                recentChipRequests: "ุทูุจุงุช ุงูุดุฑูุญุฉ ุงูุฃุฎูุฑุฉ",
                requestedBy: "ููุฏู ุงูุทูุจ",
                requestDate: "ุชุงุฑูุฎ ุงูุทูุจ",
                requestStatus: "ุญุงูุฉ ุงูุทูุจ",
                enterVehiclePlate: "ุฃุฏุฎู ุฑูู ููุญุฉ ุงููุฑูุจุฉ",
                yes: "ูุนู",
                no: "ูุง",
                
                // Records
                vehicleRecords: "ุณุฌูุงุช ุงููุฑูุจุงุช",
                filterBy: "ุชุตููุฉ ุญุณุจ:",
                allAreas: "ุฌููุน ุงูููุงุทู",
                filterByProject: "ุชุตููุฉ ุจุงููุดุฑูุน:",
                allProjects: "ุฌููุน ุงููุดุงุฑูุน",
                filterByStatus: "ุชุตููุฉ ุจุงูุญุงูุฉ:",
                filterByUrgent: "ุทูุจุงุช ุนุงุฌูุฉ ููุท:",
                all: "ุงููู",
                searchPlate: "ุจุญุซ ุจุฑูู ุงูููุญุฉ:",
                lastUpdate: "ุขุฎุฑ ุชุญุฏูุซ",
                updatedBy: "ูุญุฏุซ ุจูุงุณุทุฉ",
                actions: "ุงูุฅุฌุฑุงุกุงุช",
                
                // Actions
                edit: "ุชุนุฏูู",
                delete: "ุญุฐู",
                approve: "ููุงููุฉ",
                view: "ุนุฑุถ",
                update: "ุชุญุฏูุซ",
                
                // Admin Section
                pendingApprovals: "ุทูุจุงุช ุงูุชุณุฌูู ููุฏ ุงูุงูุชุธุงุฑ",
                allUsers: "ุฌููุน ุงููุณุชุฎุฏููู",
                status: "ุงูุญุงูุฉ",
                active: "ูุดุท",
                pending: "ููุฏ ุงูุงูุชุธุงุฑ",
                approved: "ูุนุชูุฏุฉ",
                rejected: "ูุฑููุถุฉ",
                completed: "ููุชููุฉ",
                registerDate: "ุชุงุฑูุฎ ุงูุชุณุฌูู",
                lastLogin: "ุขุฎุฑ ุฏุฎูู",
                userVehicleData: "ุจูุงูุงุช ุงููุฑูุจุงุช ูููุณุชุฎุฏููู",
                filterByUser: "ุชุตููุฉ ุจุงููุณุชุฎุฏู:",
                filterByDate: "ุชุตููุฉ ุจุงูุชุงุฑูุฎ:",
                updateHistory: "ุณุฌู ุงูุชุญุฏูุซุงุช",
                downloadAllData: "ุชุญููู ุฌููุน ุงูุจูุงูุงุช",
                downloadUsersData: "ุชุญููู ุจูุงูุงุช ุงููุณุชุฎุฏููู",
                downloadChipRequests: "ุชุญููู ุทูุจุงุช ุงูุดุฑุงุฆุญ",
                downloadUserData: "ุชุญููู ุจูุงูุงุช ุงููุณุชุฎุฏู ุงููุญุฏุฏ",
                downloadFilteredData: "ุชุญููู ุงูุจูุงูุงุช ุงููุตูุงุฉ",
                chipRequestsManagement: "ุฅุฏุงุฑุฉ ุทูุจุงุช ุงูุดุฑุงุฆุญ",
                chipRequestsCount: "ุนุฏุฏ ุงูุทูุจุงุช",
                
                // Edit Modal
                editVehicle: "ุชุนุฏูู ุจูุงูุงุช ุงููุฑูุจุฉ",
                saveChanges: "ุญูุธ ุงูุชุนุฏููุงุช",
                updateNote: "ุณูุชู ุชุณุฌูู ุชุงุฑูุฎ ูููุช ุงูุชุญุฏูุซ ุชููุงุฆูุงู ูุน ุงุณู ุงููุณุชุฎุฏู ุงูุฐู ูุงู ุจุงูุชุญุฏูุซ.",
                
                // System
                systemTitle: "ูุธุงู ุชุญุฏูุซ ุจูุงูุงุช ุงููููุฏ ูุงููุฑูุจุงุช",
                systemSubtitle: "ูุธุงู ุชุญุฏูุซ ุจูุงูุงุช ุงููููุฏ ูุงููุฑูุจุงุช",
                admin: "ูุณุคูู",
                supervisor: "ูุดุฑู",
                welcome: "ูุฑุญุจุง",
                
                // Messages
                vehicleAdded: "ุชู ุฅุถุงูุฉ ุงููุฑูุจุฉ ุจูุฌุงุญ",
                vehicleUpdated: "ุชู ุชุญุฏูุซ ุงููุฑูุจุฉ ุจูุฌุงุญ",
                vehicleDeleted: "ุชู ุญุฐู ุงููุฑูุจุฉ ุจูุฌุงุญ",
                userApproved: "ุชูุช ุงูููุงููุฉ ุนูู ุงููุณุชุฎุฏู",
                userDeleted: "ุชู ุญุฐู ุงููุณุชุฎุฏู",
                profileUpdated: "ุชู ุชุญุฏูุซ ุงูููู ุงูุดุฎุตู",
                loginSuccess: "ุชู ุชุณุฌูู ุงูุฏุฎูู ุจูุฌุงุญ",
                registerSuccess: "ุชู ุงูุชุณุฌูู ุจูุฌุงุญุ ุงูุชุธุฑ ููุงููุฉ ุงููุณุคูู",
                excelUploaded: "ุชู ุฑูุน ุงูููู ุจูุฌุงุญ",
                confirmDelete: "ูู ุฃูุช ูุชุฃูุฏ ูู ุงูุญุฐูุ",
                updateProfileBtn: "ุชุญุฏูุซ ุจูุงูุงุช ุงูุญุณุงุจ",
                updateSuccess: "ุชู ุงูุชุญุฏูุซ ุจูุฌุงุญ",
                excelDataUploaded: "ุชู ุฑูุน ุจูุงูุงุช ุงูุฅูุณู ุจูุฌุงุญ",
                excelDataUpdated: "ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงูุฅูุณู ุจูุฌุงุญ",
                noExcelData: "ูู ูุชู ุงูุนุซูุฑ ุนูู ุจูุงูุงุช ูู ููู ุงูุฅูุณู",
                invalidExcelFormat: "ุชูุณูู ููู ุงูุฅูุณู ุบูุฑ ุตุญูุญ",
                filterResults: "ูุชุงุฆุฌ ุงูุชุตููุฉ",
                clearFilter: "ูุณุญ ุงูุชุตููุฉ",
                deactivateUser: "ุชุนุทูู ุงููุณุชุฎุฏู",
                activateUser: "ุชูุนูู ุงููุณุชุฎุฏู",
                lastUpdateTime: "ููุช ุงูุชุญุฏูุซ",
                plateArabicWarning: "ููููุน ุงุณุชุฎุฏุงู ุงูุญุฑูู ุงูุนุฑุจูุฉ ูู ุฑูู ุงูููุญุฉ",
                plateLowercaseWarning: "ูุฌุจ ุฃู ุชููู ุงูุญุฑูู ุงูุฅูุฌููุฒูุฉ ูุจุชู (CAPITAL) ููุท",
                statusUpdated: "ุชู ุชุญุฏูุซ ุญุงูุฉ ุงููุฑูุจุฉ ุจูุฌุงุญ",
                chipRequestSubmitted: "ุชู ุฅุฑุณุงู ุทูุจ ุงูุดุฑูุญุฉ ุจูุฌุงุญ",
                chipRequestUpdated: "ุชู ุชุญุฏูุซ ุญุงูุฉ ุทูุจ ุงูุดุฑูุญุฉ",
                
                // Bulk Update
                bulkUpdate: "ุชุญุฏูุซ ุฌูุงุนู ูููุฑูุจุงุช",
                updateOption: "ุฎูุงุฑ ุงูุชุญุฏูุซ:",
                allVehicles: "ุงููู",
                allVehiclesDesc: "ุชุญุฏูุซ ุฌููุน ุงููุฑูุจุงุช",
                workingOnly: "ุงูุชู ุชุนูู ููุท",
                workingOnlyDesc: "ุชุญุฏูุซ ุงููุฑูุจุงุช ุงูุชู ุญุงูุฉูุง \"ุชุนูู\"",
                stoppedOnly: "ุงููุชูููุฉ ููุท",
                stoppedOnlyDesc: "ุชุญุฏูุซ ุงููุฑูุจุงุช ุงูุชู ุญุงูุฉูุง \"ูุชูููุฉ\"",
                manualSelect: "ุงููุญุฏุฏุฉ ูุฏููุงู",
                manualSelectDesc: "ุชุญุฏูุฏ ูุฑูุจุงุช ูุญุฏุฏุฉ ูู ุงูุฌุฏูู",
                newStatus: "ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ:",
                bulkNotes: "ููุงุญุธุงุช ุงูุชุญุฏูุซ:",
                enterBulkNotes: "ุฃุฏุฎู ููุงุญุธุงุช ุนุงูุฉ ููุชุญุฏูุซ...",
                vehicles: "ูุฑูุจุฉ",
                smartUpdate: "ุณูุชู ุชุญุฏูุซ ููุท ุงููุฑูุจุงุช ุงูุชู ุชุญุชุงุฌ ููุชุบููุฑ",
                updateSelected: "ุชุญุฏูุซ ุงููุฑูุจุงุช ุงููุญุฏุฏุฉ",
                needsUpdate: "ูุญุชุงุฌ ุชุญุฏูุซุ",
                
                // General
                add: "ุฅุถุงูุฉ",
                enterUsername: "ุฃุฏุฎู ุงุณู ุงููุณุชุฎุฏู",
                enterPassword: "ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ",
                chooseUsername: "ุงุฎุชุฑ ุงุณู ูุณุชุฎุฏู ูุฑูุฏ",
                strongPassword: "ูููุฉ ูุฑูุฑ ูููุฉ",
                searchProject: "ุงุจุญุซ ุนู ุงููุดุฑูุน...",
                addCustomProject: "ุฃุถู ูุดุฑูุน ุฌุฏูุฏ ูุฏููุงู...",
                addCustomArea: "ุฃุถู ููุทูุฉ ุฌุฏูุฏุฉ ูุฏููุงู...",
                plateExample: "ูุซุงู: ABC 1234",
                searchPreviousProject: "ุงุจุญุซ ุนู ุงููุดุฑูุน ุงูุณุงุจู...",
                searchCurrentProject: "ุงุจุญุซ ุนู ุงููุดุฑูุน ุงูุญุงูู...",
                additionalNotes: "ููุงุญุธุงุช ุฅุถุงููุฉ ุนู ุงููุฑูุจุฉ",
                leaveEmpty: "ุงุชุฑูู ูุงุฑุบุงู ุฅุฐุง ูู ุชุฑุฏ ุงูุชุบููุฑ",
                enterCurrentPassword: "ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ ุงูุญุงููุฉ ููุชุฃููุฏ",
                searchPlateNumber: "ุงุจุญุซ ุจุฑูู ุงูููุญุฉ..."
            },
            en: {
                // Authentication
                login: "Login",
                register: "Register New Supervisor",
                username: "Username",
                password: "Password",
                newPassword: "New Password",
                currentPassword: "Current Password",
                logout: "Logout",
                loginBtn: "Login to System",
                registerBtn: "Register New Supervisor",
                
                // Project & Area
                project: "Project",
                area: "Area",
                selectArea: "Select Area",
                selectProject: "Select Project",
                
                // Dashboard Navigation
                addVehicle: "Add New Vehicle",
                addVehicleDesc: "Manually enter new vehicle data",
                uploadExcel: "Upload Excel File",
                uploadExcelDesc: "Upload Excel file containing vehicle data",
                viewRecords: "View All Records",
                viewRecordsDesc: "View and modify vehicle records",
                adminPanel: "Admin Control Panel",
                adminPanelDesc: "Manage supervisors and permissions",
                updateProfile: "Profile Settings",
                updateProfileDesc: "Update account information",
                vehicleStatus: "Vehicle Status",
                vehicleStatusDesc: "Update vehicle status (Working/Stopped)",
                chipRequest: "Chip Request",
                chipRequestDesc: "Request new chip or replace damaged one",
                
                // Vehicle Entry
                vehicleEntry: "New Vehicle Entry",
                plateNumber: "Plate Number",
                previousProject: "Previous Project",
                currentProject: "Current Project",
                additionalInfo: "Additional Information",
                saveVehicle: "Save Vehicle Data",
                
                // Excel Upload
                dropFile: "Drag & Drop Excel File Here",
                clickToUpload: "Or click to select file from device",
                excelFormat: "File must contain these columns:<br><strong>Plate Number</strong>, <strong>Previous Project</strong>, <strong>Current Project</strong>, <strong>Area</strong>, <strong>Vehicle Status</strong>",
                previewData: "Preview Data",
                uploadData: "Upload Data to System",
                updateData: "Update Existing Data",
                downloadTemplate: "Download Excel Template",
                templateDescription: "Download template, fill with data, then upload to system",
                downloadTemplateBtn: "Download Excel Template",
                downloadWithData: "Download with Current Data",
                action: "Action",
                newEntry: "New Entry",
                updateExisting: "Update Existing",
                noVehicle: "No Vehicle",
                downloadRecords: "Download Records as Excel",
                
                // Vehicle Status
                updateVehicleStatus: "Update Vehicle Status",
                vehicleStatus: "Vehicle Status",
                selectStatus: "Select Status",
                working: "Working",
                stopped: "Stopped",
                statusNotes: "Status Notes",
                enterStatusNotes: "Enter notes about vehicle status...",
                updateStatus: "Update Vehicle Status",
                recentStatusUpdates: "Recent Status Updates",
                enterPlateNumber: "Enter plate number",
                updateDate: "Update Date",
                allStatuses: "All Statuses",
                
                // Chip Request
                chipRequest: "Vehicle Chip Request",
                requestType: "Request Type",
                selectRequestType: "Select Request Type",
                newChip: "New Chip",
                damagedChip: "Damaged Chip",
                chipReplacement: "Chip Replacement",
                currentChipNumber: "Current Chip Number",
                enterCurrentChip: "Enter current chip number",
                requestNotes: "Request Notes",
                enterRequestNotes: "Enter additional notes about request...",
                urgentRequest: "Urgent Request",
                urgentRequestLabel: "This is an urgent request",
                submitRequest: "Submit Chip Request",
                recentChipRequests: "Recent Chip Requests",
                requestedBy: "Requested By",
                requestDate: "Request Date",
                requestStatus: "Request Status",
                enterVehiclePlate: "Enter vehicle plate number",
                yes: "Yes",
                no: "No",
                
                // Records
                vehicleRecords: "Vehicle Records",
                filterBy: "Filter by:",
                allAreas: "All Areas",
                filterByProject: "Filter by Project:",
                allProjects: "All Projects",
                filterByStatus: "Filter by Status:",
                filterByUrgent: "Urgent Requests Only:",
                all: "All",
                searchPlate: "Search by Plate:",
                lastUpdate: "Last Update",
                updatedBy: "Updated By",
                actions: "Actions",
                
                // Actions
                edit: "Edit",
                delete: "Delete",
                approve: "Approve",
                view: "View",
                update: "Update",
                
                // Admin Section
                pendingApprovals: "Pending Registration Requests",
                allUsers: "All Users",
                status: "Status",
                active: "Active",
                pending: "Pending",
                approved: "Approved",
                rejected: "Rejected",
                completed: "Completed",
                registerDate: "Registration Date",
                lastLogin: "Last Login",
                userVehicleData: "User Vehicle Data",
                filterByUser: "Filter by User:",
                filterByDate: "Filter by Date:",
                updateHistory: "Update History",
                downloadAllData: "Download All Data",
                downloadUsersData: "Download Users Data",
                downloadChipRequests: "Download Chip Requests",
                downloadUserData: "Download Selected User Data",
                downloadFilteredData: "Download Filtered Data",
                chipRequestsManagement: "Chip Requests Management",
                chipRequestsCount: "Requests Count",
                
                // Edit Modal
                editVehicle: "Edit Vehicle Data",
                saveChanges: "Save Changes",
                updateNote: "Update date, time and username will be recorded automatically.",
                
                // System
                systemTitle: "Vehicle Fuel Data Update System",
                systemSubtitle: "Vehicle Fuel Data Update System",
                admin: "Admin",
                supervisor: "Supervisor",
                welcome: "Welcome",
                
                // Messages
                vehicleAdded: "Vehicle added successfully",
                vehicleUpdated: "Vehicle updated successfully",
                vehicleDeleted: "Vehicle deleted successfully",
                userApproved: "User approved successfully",
                userDeleted: "User deleted successfully",
                profileUpdated: "Profile updated successfully",
                loginSuccess: "Login successful",
                registerSuccess: "Registration successful, waiting for admin approval",
                excelUploaded: "File uploaded successfully",
                confirmDelete: "Are you sure you want to delete?",
                updateProfileBtn: "Update Account Data",
                updateSuccess: "Updated successfully",
                excelDataUploaded: "Excel data uploaded successfully",
                excelDataUpdated: "Excel data updated successfully",
                noExcelData: "No data found in Excel file",
                invalidExcelFormat: "Invalid Excel file format",
                filterResults: "Filter Results",
                clearFilter: "Clear Filter",
                deactivateUser: "Deactivate User",
                activateUser: "Activate User",
                lastUpdateTime: "Update Time",
                plateArabicWarning: "Arabic letters are not allowed in plate number",
                plateLowercaseWarning: "English letters must be CAPITAL only",
                statusUpdated: "Vehicle status updated successfully",
                chipRequestSubmitted: "Chip request submitted successfully",
                chipRequestUpdated: "Chip request status updated",
                
                // Bulk Update
                bulkUpdate: "Bulk Vehicle Update",
                updateOption: "Update Option:",
                allVehicles: "All",
                allVehiclesDesc: "Update all vehicles",
                workingOnly: "Working Only",
                workingOnlyDesc: "Update vehicles with \"Working\" status",
                stoppedOnly: "Stopped Only",
                stoppedOnlyDesc: "Update vehicles with \"Stopped\" status",
                manualSelect: "Manual Selection",
                manualSelectDesc: "Select specific vehicles from table",
                newStatus: "New Status:",
                bulkNotes: "Update Notes:",
                enterBulkNotes: "Enter general update notes...",
                vehicles: "vehicles",
                smartUpdate: "Only vehicles that need change will be updated",
                updateSelected: "Update Selected Vehicles",
                needsUpdate: "Needs Update?",
                
                // General
                add: "Add",
                enterUsername: "Enter username",
                enterPassword: "Enter password",
                chooseUsername: "Choose a unique username",
                strongPassword: "Strong password",
                searchProject: "Search for project...",
                addCustomProject: "Add new project manually...",
                addCustomArea: "Add new area manually...",
                plateExample: "Example: ABC 1234",
                searchPreviousProject: "Search previous project...",
                searchCurrentProject: "Search current project...",
                additionalNotes: "Additional notes about the vehicle",
                leaveEmpty: "Leave empty if you don't want to change",
                enterCurrentPassword: "Enter current password for confirmation",
                searchPlateNumber: "Search by plate number..."
            }
        };

        // ุงูููุงุทู ุจุงููุบุชูู
        let saudiAreas = {
            ar: [
                "ุงูุฑูุงุถ/Riyadh",
                "ููุฉ ุงูููุฑูุฉ/Makkah",
                "ุงููุฏููุฉ ุงููููุฑุฉ/Madinah",
                "ุงูุฏูุงู/Dammam",
                "ุงูุฎุจุฑ/Khobar",
                "ุฌุฏุฉ/Jeddah",
                "ุงูุทุงุฆู/Taif",
                "ุชุจูู/Tabuk",
                "ุญุงุฆู/Hail",
                "ุจุฑูุฏุฉ/Buraidah",
                "ุณูุงูุง/Sakaka",
                "ุฃุจูุง/Abha",
                "ุฌุงุฒุงู/Jazan",
                "ูุฌุฑุงู/Najran",
                "ุงูุจุงุญุฉ/Al Baha",
                "ุนุฑุนุฑ/Arar",
                "ุงููุฑูุงุช/Al Qurayyat",
                "ุงูุฌุจูู/Al Jubail",
                "ููุจุน/Yanbu",
                "ุฑุงุจุบ/Rabigh",
                "ุงูุฎุฑุฌ/Al Kharj",
                "ุงูุฃุญุณุงุก/Al Ahsa"
            ],
            en: [
                "ุงูุฑูุงุถ/Riyadh",
                "ููุฉ ุงูููุฑูุฉ/Makkah",
                "ุงููุฏููุฉ ุงููููุฑุฉ/Madinah",
                "ุงูุฏูุงู/Dammam",
                "ุงูุฎุจุฑ/Khobar",
                "ุฌุฏุฉ/Jeddah",
                "ุงูุทุงุฆู/Taif",
                "ุชุจูู/Tabuk",
                "ุญุงุฆู/Hail",
                "ุจุฑูุฏุฉ/Buraidah",
                "ุณูุงูุง/Sakaka",
                "ุฃุจูุง/Abha",
                "ุฌุงุฒุงู/Jazan",
                "ูุฌุฑุงู/Najran",
                "ุงูุจุงุญุฉ/Al Baha",
                "ุนุฑุนุฑ/Arar",
                "ุงููุฑูุงุช/Al Qurayyat",
                "ุงูุฌุจูู/Al Jubail",
                "ููุจุน/Yanbu",
                "ุฑุงุจุบ/Rabigh",
                "ุงูุฎุฑุฌ/Al Kharj",
                "ุงูุฃุญุณุงุก/Al Ahsa"
            ]
        };

        // ูุงุฆูุฉ ุงููุดุงุฑูุน ุจุงููุบุชูู
        let projectsList = {
            ar: [
                "ูููุงุฑุช/Kimart",
                "ุงููุฑุงุนู/Almarai",
                "ุงุฑุงููุณ/Aramex",
                "ูููุงุฑุช ุฏุจุงุจุงุช/Kimart Dabat",
                "ูููุฌุง ุฏุจุงุจุงุช/Ninja Dabat",
                "ูููุงุฑุช/Kimart",
                "ุณูุงุณู/Salasah",
                "ุงูุจุจุณู/Pepsi",
                "6 ุณุชุฑูุช/6 Street",
                "ููู/Noon",
                "ููุฏููุณ/FedEx",
                "ูููู/Mulham",
                "ูุงูู ุณุจู/Naqel Sabil",
                "ูุงูู ุฌุงู/Naqel Jaf",
                "ูุฑุณุช ูุฑุงู/First Cry",
                "ูุงูุฏ ูุงุฑู/Landmark",
                "ููู 3 ุจู ุงู/Noon 3PL",
                "ุชุฑุงูุณููุฑุจ/Transcorp",
                "ููุฏูุณ/FedEx",
                "ุงุชุง/ATA",
                "ุงูุงุฒูู/Amazon",
                "ุจูุฏุง/Panda",
                "ูุณุชูุฏุนุงุช ุงูุฒูุฑุงูู/Alzahrani Warehouses",
                "ูู ูุงุฑุช/K Mart",
                "ูุงูู/Naqel",
                "ุดูุจุง/Sheba",
                "ุฏููุง/Dina",
                "ููู/Flow",
                "ููุฑุณุชูุฑุงู/FirstCry",
                "ููุชุง/Kita",
                "ูุงุจูู/Nabco",
                "ูุงูุฏูุงุฑู/Landmark",
                "ููู-3 ุจู ุงู/Noon-3PL",
                "ุงู ููุงู/Anywhere",
                "ุณูุงุณุฉ/Salasah",
                "ุงูุฏุงูุฉ/Aldana",
                "ูุง ููุฌุฏ/No Vehicle"
            ],
            en: [
                "ูููุงุฑุช/Kimart",
                "ุงููุฑุงุนู/Almarai",
                "ุงุฑุงููุณ/Aramex",
                "ูููุงุฑุช ุฏุจุงุจุงุช/Kimart Dabat",
                "ูููุฌุง ุฏุจุงุจุงุช/Ninja Dabat",
                "ูููุงุฑุช/Kimart",
                "ุณูุงุณู/Salasah",
                "ุงูุจุจุณู/Pepsi",
                "6 ุณุชุฑูุช/6 Street",
                "ููู/Noon",
                "ููุฏููุณ/FedEx",
                "ูููู/Mulham",
                "ูุงูู ุณุจู/Naqel Sabil",
                "ูุงูู ุฌุงู/Naqel Jaf",
                "ูุฑุณุช ูุฑุงู/First Cry",
                "ูุงูุฏ ูุงุฑู/Landmark",
                "ููู 3 ุจู ุงู/Noon 3PL",
                "ุชุฑุงูุณููุฑุจ/Transcorp",
                "ููุฏูุณ/FedEx",
                "ุงุชุง/ATA",
                "ุงูุงุฒูู/Amazon",
                "ุจูุฏุง/Panda",
                "ูุณุชูุฏุนุงุช ุงูุฒูุฑุงูู/Alzahrani Warehouses",
                "ูู ูุงุฑุช/K Mart",
                "ูุงูู/Naqel",
                "ุดูุจุง/Sheba",
                "ุฏููุง/Dina",
                "ููู/Flow",
                "ููุฑุณุชูุฑุงู/FirstCry",
                "ููุชุง/Kita",
                "ูุงุจูู/Nabco",
                "ูุงูุฏูุงุฑู/Landmark",
                "ููู-3 ุจู ุงู/Noon-3PL",
                "ุงู ููุงู/Anywhere",
                "ุณูุงุณุฉ/Salasah",
                "ุงูุฏุงูุฉ/Aldana",
                "ูุง ููุฌุฏ/No Vehicle"
            ]
        };

        // Vehicle Status Options
        const vehicleStatusOptions = {
            ar: ["ุชุนูู/Working", "ูุชูููุฉ/Stopped"],
            en: ["ุชุนูู/Working", "ูุชูููุฉ/Stopped"]
        };

        // Chip Request Types
        const chipRequestTypes = {
            ar: ["ุดุฑูุญุฉ ุฌุฏูุฏุฉ/New Chip", "ุดุฑูุญุฉ ุชุงููุฉ/Damaged Chip", "ุงุณุชุจุฏุงู ุดุฑูุญุฉ/Chip Replacement"],
            en: ["ุดุฑูุญุฉ ุฌุฏูุฏุฉ/New Chip", "ุดุฑูุญุฉ ุชุงููุฉ/Damaged Chip", "ุงุณุชุจุฏุงู ุดุฑูุญุฉ/Chip Replacement"]
        };

        let currentUser = null;
        let currentLanguage = 'ar';
        let excelData = [];
        let excelOriginalData = [];
        let existingVehiclesMap = {};
        let selectedProject = '';
        let selectedArea = '';

        // Global variables for bulk update
        let bulkUpdateOption = 'all';
        let selectedVehicles = new Set();
        let allVehiclesData = [];

        // ุชููุฆุฉ ุงูุชุทุจูู
        function initApp() {
            loadAreas();
            loadProjectsLists();
            checkAuth();
            setupEventListeners();
            setupDragAndDrop();
            updateTranslations();
        }

        // ุชุญููู ุงูููุงุทู
        function loadAreas() {
            const areaSelects = ['regArea', 'vehicleArea', 'profileArea', 'editArea', 'filterArea'];
            const lang = currentLanguage;
            
            areaSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = `<option value="" data-i18n="selectArea">${translate('selectArea')}</option>`;
                    saudiAreas[lang].forEach(area => {
                        const option = document.createElement('option');
                        option.value = area;
                        option.textContent = area;
                        select.appendChild(option);
                    });
                }
            });
        }

        // ุฅุถุงูุฉ ููุทูุฉ ูุฎุตุตุฉ ูู ูููุฐุฌ ุงูุชุณุฌูู
        function addCustomArea() {
            const customAreaInput = document.getElementById('customAreaInput');
            const areaName = customAreaInput.value.trim();
            
            if (!areaName) {
                showMessage('authMessage', 'ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ุงูููุทูุฉ', 'error');
                return;
            }
            
            // ุงูุชุญูู ูู ุตูุบุฉ ุงูููุทูุฉ
            if (!areaName.includes('/')) {
                showMessage('authMessage', 'ูุฌุจ ุฅุฏุฎุงู ุงูููุทูุฉ ุจุงูุตูุบุฉ: ุนุฑุจู/ุฅูุฌููุฒู', 'error');
                return;
            }
            
            if (saudiAreas[currentLanguage].includes(areaName)) {
                showMessage('authMessage', 'ูุฐู ุงูููุทูุฉ ููุฌูุฏุฉ ุจุงููุนู', 'info');
                return;
            }
            
            saudiAreas[currentLanguage].push(areaName);
            
            // ุฅุถุงูุฉ ููุบุฉ ุงูุฃุฎุฑู ุฃูุถุงู
            const otherLang = currentLanguage === 'ar' ? 'en' : 'ar';
            saudiAreas[otherLang].push(areaName);
            
            loadAreas();
            
            const regAreaSelect = document.getElementById('regArea');
            regAreaSelect.value = areaName;
            selectedArea = areaName;
            
            customAreaInput.value = '';
            
            showMessage('authMessage', `ุชูุช ุฅุถุงูุฉ ุงูููุทูุฉ "${areaName}"`, 'success');
        }

        // ุฅุถุงูุฉ ููุทูุฉ ูุฎุตุตุฉ ูู ูููุฐุฌ ุงููุฑูุจุฉ
        function addCustomVehicleArea() {
            const customAreaInput = document.getElementById('vehicleCustomAreaInput');
            const areaName = customAreaInput.value.trim();
            
            if (!areaName) {
                showMessage('dashboardMessage', 'ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ุงูููุทูุฉ', 'error');
                return;
            }
            
            // ุงูุชุญูู ูู ุตูุบุฉ ุงูููุทูุฉ
            if (!areaName.includes('/')) {
                showMessage('dashboardMessage', 'ูุฌุจ ุฅุฏุฎุงู ุงูููุทูุฉ ุจุงูุตูุบุฉ: ุนุฑุจู/ุฅูุฌููุฒู', 'error');
                return;
            }
            
            if (saudiAreas[currentLanguage].includes(areaName)) {
                showMessage('dashboardMessage', 'ูุฐู ุงูููุทูุฉ ููุฌูุฏุฉ ุจุงููุนู', 'info');
                return;
            }
            
            saudiAreas[currentLanguage].push(areaName);
            
            // ุฅุถุงูุฉ ููุบุฉ ุงูุฃุฎุฑู ุฃูุถุงู
            const otherLang = currentLanguage === 'ar' ? 'en' : 'ar';
            saudiAreas[otherLang].push(areaName);
            
            loadAreas();
            
            const vehicleAreaSelect = document.getElementById('vehicleArea');
            vehicleAreaSelect.value = areaName;
            
            customAreaInput.value = '';
            
            showMessage('dashboardMessage', `ุชูุช ุฅุถุงูุฉ ุงูููุทูุฉ "${areaName}"`, 'success');
        }

        // ุฅุถุงูุฉ ููุทูุฉ ูุฎุตุตุฉ ูู ูููุฐุฌ ุงูุชุนุฏูู
        function addCustomEditArea() {
            const customAreaInput = document.getElementById('editCustomAreaInput');
            const areaName = customAreaInput.value.trim();
            
            if (!areaName) {
                showMessage('dashboardMessage', 'ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ุงูููุทูุฉ', 'error');
                return;
            }
            
            // ุงูุชุญูู ูู ุตูุบุฉ ุงูููุทูุฉ
            if (!areaName.includes('/')) {
                showMessage('dashboardMessage', 'ูุฌุจ ุฅุฏุฎุงู ุงูููุทูุฉ ุจุงูุตูุบุฉ: ุนุฑุจู/ุฅูุฌููุฒู', 'error');
                return;
            }
            
            if (saudiAreas[currentLanguage].includes(areaName)) {
                showMessage('dashboardMessage', 'ูุฐู ุงูููุทูุฉ ููุฌูุฏุฉ ุจุงููุนู', 'info');
                return;
            }
            
            saudiAreas[currentLanguage].push(areaName);
            
            // ุฅุถุงูุฉ ููุบุฉ ุงูุฃุฎุฑู ุฃูุถุงู
            const otherLang = currentLanguage === 'ar' ? 'en' : 'ar';
            saudiAreas[otherLang].push(areaName);
            
            loadAreas();
            
            const editAreaSelect = document.getElementById('editArea');
            editAreaSelect.value = areaName;
            
            customAreaInput.value = '';
            
            showMessage('dashboardMessage', `ุชูุช ุฅุถุงูุฉ ุงูููุทูุฉ "${areaName}"`, 'success');
        }

        // ุฅุถุงูุฉ ูุดุฑูุน ูุฎุตุต
        function addCustomProject() {
            const customProjectInput = document.getElementById('customProjectInput');
            const projectName = customProjectInput.value.trim();
            
            if (!projectName) {
                showMessage('authMessage', 'ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ุงููุดุฑูุน', 'error');
                return;
            }
            
            // ุงูุชุญูู ูู ุตูุบุฉ ุงููุดุฑูุน
            if (!projectName.includes('/')) {
                showMessage('authMessage', 'ูุฌุจ ุฅุฏุฎุงู ุงููุดุฑูุน ุจุงูุตูุบุฉ: ุนุฑุจู/ุฅูุฌููุฒู', 'error');
                return;
            }
            
            const exists = projectsList[currentLanguage].some(p => p === projectName);
            if (exists) {
                showMessage('authMessage', 'ูุฐุง ุงููุดุฑูุน ููุฌูุฏ ุจุงููุนู', 'info');
                return;
            }
            
            projectsList[currentLanguage].push(projectName);
            
            // ุฅุถุงูุฉ ููุบุฉ ุงูุฃุฎุฑู ุฃูุถุงู
            const otherLang = currentLanguage === 'ar' ? 'en' : 'ar';
            projectsList[otherLang].push(projectName);
            
            loadProjectsLists();
            
            const projectsListContainer = document.getElementById('projectsList');
            if (projectsListContainer) {
                projectsListContainer.querySelectorAll('.project-item').forEach(item => {
                    if (item.textContent.includes(projectName)) {
                        item.classList.add('selected');
                    }
                });
            }
            
            selectedProject = projectName;
            
            customProjectInput.value = '';
            
            showMessage('authMessage', `ุชูุช ุฅุถุงูุฉ ุงููุดุฑูุน "${projectName}"`, 'success');
        }

        // ุชุญููู ููุงุฆู ุงููุดุงุฑูุน
        function loadProjectsLists() {
            const projectLists = [
                'projectsList', 'prevProjectsList', 'currProjectsList', 
                'profileProjectsList', 'editPrevProjectsList', 'editCurrProjectsList'
            ];
            
            projectLists.forEach(listId => {
                const list = document.getElementById(listId);
                if (list) {
                    renderProjectsList(list, '', listId);
                }
            });
        }

        // ุนุฑุถ ูุงุฆูุฉ ุงููุดุงุฑูุน
        function renderProjectsList(container, searchTerm = '', listType = '') {
            if (!container) return;
            
            container.innerHTML = '';
            
            const lang = currentLanguage;
            let filteredProjects = projectsList[lang];
            
            if (searchTerm) {
                filteredProjects = projectsList[lang].filter(project => 
                    project.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            
            // ูุฑุฒ ุงููุดุงุฑูุน
            filteredProjects.sort((a, b) => {
                const aName = a.toLowerCase();
                const bName = b.toLowerCase();
                return aName.localeCompare(bName);
            });
            
            filteredProjects.forEach(project => {
                const item = document.createElement('div');
                item.className = 'project-item';
                
                // ุชูููุฒ ูุดุฑูุน "ูุง ููุฌุฏ"
                if (project.includes('ูุง ููุฌุฏ') || project.includes('No Vehicle')) {
                    item.style.background = '#f8f9fa';
                    item.style.fontWeight = 'bold';
                    item.style.color = '#666';
                }
                
                item.textContent = project;
                
                item.onclick = () => {
                    container.querySelectorAll('.project-item').forEach(el => {
                        el.classList.remove('selected');
                    });
                    
                    item.classList.add('selected');
                    
                    if (listType === 'projectsList') {
                        selectedProject = project;
                    } else if (listType === 'prevProjectsList') {
                        document.getElementById('previousProject').value = project;
                    } else if (listType === 'currProjectsList') {
                        document.getElementById('currentProject').value = project;
                    } else if (listType === 'profileProjectsList') {
                        document.getElementById('profileProject').value = project;
                    } else if (listType === 'editPrevProjectsList') {
                        document.getElementById('editPrevProject').value = project;
                    } else if (listType === 'editCurrProjectsList') {
                        document.getElementById('editCurrProject').value = project;
                    }
                };
                
                container.appendChild(item);
            });
            
            if (filteredProjects.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'project-item';
                noResults.innerHTML = `<span style="color: #666;">ูุง ุชูุฌุฏ ูุชุงุฆุฌ - ููููู ุฅุถุงูุฉ ูุดุฑูุน ุฌุฏูุฏ</span>`;
                container.appendChild(noResults);
            }
        }

        // ูุธุงุฆู ุงูุจุญุซ
        function filterProjects() {
            const searchTerm = document.getElementById('projectSearch').value;
            const list = document.getElementById('projectsList');
            renderProjectsList(list, searchTerm, 'projectsList');
        }

        function filterPrevProjects() {
            const searchTerm = document.getElementById('prevProjectSearch').value;
            const list = document.getElementById('prevProjectsList');
            renderProjectsList(list, searchTerm, 'prevProjectsList');
        }

        function filterCurrProjects() {
            const searchTerm = document.getElementById('currProjectSearch').value;
            const list = document.getElementById('currProjectsList');
            renderProjectsList(list, searchTerm, 'currProjectsList');
        }

        function filterProfileProjects() {
            const searchTerm = document.getElementById('profileProjectSearch').value;
            const list = document.getElementById('profileProjectsList');
            renderProjectsList(list, searchTerm, 'profileProjectsList');
        }

        function filterEditPrevProjects() {
            const searchTerm = document.getElementById('editPrevProjectSearch').value;
            const list = document.getElementById('editPrevProjectsList');
            renderProjectsList(list, searchTerm, 'editPrevProjectsList');
        }

        function filterEditCurrProjects() {
            const searchTerm = document.getElementById('editCurrProjectSearch').value;
            const list = document.getElementById('editCurrProjectsList');
            renderProjectsList(list, searchTerm, 'editCurrProjectsList');
        }

        // ุงูุชุญูู ูู ุฑูู ุงูููุญุฉ ุฃุซูุงุก ุงููุชุงุจุฉ
        function validatePlateNumberInput(input) {
            const plateNumber = input.value;
            const warningDiv = document.getElementById('plateWarning');
            
            // ุงูุชุญูู ุฅุฐุง ูุงู ููุงู ุฃุญุฑู ุนุฑุจูุฉ
            const arabicRegex = /[\u0600-\u06FF]/;
            if (arabicRegex.test(plateNumber)) {
                warningDiv.textContent = translate('plateArabicWarning');
                warningDiv.style.display = 'block';
                return false;
            }
            
            // ุงูุชุญูู ุฅุฐุง ูุงูุช ุงูุญุฑูู ุงูุฅูุฌููุฒูุฉ ุตุบูุฑุฉ
            const lowercaseEnglish = /[a-z]/;
            if (lowercaseEnglish.test(plateNumber)) {
                warningDiv.textContent = translate('plateLowercaseWarning');
                warningDiv.style.display = 'block';
                return false;
            }
            
            warningDiv.style.display = 'none';
            return true;
        }

        // ุงูุชุญูู ูู ุฑูู ุงูููุญุฉ ูู ูููุฐุฌ ุงูุชุนุฏูู
        function validateEditPlateNumberInput(input) {
            const plateNumber = input.value;
            const warningDiv = document.getElementById('editPlateWarning');
            
            // ุงูุชุญูู ุฅุฐุง ูุงู ููุงู ุฃุญุฑู ุนุฑุจูุฉ
            const arabicRegex = /[\u0600-\u06FF]/;
            if (arabicRegex.test(plateNumber)) {
                warningDiv.textContent = translate('plateArabicWarning');
                warningDiv.style.display = 'block';
                return false;
            }
            
            // ุงูุชุญูู ุฅุฐุง ูุงูุช ุงูุญุฑูู ุงูุฅูุฌููุฒูุฉ ุตุบูุฑุฉ
            const lowercaseEnglish = /[a-z]/;
            if (lowercaseEnglish.test(plateNumber)) {
                warningDiv.textContent = translate('plateLowercaseWarning');
                warningDiv.style.display = 'block';
                return false;
            }
            
            warningDiv.style.display = 'none';
            return true;
        }

        // ุงูุชุญูู ุงูููุงุฆู ูู ุฑูู ุงูููุญุฉ ูุจู ุงูุฅุฑุณุงู
        function validatePlateNumber(plateNumber) {
            // ุงูุชุญูู ุฅุฐุง ูุงู ููุงู ุฃุญุฑู ุนุฑุจูุฉ
            const arabicRegex = /[\u0600-\u06FF]/;
            if (arabicRegex.test(plateNumber)) {
                showMessage('dashboardMessage', translate('plateArabicWarning'), 'error');
                return false;
            }
            
            // ุงูุชุญูู ุฅุฐุง ูุงูุช ุงูุญุฑูู ุงูุฅูุฌููุฒูุฉ ุตุบูุฑุฉ
            const lowercaseEnglish = /[a-z]/;
            if (lowercaseEnglish.test(plateNumber)) {
                showMessage('dashboardMessage', translate('plateLowercaseWarning'), 'error');
                return false;
            }
            
            return true;
        }

        // ุชุบููุฑ ุงููุบุฉ
        function changeLanguage(lang) {
            currentLanguage = lang;
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-lang') === lang) {
                    btn.classList.add('active');
                }
            });
            
            loadAreas();
            loadProjectsLists();
            updateTranslations();
            
            if (currentUser) {
                updateUserInfo();
                loadVehicleRecords();
                loadVehicleStatusHistory();
                loadChipRequests();
                if (currentUser.role === 'admin') {
                    loadPendingApprovals();
                    loadAllUsers();
                    loadUserVehicleData();
                    loadAdminChipRequests();
                }
                if (document.getElementById('vehicleStatusSection').classList.contains('active')) {
                    loadVehiclesForBulkUpdate();
                }
            }
        }

        // ุชุฑุฌูุฉ ุงููุต
        function translate(key) {
            return translations[currentLanguage][key] || key;
        }

        // ุชุญุฏูุซ ุฌููุน ุงูุนูุงุตุฑ ุงููุชุฑุฌูุฉ
        function updateTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                const translation = translate(key);
                
                if (element.tagName === 'INPUT' || element.tagName === 'SELECT') {
                    if (element.hasAttribute('data-i18n-ph')) {
                        const phKey = element.getAttribute('data-i18n-ph');
                        element.placeholder = translate(phKey);
                    }
                    if (element.tagName === 'SELECT') {
                        Array.from(element.options).forEach(option => {
                            if (option.hasAttribute('data-i18n')) {
                                option.textContent = translate(option.getAttribute('data-i18n'));
                            }
                        });
                    }
                } else {
                    element.textContent = translation;
                }
            });
        }

        // ุนุฑุถ ูููุฐุฌ ุงููุตุงุฏูุฉ
        function showAuthForm(form) {
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.auth-form').forEach(formEl => {
                formEl.classList.remove('active');
            });
            
            event.target.classList.add('active');
            document.getElementById(form + 'Form').classList.add('active');
        }

        // ุฅุนุฏุงุฏ ูุณุชูุนู ุงูุฃุญุฏุงุซ
        function setupEventListeners() {
            // ูููุฐุฌ ุชุณุฌูู ุงูุฏุฎูู
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;
                
                if ((username === 'ูููุฏุง' || username === 'Honda') && password === '0906212775') {
                    currentUser = {
                        username: currentLanguage === 'ar' ? 'ูููุฏุง' : 'Honda',
                        role: 'admin',
                        project: currentLanguage === 'ar' ? 'ูุฏูุฑ ุงููุธุงู' : 'System Administrator',
                        area: currentLanguage === 'ar' ? 'ุฌููุน ุงูููุงุทู' : 'All Areas',
                        status: 'active',
                        password: '0906212775'
                    };
                    showMessage('authMessage', translate('loginSuccess'), 'success');
                    setTimeout(() => {
                        showDashboard();
                        showMessage('dashboardMessage', translate('loginSuccess'), 'success');
                    }, 1000);
                    return;
                }
                
                const usersRef = database.ref('users');
                const snapshot = await usersRef.once('value');
                const users = snapshot.val();
                
                if (users) {
                    const userKey = Object.keys(users).find(key => 
                        users[key].username === username && 
                        users[key].password === password
                    );
                    
                    if (userKey) {
                        const user = users[userKey];
                        if (user.status === 'active') {
                            await database.ref('users/' + userKey).update({
                                lastLogin: new Date().toISOString()
                            });
                            
                            currentUser = { ...user, id: userKey };
                            showDashboard();
                            showMessage('dashboardMessage', translate('loginSuccess'), 'success');
                        } else {
                            showMessage('authMessage', 'ุงูุญุณุงุจ ููุฏ ุงูุงูุชุธุงุฑ ููููุงููุฉ', 'error');
                        }
                    } else {
                        showMessage('authMessage', 'ุงุณู ุงููุณุชุฎุฏู ุฃู ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ', 'error');
                    }
                } else {
                    showMessage('authMessage', 'ูุง ููุฌุฏ ูุณุชุฎุฏููู ูุณุฌููู', 'error');
                }
            });

            // ูููุฐุฌ ุงูุชุณุฌูู
            document.getElementById('registerForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const projectValue = selectedProject || document.getElementById('customProjectInput').value;
                const areaValue = document.getElementById('regArea').value;
                
                if (!projectValue) {
                    showMessage('authMessage', 'ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุฃู ุฅุถุงูุฉ ูุดุฑูุน', 'error');
                    return;
                }
                
                if (!areaValue) {
                    showMessage('authMessage', 'ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงูููุทูุฉ', 'error');
                    return;
                }
                
                const user = {
                    username: document.getElementById('regUsername').value,
                    password: document.getElementById('regPassword').value,
                    project: projectValue,
                    area: areaValue,
                    role: 'supervisor',
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    lastLogin: null
                };
                
                const usersRef = database.ref('users');
                await usersRef.push(user);
                
                showMessage('authMessage', translate('registerSuccess'), 'success');
                document.getElementById('registerForm').reset();
                selectedProject = '';
                
                const projectsListEl = document.getElementById('projectsList');
                if (projectsListEl) {
                    projectsListEl.querySelectorAll('.project-item').forEach(el => {
                        el.classList.remove('selected');
                    });
                }
                showAuthForm('login');
            });

            // ูููุฐุฌ ุงููุฑูุจุฉ
            document.getElementById('vehicleForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const plateNumber = document.getElementById('plateNumber').value;
                if (!validatePlateNumber(plateNumber)) {
                    return;
                }
                
                const prevProject = document.getElementById('previousProject').value || 'ูุง ููุฌุฏ/No Vehicle';
                const currProject = document.getElementById('currentProject').value || 'ูุง ููุฌุฏ/No Vehicle';
                const area = document.getElementById('vehicleArea').value;
                
                if (!area) {
                    showMessage('dashboardMessage', 'ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงูููุทูุฉ', 'error');
                    return;
                }
                
                const now = new Date();
                const vehicle = {
                    plateNumber: plateNumber,
                    area: area,
                    previousProject: prevProject,
                    currentProject: currProject,
                    vehicleStatus: 'working',
                    additionalInfo: document.getElementById('additionalInfo').value || '',
                    createdBy: currentUser.username,
                    createdAt: now.toISOString(),
                    lastUpdatedBy: currentUser.username,
                    lastUpdatedAt: now.toISOString(),
                    updateHistory: [{
                        updatedBy: currentUser.username,
                        updatedAt: now.toISOString(),
                        changes: "Initial creation"
                    }]
                };
                
                const vehiclesRef = database.ref('vehicles');
                await vehiclesRef.push(vehicle);
                
                showMessage('dashboardMessage', translate('vehicleAdded'), 'success');
                document.getElementById('vehicleForm').reset();
                
                ['prevProjectsList', 'currProjectsList'].forEach(listId => {
                    const list = document.getElementById(listId);
                    if (list) {
                        list.querySelectorAll('.project-item').forEach(el => {
                            el.classList.remove('selected');
                        });
                    }
                });
                document.getElementById('previousProject').value = '';
                document.getElementById('currentProject').value = '';
                loadVehicleRecords();
                
                // ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏููู ุชููุงุฆูุงู ูููุณุคูู
                if (currentUser.role === 'admin') {
                    loadUserVehicleData();
                }
            });

            // ูููุฐุฌ ุญุงูุฉ ุงููุฑูุจุฉ
            document.getElementById('vehicleStatusForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const plateNumber = document.getElementById('statusPlateNumber').value;
                const vehicleStatus = document.getElementById('vehicleStatus').value;
                const statusNotes = document.getElementById('statusNotes').value;
                
                if (!plateNumber) {
                    showMessage('dashboardMessage', 'ุงูุฑุฌุงุก ุฅุฏุฎุงู ุฑูู ุงูููุญุฉ', 'error');
                    return;
                }
                
                if (!vehicleStatus) {
                    showMessage('dashboardMessage', 'ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุญุงูุฉ ุงููุฑูุจุฉ', 'error');
                    return;
                }
                
                // ุงูุจุญุซ ุนู ุงููุฑูุจุฉ
                const vehiclesRef = database.ref('vehicles');
                const snapshot = await vehiclesRef.orderByChild('plateNumber').equalTo(plateNumber).once('value');
                const vehicles = snapshot.val();
                
                if (!vehicles) {
                    showMessage('dashboardMessage', 'ูู ูุชู ุงูุนุซูุฑ ุนูู ูุฑูุจุฉ ุจูุฐุง ุงูุฑูู', 'error');
                    return;
                }
                
                const vehicleKey = Object.keys(vehicles)[0];
                const vehicle = vehicles[vehicleKey];
                const now = new Date();
                
                // ุชุญุฏูุซ ุญุงูุฉ ุงููุฑูุจุฉ
                const updates = {
                    vehicleStatus: vehicleStatus,
                    lastUpdatedBy: currentUser.username,
                    lastUpdatedAt: now.toISOString()
                };
                
                const updateEntry = {
                    updatedBy: currentUser.username,
                    updatedAt: now.toISOString(),
                    changes: `Vehicle status changed to ${vehicleStatus}`,
                    notes: statusNotes
                };
                
                const updateHistory = vehicle.updateHistory || [];
                updateHistory.push(updateEntry);
                updates.updateHistory = updateHistory;
                
                await database.ref('vehicles/' + vehicleKey).update(updates);
                
                // ุฅุถุงูุฉ ุฅูู ุณุฌู ุญุงูุงุช ุงููุฑูุจุงุช
                const statusHistoryRef = database.ref('vehicleStatusHistory');
                await statusHistoryRef.push({
                    plateNumber: plateNumber,
                    vehicleStatus: vehicleStatus,
                    statusNotes: statusNotes,
                    updatedBy: currentUser.username,
                    updatedAt: now.toISOString(),
                    vehicleId: vehicleKey
                });
                
                showMessage('dashboardMessage', translate('statusUpdated'), 'success');
                document.getElementById('vehicleStatusForm').reset();
                loadVehicleStatusHistory();
                loadVehicleRecords();
            });

            // ูููุฐุฌ ุทูุจ ุงูุดุฑูุญุฉ
            document.getElementById('chipRequestForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const plateNumber = document.getElementById('chipPlateNumber').value;
                const requestType = document.getElementById('requestType').value;
                const currentChipNumber = document.getElementById('currentChipNumber').value;
                const requestNotes = document.getElementById('requestNotes').value;
                const urgentRequest = document.getElementById('urgentRequest').checked;
                
                if (!plateNumber) {
                    showMessage('dashboardMessage', 'ุงูุฑุฌุงุก ุฅุฏุฎุงู ุฑูู ููุญุฉ ุงููุฑูุจุฉ', 'error');
                    return;
                }
                
                if (!requestType) {
                    showMessage('dashboardMessage', 'ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ููุน ุงูุทูุจ', 'error');
                    return;
                }
                
                const now = new Date();
                const chipRequest = {
                    plateNumber: plateNumber,
                    requestType: requestType,
                    currentChipNumber: currentChipNumber || '',
                    requestNotes: requestNotes,
                    urgentRequest: urgentRequest,
                    requestStatus: 'pending',
                    requestedBy: currentUser.username,
                    requestedAt: now.toISOString(),
                    requestId: generateRequestId()
                };
                
                const chipRequestsRef = database.ref('chipRequests');
                await chipRequestsRef.push(chipRequest);
                
                showMessage('dashboardMessage', translate('chipRequestSubmitted'), 'success');
                document.getElementById('chipRequestForm').reset();
                document.getElementById('urgentRequest').checked = false;
                loadChipRequests();
                
                if (currentUser.role === 'admin') {
                    loadAdminChipRequests();
                }
            });

            // ูููุฐุฌ ุงูููู ุงูุดุฎุตู
            document.getElementById('profileForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('profilePassword').value;
                const selectedProfileProject = document.getElementById('profileProject').value;
                
                if (currentUser.password !== currentPassword && currentUser.username !== 'ูููุฏุง' && currentUser.username !== 'Honda') {
                    showMessage('dashboardMessage', 'ูููุฉ ุงููุฑูุฑ ุงูุญุงููุฉ ุบูุฑ ุตุญูุญุฉ', 'error');
                    return;
                }
                
                const updates = {
                    username: document.getElementById('profileUsername').value,
                    project: selectedProfileProject || currentUser.project,
                    area: document.getElementById('profileArea').value
                };
                
                if (newPassword) {
                    updates.password = newPassword;
                }
                
                const userRef = database.ref('users/' + currentUser.id);
                await userRef.update(updates);
                
                currentUser = { ...currentUser, ...updates };
                updateUserInfo();
                showMessage('dashboardMessage', translate('profileUpdated'), 'success');
            });

            // ูููุฐุฌ ุงูุชุนุฏูู
            document.getElementById('editForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const plateNumber = document.getElementById('editPlate').value;
                if (!validatePlateNumber(plateNumber)) {
                    return;
                }
                
                const now = new Date();
                const vehicleId = document.getElementById('editId').value;
                const editPrevProject = document.getElementById('editPrevProject').value || 'ูุง ููุฌุฏ/No Vehicle';
                const editCurrProject = document.getElementById('editCurrProject').value || 'ูุง ููุฌุฏ/No Vehicle';
                const editArea = document.getElementById('editArea').value;
                const vehicleStatus = document.getElementById('editVehicleStatus').value;
                
                if (!editArea) {
                    showMessage('dashboardMessage', 'ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงูููุทูุฉ', 'error');
                    return;
                }
                
                const vehicleRef = database.ref('vehicles/' + vehicleId);
                const snapshot = await vehicleRef.once('value');
                const currentVehicle = snapshot.val();
                
                const updates = {
                    plateNumber: plateNumber,
                    area: editArea,
                    previousProject: editPrevProject,
                    currentProject: editCurrProject,
                    additionalInfo: document.getElementById('editAdditionalInfo').value || '',
                    lastUpdatedBy: currentUser.username,
                    lastUpdatedAt: now.toISOString()
                };
                
                if (vehicleStatus) {
                    updates.vehicleStatus = vehicleStatus;
                }
                
                const updateEntry = {
                    updatedBy: currentUser.username,
                    updatedAt: now.toISOString(),
                    changes: `Updated by ${currentUser.username}`
                };
                
                const updateHistory = currentVehicle.updateHistory || [];
                updateHistory.push(updateEntry);
                updates.updateHistory = updateHistory;
                
                await vehicleRef.update(updates);
                
                closeModal();
                showMessage('dashboardMessage', translate('vehicleUpdated'), 'success');
                loadVehicleRecords();
                
                // ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏููู ุชููุงุฆูุงู ูููุณุคูู
                if (currentUser.role === 'admin') {
                    loadUserVehicleData();
                }
            });
        }

        // ุชูููุฏ ุฑูู ุทูุจ
        function generateRequestId() {
            const timestamp = Date.now();
            const random = Math.floor(Math.random() * 1000);
            return `REQ-${timestamp}-${random}`;
        }

        // ุชุญุฏูุซ: ุฏุงูุฉ ุฌุฏูุฏุฉ ูุชุญุฏูุซ ุญุงูุฉ ุงููุฑูุจุฉ ุจุดูู ูุฑุฏู
        async function updateVehicleStatusIndividual(vehicleId, newStatus, notes) {
            try {
                const vehicleRef = database.ref('vehicles/' + vehicleId);
                const snapshot = await vehicleRef.once('value');
                const vehicle = snapshot.val();
                
                if (!vehicle) {
                    console.error('Vehicle not found:', vehicleId);
                    return false;
                }
                
                // ุฅุฐุง ูุงูุช ุงูุญุงูุฉ ููุณูุงุ ูุง ุชูู ุจุงูุชุญุฏูุซ
                if (vehicle.vehicleStatus === newStatus) {
                    console.log('Status already matches, skipping:', vehicleId);
                    return false;
                }
                
                const now = new Date();
                const updates = {
                    vehicleStatus: newStatus,
                    lastUpdatedBy: currentUser.username,
                    lastUpdatedAt: now.toISOString()
                };
                
                const updateEntry = {
                    updatedBy: currentUser.username,
                    updatedAt: now.toISOString(),
                    changes: `Status changed from ${vehicle.vehicleStatus} to ${newStatus}`,
                    notes: notes || ''
                };
                
                const updateHistory = vehicle.updateHistory || [];
                updateHistory.push(updateEntry);
                updates.updateHistory = updateHistory;
                
                await vehicleRef.update(updates);
                
                // ุฅุถุงูุฉ ุฅูู ุณุฌู ุญุงูุงุช ุงููุฑูุจุงุช
                const statusHistoryRef = database.ref('vehicleStatusHistory');
                await statusHistoryRef.push({
                    plateNumber: vehicle.plateNumber,
                    vehicleStatus: newStatus,
                    statusNotes: notes || '',
                    updatedBy: currentUser.username,
                    updatedAt: now.toISOString(),
                    vehicleId: vehicleId,
                    bulkUpdate: true
                });
                
                return true;
            } catch (error) {
                console.error('Error updating vehicle status:', error);
                return false;
            }
        }

        // ุงูุจุญุซ ุนู ูุฑูุจุฉ ููุญุงูุฉ
        async function searchVehicleForStatus() {
            const plateNumber = document.getElementById('statusPlateNumber').value;
            const resultDiv = document.getElementById('vehicleStatusResult');
            
            if (!plateNumber) {
                resultDiv.innerHTML = '';
                return;
            }
            
            const vehiclesRef = database.ref('vehicles');
            const snapshot = await vehiclesRef.orderByChild('plateNumber').equalTo(plateNumber).once('value');
            const vehicles = snapshot.val();
            
            if (vehicles) {
                const vehicleKey = Object.keys(vehicles)[0];
                const vehicle = vehicles[vehicleKey];
                
                resultDiv.innerHTML = `
                    <div style="background: #e8f5e9; padding: 10px; border-radius: 6px; border: 1px solid #c8e6c9;">
                        <strong>ุงููุฑูุจุฉ ููุฌูุฏุฉ:</strong> ${vehicle.plateNumber}<br>
                        <strong>ุงูููุทูุฉ:</strong> ${vehicle.area}<br>
                        <strong>ุงููุดุฑูุน ุงูุญุงูู:</strong> ${vehicle.currentProject}<br>
                        <strong>ุงูุญุงูุฉ ุงูุญุงููุฉ:</strong> ${vehicle.vehicleStatus === 'working' ? 'ุชุนูู' : 'ูุชูููุฉ'}
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div style="background: #ffebee; padding: 10px; border-radius: 6px; border: 1px solid #ffcdd2;">
                        <strong>โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ูุฑูุจุฉ ุจูุฐุง ุงูุฑูู</strong>
                    </div>
                `;
            }
        }

        // ุฅุนุฏุงุฏ ุงูุณุญุจ ูุงูุฅููุงุช
        function setupDragAndDrop() {
            const dropArea = document.getElementById('excelDropArea');
            
            if (!dropArea) return;
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropArea.style.borderColor = 'var(--primary)';
                dropArea.style.background = 'rgba(26, 35, 126, 0.05)';
            }
            
            function unhighlight() {
                dropArea.style.borderColor = '#bdbdbd';
                dropArea.style.background = '#f9f9f9';
            }
            
            dropArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleExcelFiles(files);
            }
        }

        // ูุนุงูุฌุฉ ููู ุฅูุณู
        function handleExcelFileSelect(event) {
            const files = event.target.files;
            handleExcelFiles(files);
        }

        async function handleExcelFiles(files) {
            if (files.length === 0) return;
            
            const file = files[0];
            
            if (file.type !== 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' &&
                file.type !== 'application/vnd.ms-excel' &&
                !file.name.match(/\.(xlsx|xls|csv)$/i)) {
                showMessage('dashboardMessage', 'ูุฑุฌู ุฑูุน ููู Excel ุตุงูุญ (xlsx, xls, csv)', 'error');
                return;
            }
            
            showMessage('dashboardMessage', 'ุฌุงุฑู ุชุญููู ููู Excel...', 'info');
            
            try {
                const data = await readExcelFile(file);
                await parseExcelData(data);
            } catch (error) {
                console.error('Excel parsing error:', error);
                showMessage('dashboardMessage', 'ุญุฏุซ ุฎุทุฃ ูู ูุฑุงุกุฉ ููู Excel. ุชุฃูุฏ ูู ุตุญุฉ ุชูุณูู ุงูููู.', 'error');
            }
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = e.target.result;
                        const workbook = XLSX.read(data, { type: 'binary' });
                        resolve(workbook);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = function(e) {
                    reject(new Error('ูุดู ูู ูุฑุงุกุฉ ุงูููู'));
                };
                
                reader.readAsBinaryString(file);
            });
        }

        async function parseExcelData(workbook) {
            try {
                // ุฌูุจ ุฌููุน ุงููุฑูุจุงุช ุงูููุฌูุฏุฉ ุฃููุงู
                const existingVehicles = await getAllVehicles();
                
                // ุงุณุชุฎุฏุงู ุงููุฑูุฉ ุงูุฃููู
                const firstSheet = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheet];
                
                // ุชุญููู ุงููุฑูุฉ ุฅูู JSON
                const excelDataArray = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                if (excelDataArray.length < 2) {
                    showMessage('dashboardMessage', 'ุงูููู ูุง ูุญุชูู ุนูู ุจูุงูุงุช', 'error');
                    return;
                }
                
                // ุงูุจุญุซ ุนู ุนูุงููู ุงูุฃุนูุฏุฉ
                const headers = excelDataArray[0];
                const dataRows = excelDataArray.slice(1);
                
                // ุชุญุฏูุฏ ุฃุนูุฏุฉ ุงูุจูุงูุงุช ุจูุงุกู ุนูู ุงูุนูุงููู
                let plateCol = -1, prevProjectCol = -1, currProjectCol = -1, areaCol = -1, statusCol = -1;
                
                headers.forEach((header, index) => {
                    const headerStr = String(header).toLowerCase();
                    if (headerStr.includes('plate') || headerStr.includes('ุฑูู') || headerStr.includes('ููุญุฉ')) {
                        plateCol = index;
                    } else if (headerStr.includes('previous') || headerStr.includes('ุณุงุจู')) {
                        prevProjectCol = index;
                    } else if (headerStr.includes('current') || headerStr.includes('ุญุงูู')) {
                        currProjectCol = index;
                    } else if (headerStr.includes('area') || headerStr.includes('ููุทูุฉ')) {
                        areaCol = index;
                    } else if (headerStr.includes('status') || headerStr.includes('ุญุงูุฉ')) {
                        statusCol = index;
                    }
                });
                
                // ุงูุชุญูู ูู ูุฌูุฏ ุงูุฃุนูุฏุฉ ุงููุทููุจุฉ
                if (plateCol === -1) {
                    showMessage('dashboardMessage', 'ูู ูุชู ุงูุนุซูุฑ ุนูู ุนููุฏ "ุฑูู ุงูููุญุฉ" ูู ุงูููู', 'error');
                    return;
                }
                
                // ูุนุงูุฌุฉ ุงูุจูุงูุงุช
                excelOriginalData = [];
                excelData = [];
                
                for (let i = 0; i < dataRows.length; i++) {
                    const row = dataRows[i];
                    if (row.length === 0) continue;
                    
                    const plateNumber = String(row[plateCol] || '').trim();
                    if (!plateNumber) continue;
                    
                    const previousProject = prevProjectCol !== -1 ? String(row[prevProjectCol] || '').trim() : 'ูุง ููุฌุฏ/No Vehicle';
                    const currentProject = currProjectCol !== -1 ? String(row[currProjectCol] || '').trim() : 'ูุง ููุฌุฏ/No Vehicle';
                    const area = areaCol !== -1 ? String(row[areaCol] || '').trim() : '';
                    const vehicleStatus = statusCol !== -1 ? String(row[statusCol] || '').trim() : 'working';
                    
                    // ุงูุชุญูู ูู ุตุญุฉ ุฑูู ุงูููุญุฉ
                    if (!validatePlateNumber(plateNumber)) {
                        continue;
                    }
                    
                    const vehicleData = {
                        plateNumber: plateNumber,
                        previousProject: previousProject || 'ูุง ููุฌุฏ/No Vehicle',
                        currentProject: currentProject || 'ูุง ููุฌุฏ/No Vehicle',
                        area: area || '',
                        vehicleStatus: vehicleStatus || 'working',
                        action: existingVehicles[plateNumber] ? translate('updateExisting') : translate('newEntry')
                    };
                    
                    excelOriginalData.push(vehicleData);
                    excelData.push(vehicleData);
                }
                
                if (excelData.length === 0) {
                    showMessage('dashboardMessage', translate('noExcelData'), 'error');
                    return;
                }
                
                showExcelPreview();
                showMessage('dashboardMessage', `ุชู ุชุญููู ${excelData.length} ูุฑูุจุฉ ูู ุงูููู`, 'success');
                
            } catch (error) {
                console.error('Error parsing Excel:', error);
                showMessage('dashboardMessage', translate('invalidExcelFormat'), 'error');
            }
        }

        async function getAllVehicles() {
            const vehiclesRef = database.ref('vehicles');
            const snapshot = await vehiclesRef.once('value');
            const vehicles = snapshot.val();
            const vehicleMap = {};
            
            if (vehicles) {
                Object.values(vehicles).forEach(vehicle => {
                    if (vehicle.plateNumber) {
                        vehicleMap[vehicle.plateNumber] = vehicle;
                    }
                });
            }
            
            existingVehiclesMap = vehicleMap;
            return vehicleMap;
        }

        function showExcelPreview() {
            const previewBody = document.getElementById('excelPreviewBody');
            if (!previewBody) return;
            
            previewBody.innerHTML = '';
            
            let newEntries = 0;
            let updateEntries = 0;
            
            excelData.forEach((row, index) => {
                const tr = document.createElement('tr');
                
                // ุชุญุฏูุฏ ุฅุฐุง ูุงูุช ุฅุฏุฎุงู ุฌุฏูุฏ ุฃู ุชุญุฏูุซ
                const isUpdate = row.action === translate('updateExisting');
                if (isUpdate) {
                    updateEntries++;
                } else {
                    newEntries++;
                }
                
                // ุงูุชุญูู ูู ุงูููุงุทู ูุงููุดุงุฑูุน
                const areaWarning = !row.area ? 'โ๏ธ ููุทูุฉ ููููุฏุฉ' : '';
                const projectWarning = (!row.previousProject && !row.currentProject) ? 'โ๏ธ ูุดุฑูุน ููููุฏ' : '';
                const statusWarning = !row.vehicleStatus ? 'โ๏ธ ุญุงูุฉ ููููุฏุฉ' : '';
                
                tr.innerHTML = `
                    <td><strong>${row.plateNumber}</strong></td>
                    <td>${row.previousProject || 'ูุง ููุฌุฏ/No Vehicle'}</td>
                    <td>${row.currentProject || 'ูุง ููุฌุฏ/No Vehicle'}</td>
                    <td>${row.area || 'ุบูุฑ ูุญุฏุฏ'}</td>
                    <td>${row.vehicleStatus || 'working'}</td>
                    <td><span class="status-badge ${isUpdate ? 'status-warning' : 'status-active'}">${row.action}</span></td>
                    <td style="color: ${areaWarning || projectWarning || statusWarning ? '#ff9800' : '#4caf50'}; font-size: 0.85rem;">
                        ${areaWarning} ${projectWarning ? '<br>' + projectWarning : ''} ${statusWarning ? '<br>' + statusWarning : ''}
                    </td>
                `;
                previewBody.appendChild(tr);
            });
            
            // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
            document.getElementById('vehicleCount').textContent = excelData.length;
            document.getElementById('newEntriesCount').textContent = newEntries;
            document.getElementById('updateEntriesCount').textContent = updateEntries;
            
            document.getElementById('excelPreview').style.display = 'block';
            document.getElementById('excelPreview').scrollIntoView({ behavior: 'smooth' });
        }

        async function uploadExcelData() {
            if (excelData.length === 0) {
                showMessage('dashboardMessage', 'ูุง ุชูุฌุฏ ุจูุงูุงุช ูุฑูุนูุง', 'error');
                return;
            }
            
            showMessage('dashboardMessage', 'ุฌุงุฑู ุฑูุน ุงูุจูุงูุงุช...', 'info');
            
            const now = new Date();
            let successCount = 0;
            let errorCount = 0;
            
            for (const vehicle of excelData) {
                try {
                    // ุงูุชุญูู ูู ุฑูู ุงูููุญุฉ
                    if (!validatePlateNumber(vehicle.plateNumber)) {
                        errorCount++;
                        continue;
                    }
                    
                    // ุงุณุชุฎุฏุงู ุงุณู ุงูููุทูุฉ ุงูููุฌูุฏ ุฃู "ุบูุฑ ูุญุฏุฏ"
                    const areaToUse = vehicle.area || 'ุบูุฑ ูุญุฏุฏ/Undefined';
                    const statusToUse = vehicle.vehicleStatus || 'working';
                    
                    const vehicleData = {
                        plateNumber: vehicle.plateNumber,
                        previousProject: vehicle.previousProject || 'ูุง ููุฌุฏ/No Vehicle',
                        currentProject: vehicle.currentProject || 'ูุง ููุฌุฏ/No Vehicle',
                        area: areaToUse,
                        vehicleStatus: statusToUse,
                        additionalInfo: '',
                        createdBy: currentUser.username,
                        createdAt: now.toISOString(),
                        lastUpdatedBy: currentUser.username,
                        lastUpdatedAt: now.toISOString(),
                        updateHistory: [{
                            updatedBy: currentUser.username,
                            updatedAt: now.toISOString(),
                            changes: "Uploaded via Excel"
                        }]
                    };
                    
                    const vehiclesRef = database.ref('vehicles');
                    await vehiclesRef.push(vehicleData);
                    successCount++;
                    
                } catch (error) {
                    console.error('Error uploading vehicle:', error);
                    errorCount++;
                }
            }
            
            showMessage('dashboardMessage', 
                `ุชู ุฑูุน ${successCount} ูุฑูุจุฉ ุจูุฌุงุญ${errorCount > 0 ? `ุ ูุดู ุฑูุน ${errorCount} ูุฑูุจุฉ` : ''}`, 
                successCount > 0 ? 'success' : 'error'
            );
            
            document.getElementById('excelPreview').style.display = 'none';
            document.getElementById('excelFileInput').value = '';
            excelData = [];
            loadVehicleRecords();
            
            if (currentUser.role === 'admin') {
                loadUserVehicleData();
            }
        }

        async function updateExcelData() {
            if (excelData.length === 0) {
                showMessage('dashboardMessage', 'ูุง ุชูุฌุฏ ุจูุงูุงุช ูุชุญุฏูุซูุง', 'error');
                return;
            }
            
            showMessage('dashboardMessage', 'ุฌุงุฑู ุชุญุฏูุซ ุงูุจูุงูุงุช...', 'info');
            
            const now = new Date();
            let successCount = 0;
            let errorCount = 0;
            
            for (const vehicle of excelData) {
                try {
                    // ุงูุชุญูู ูู ุฑูู ุงูููุญุฉ
                    if (!validatePlateNumber(vehicle.plateNumber)) {
                        errorCount++;
                        continue;
                    }
                    
                    const vehiclesRef = database.ref('vehicles');
                    const snapshot = await vehiclesRef.orderByChild('plateNumber').equalTo(vehicle.plateNumber).once('value');
                    const existingVehicles = snapshot.val();
                    
                    const areaToUse = vehicle.area || 'ุบูุฑ ูุญุฏุฏ/Undefined';
                    const statusToUse = vehicle.vehicleStatus || 'working';
                    
                    if (existingVehicles) {
                        // ุชุญุฏูุซ ุงููุฑูุจุฉ ุงูููุฌูุฏุฉ
                        const vehicleKey = Object.keys(existingVehicles)[0];
                        const vehicleRef = database.ref('vehicles/' + vehicleKey);
                        const currentVehicle = existingVehicles[vehicleKey];
                        
                        const updates = {
                            previousProject: vehicle.previousProject || 'ูุง ููุฌุฏ/No Vehicle',
                            currentProject: vehicle.currentProject || 'ูุง ููุฌุฏ/No Vehicle',
                            area: areaToUse,
                            vehicleStatus: statusToUse,
                            lastUpdatedBy: currentUser.username,
                            lastUpdatedAt: now.toISOString()
                        };
                        
                        const updateEntry = {
                            updatedBy: currentUser.username,
                            updatedAt: now.toISOString(),
                            changes: `Updated via Excel by ${currentUser.username}`
                        };
                        
                        const updateHistory = currentVehicle.updateHistory || [];
                        updateHistory.push(updateEntry);
                        updates.updateHistory = updateHistory;
                        
                        await vehicleRef.update(updates);
                        successCount++;
                        
                    } else {
                        // ุฅุถุงูุฉ ูุฑูุจุฉ ุฌุฏูุฏุฉ
                        const vehicleData = {
                            plateNumber: vehicle.plateNumber,
                            previousProject: vehicle.previousProject || 'ูุง ููุฌุฏ/No Vehicle',
                            currentProject: vehicle.currentProject || 'ูุง ููุฌุฏ/No Vehicle',
                            area: areaToUse,
                            vehicleStatus: statusToUse,
                            additionalInfo: '',
                            createdBy: currentUser.username,
                            createdAt: now.toISOString(),
                            lastUpdatedBy: currentUser.username,
                            lastUpdatedAt: now.toISOString(),
                            updateHistory: [{
                                updatedBy: currentUser.username,
                                updatedAt: now.toISOString(),
                                changes: "Created via Excel"
                            }]
                        };
                        
                        await vehiclesRef.push(vehicleData);
                        successCount++;
                    }
                    
                } catch (error) {
                    console.error('Error updating vehicle:', error);
                    errorCount++;
                }
            }
            
            showMessage('dashboardMessage', 
                `ุชู ุชุญุฏูุซ/ุฅุถุงูุฉ ${successCount} ูุฑูุจุฉ ุจูุฌุงุญ${errorCount > 0 ? `ุ ูุดู ${errorCount} ูุฑูุจุฉ` : ''}`, 
                successCount > 0 ? 'success' : 'error'
            );
            
            document.getElementById('excelPreview').style.display = 'none';
            document.getElementById('excelFileInput').value = '';
            excelData = [];
            loadVehicleRecords();
            
            if (currentUser.role === 'admin') {
                loadUserVehicleData();
            }
        }

        // ุชุญููู ูุงูุจ Excel
        function downloadExcelTemplate() {
            const headers = [
                ['ุฑูู ุงูููุญุฉ/Plate Number', 'ุงููุดุฑูุน ุงูุณุงุจู/Previous Project', 'ุงููุดุฑูุน ุงูุญุงูู/Current Project', 'ุงูููุทูุฉ/Area', 'ุญุงูุฉ ุงููุฑูุจุฉ/Vehicle Status'],
                ['ABC 1234', 'ุงุฑุงููุณ/Aramex', 'ูููุงุฑุช/Kimart', 'ุงูุฑูุงุถ/Riyadh', 'ุชุนูู/Working'],
                ['XYZ 5678', 'ูุง ููุฌุฏ/No Vehicle', 'ุงูุจุจุณู/Pepsi', 'ุฌุฏุฉ/Jeddah', 'ูุชูููุฉ/Stopped']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(headers);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ูุงุฆูุฉ ุงููุฑูุจุงุช");
            
            // ุชุนููู ุนุฑุถ ุงูุฃุนูุฏุฉ
            const wscols = [
                {wch: 15}, // ุฑูู ุงูููุญุฉ
                {wch: 25}, // ุงููุดุฑูุน ุงูุณุงุจู
                {wch: 25}, // ุงููุดุฑูุน ุงูุญุงูู
                {wch: 20}, // ุงูููุทูุฉ
                {wch: 15}  // ุญุงูุฉ ุงููุฑูุจุฉ
            ];
            ws['!cols'] = wscols;
            
            // ุชุญููู ุงูููู
            XLSX.writeFile(wb, `ูุงูุจ_ุงููุฑูุจุงุช_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        // ุชุญููู ูุงูุจ Excel ูุน ุงูุจูุงูุงุช ุงูุญุงููุฉ
        async function downloadExcelTemplateWithData() {
            try {
                const vehiclesRef = database.ref('vehicles');
                const snapshot = await vehiclesRef.once('value');
                const vehicles = snapshot.val();
                
                const headers = [['ุฑูู ุงูููุญุฉ/Plate Number', 'ุงููุดุฑูุน ุงูุณุงุจู/Previous Project', 'ุงููุดุฑูุน ุงูุญุงูู/Current Project', 'ุงูููุทูุฉ/Area', 'ุญุงูุฉ ุงููุฑูุจุฉ/Vehicle Status']];
                const data = [];
                
                if (vehicles) {
                    Object.values(vehicles).forEach(vehicle => {
                        data.push([
                            vehicle.plateNumber || '',
                            vehicle.previousProject || 'ูุง ููุฌุฏ/No Vehicle',
                            vehicle.currentProject || 'ูุง ููุฌุฏ/No Vehicle',
                            vehicle.area || '',
                            vehicle.vehicleStatus || 'working'
                        ]);
                    });
                }
                
                const allData = headers.concat(data);
                const ws = XLSX.utils.aoa_to_sheet(allData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "ุงููุฑูุจุงุช");
                
                // ุชุนููู ุนุฑุถ ุงูุฃุนูุฏุฉ
                const wscols = [
                    {wch: 15},
                    {wch: 25},
                    {wch: 25},
                    {wch: 20},
                    {wch: 15}
                ];
                ws['!cols'] = wscols;
                
                // ุชุญููู ุงูููู
                XLSX.writeFile(wb, `ูุฑูุจุงุช_${new Date().toISOString().slice(0,10)}.xlsx`);
                showMessage('dashboardMessage', 'ุชู ุชุญููู ููู Excel ุจูุฌุงุญ', 'success');
                
            } catch (error) {
                console.error('Error downloading Excel:', error);
                showMessage('dashboardMessage', 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูููู', 'error');
            }
        }

        // ุชุญููู ุฌููุน ุงูุณุฌูุงุช ูููู Excel ูุน ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
        async function downloadAllRecords() {
            try {
                let query = database.ref('vehicles');
                
                // ูููุดุฑููู: ููุท ุงููุฑูุจุงุช ุงูุชู ุฃุฏุฎูููุง
                if (currentUser.role === 'supervisor') {
                    query = query.orderByChild('createdBy').equalTo(currentUser.username);
                }
                // ูููุณุคูู: ุฌููุน ุงููุฑูุจุงุช
                
                const snapshot = await query.once('value');
                const vehicles = snapshot.val();
                
                const headers = [[
                    'ุฑูู ุงูููุญุฉ/Plate Number',
                    'ุงูููุทูุฉ/Area',
                    'ุงููุดุฑูุน ุงูุณุงุจู/Previous Project',
                    'ุงููุดุฑูุน ุงูุญุงูู/Current Project',
                    'ุญุงูุฉ ุงููุฑูุจุฉ/Vehicle Status',
                    'ุขุฎุฑ ุชุญุฏูุซ/Last Update',
                    'ูุญุฏุซ ุจูุงุณุทุฉ/Updated By',
                    'ุชุงุฑูุฎ ุงูุฅูุดุงุก/Created At',
                    'ุฃูุดุฆ ุจูุงุณุทุฉ/Created By'
                ]];
                
                const data = [];
                
                if (vehicles) {
                    Object.values(vehicles).forEach(vehicle => {
                        const lastUpdate = vehicle.lastUpdatedAt ? 
                            new Date(vehicle.lastUpdatedAt).toLocaleString('ar-SA') : 
                            'ุบูุฑ ูุนุฑูู';
                        const createdAt = vehicle.createdAt ? 
                            new Date(vehicle.createdAt).toLocaleString('ar-SA') : 
                            'ุบูุฑ ูุนุฑูู';
                        
                        data.push([
                            vehicle.plateNumber || '',
                            vehicle.area || '',
                            vehicle.previousProject || 'ูุง ููุฌุฏ/No Vehicle',
                            vehicle.currentProject || 'ูุง ููุฌุฏ/No Vehicle',
                            vehicle.vehicleStatus === 'working' ? 'ุชุนูู/Working' : 'ูุชูููุฉ/Stopped',
                            lastUpdate,
                            vehicle.lastUpdatedBy || vehicle.createdBy || '',
                            createdAt,
                            vehicle.createdBy || ''
                        ]);
                    });
                }
                
                const allData = headers.concat(data);
                const ws = XLSX.utils.aoa_to_sheet(allData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "ุณุฌูุงุช ุงููุฑูุจุงุช");
                
                // ุชุนููู ุนุฑุถ ุงูุฃุนูุฏุฉ
                const wscols = [
                    {wch: 15}, {wch: 20}, {wch: 25}, {wch: 25},
                    {wch: 15}, {wch: 25}, {wch: 20}, {wch: 25}, {wch: 20}
                ];
                ws['!cols'] = wscols;
                
                // ุฅุถุงูุฉ ุงุณู ุงููุณุชุฎุฏู ูุงุณู ุงูููู
                const username = currentUser.username.replace(/[^a-zA-Z0-9]/g, '_');
                const filename = currentUser.role === 'admin' 
                    ? `ุณุฌูุงุช_ุงููุฑูุจุงุช_${new Date().toISOString().slice(0,10)}.xlsx`
                    : `ุณุฌูุงุช_ุงููุฑูุจุงุช_${username}_${new Date().toISOString().slice(0,10)}.xlsx`;
                
                XLSX.writeFile(wb, filename);
                showMessage('dashboardMessage', `ุชู ุชุญููู ${data.length} ุณุฌู ุจูุฌุงุญ`, 'success');
                
            } catch (error) {
                console.error('Error downloading records:', error);
                showMessage('dashboardMessage', 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูุณุฌูุงุช', 'error');
            }
        }

        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            element.className = `message ${type}`;
            element.style.display = 'flex';
            
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        function showDashboard() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            updateUserInfo();
            loadVehicleRecords();
            loadVehicleStatusHistory();
            loadChipRequests();
            
            const adminElements = document.querySelectorAll('.admin-only');
            if (currentUser.role === 'admin') {
                adminElements.forEach(el => el.style.display = 'block');
                loadPendingApprovals();
                loadAllUsers();
                loadUserVehicleData();
                loadAdminChipRequests();
            } else {
                adminElements.forEach(el => el.style.display = 'none');
            }
            
            showSection('vehicleSection');
        }

        function updateUserInfo() {
            const userNameEl = document.getElementById('userName');
            const userRoleEl = document.getElementById('userRole');
            const userProjectEl = document.getElementById('userProject');
            const userAreaEl = document.getElementById('userArea');
            
            if (userNameEl) {
                userNameEl.textContent = `${translate('welcome')} ${currentUser.username}`;
            }
            if (userRoleEl) {
                userRoleEl.textContent = translate(currentUser.role);
            }
            if (userProjectEl) {
                userProjectEl.textContent = currentUser.project || '';
            }
            if (userAreaEl) {
                userAreaEl.textContent = currentUser.area || '';
            }
            
            const profileUsername = document.getElementById('profileUsername');
            const profileProject = document.getElementById('profileProject');
            const profileArea = document.getElementById('profileArea');
            
            if (profileUsername) profileUsername.value = currentUser.username;
            if (profileProject) profileProject.value = currentUser.project || '';
            if (profileArea) profileArea.value = currentUser.area || '';
            
            if (currentUser.project) {
                setTimeout(() => {
                    const profileList = document.getElementById('profileProjectsList');
                    if (profileList) {
                        profileList.querySelectorAll('.project-item').forEach(item => {
                            if (item.textContent === currentUser.project) {
                                item.classList.add('selected');
                            }
                        });
                    }
                }, 100);
            }
        }

        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.add('active');
                
                // Load vehicles for bulk update when showing status section
                if (sectionId === 'vehicleStatusSection') {
                    loadVehiclesForBulkUpdate();
                }
            }
        }

        // ุงูุชุนุฏูู ุงูุฑุฆูุณู: ุชุตููุฉ ุงูุณุฌูุงุช ุญุณุจ ุงููุณุชุฎุฏู
        async function loadVehicleRecords() {
            const recordsBody = document.getElementById('recordsBody');
            if (!recordsBody) return;
            
            recordsBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">ุฌุงุฑู ุชุญููู ุงูุณุฌูุงุช...</td></tr>';
            
            let query = database.ref('vehicles');
            if (currentUser.role === 'supervisor') {
                query = query.orderByChild('createdBy').equalTo(currentUser.username);
            }
            const snapshot = await query.once('value');
            const vehicles = snapshot.val();
            
            recordsBody.innerHTML = '';
            
            if (vehicles) {
                Object.keys(vehicles).forEach(key => {
                    const vehicle = vehicles[key];
                    const lastUpdate = vehicle.lastUpdatedAt ? 
                        new Date(vehicle.lastUpdatedAt).toLocaleString(currentLanguage === 'ar' ? 'ar-SA' : 'en-US') : 
                        new Date(vehicle.createdAt).toLocaleString(currentLanguage === 'ar' ? 'ar-SA' : 'en-US');
                    
                    const statusBadge = vehicle.vehicleStatus === 'working' ? 
                        '<span class="status-badge status-working">ุชุนูู/Working</span>' : 
                        '<span class="status-badge status-stopped">ูุชูููุฉ/Stopped</span>';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${vehicle.plateNumber}</strong></td>
                        <td>${vehicle.area}</td>
                        <td>${vehicle.previousProject}</td>
                        <td>${vehicle.currentProject}</td>
                        <td>${statusBadge}</td>
                        <td><span class="timestamp-cell">${lastUpdate}</span></td>
                        <td>${vehicle.lastUpdatedBy || vehicle.createdBy}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn update-btn" onclick="editVehicle('${key}')">
                                    <i class="fas fa-edit"></i> ${translate('update')}
                                </button>
                                ${currentUser.role === 'admin' ? `
                                    <button class="action-btn delete-btn" onclick="deleteVehicle('${key}')">
                                        <i class="fas fa-trash"></i> ${translate('delete')}
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    `;
                    recordsBody.appendChild(row);
                });
            } else {
                recordsBody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 40px;">ูุง ุชูุฌุฏ ุณุฌูุงุช ูุฑูุจุงุช</td></tr>`;
            }
            
            updateFilterDropdowns(vehicles);
        }

        function updateFilterDropdowns(vehicles) {
            const areaFilter = document.getElementById('filterArea');
            const projectFilter = document.getElementById('filterProject');
            
            if (!areaFilter || !projectFilter) return;
            
            const areas = new Set();
            const projects = new Set();
            
            if (vehicles) {
                Object.values(vehicles).forEach(vehicle => {
                    if (vehicle.area) areas.add(vehicle.area);
                    if (vehicle.currentProject) projects.add(vehicle.currentProject);
                    if (vehicle.previousProject) projects.add(vehicle.previousProject);
                });
            }
            
            areaFilter.innerHTML = `<option value="" data-i18n="allAreas">${translate('allAreas')}</option>`;
            areas.forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                areaFilter.appendChild(option);
            });
            
            projectFilter.innerHTML = `<option value="" data-i18n="allProjects">${translate('allProjects')}</option>`;
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project;
                option.textContent = project;
                projectFilter.appendChild(option);
            });
        }

        function filterRecords() {
            const areaFilter = document.getElementById('filterArea');
            const projectFilter = document.getElementById('filterProject');
            const statusFilter = document.getElementById('filterStatus');
            const searchText = document.getElementById('searchPlate');
            
            if (!areaFilter || !projectFilter || !searchText) return;
            
            const areaValue = areaFilter.value;
            const projectValue = projectFilter.value;
            const statusValue = statusFilter.value;
            const searchValue = searchText.value.toLowerCase();
            
            const rows = document.querySelectorAll('#recordsBody tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 7) return;
                
                const area = cells[1].textContent;
                const project = cells[3].textContent;
                const plate = cells[0].textContent.toLowerCase();
                const statusBadge = cells[4].querySelector('.status-badge');
                const status = statusBadge ? (statusBadge.textContent.includes('ุชุนูู') ? 'working' : 'stopped') : '';
                
                const areaMatch = !areaValue || area === areaValue;
                const projectMatch = !projectValue || project === projectValue;
                const statusMatch = !statusValue || status === statusValue;
                const searchMatch = !searchValue || plate.includes(searchValue);
                
                row.style.display = areaMatch && projectMatch && statusMatch && searchMatch ? '' : 'none';
            });
        }

        // ุงูุชุนุฏูู ุงูุซุงูู: ุงูุชุญูู ูู ุตูุงุญูุฉ ุงูุชุนุฏูู
        async function editVehicle(vehicleId) {
            const vehicleRef = database.ref('vehicles/' + vehicleId);
            const snapshot = await vehicleRef.once('value');
            const vehicle = snapshot.val();
            
            // ุงูุชุญูู ูู ุตูุงุญูุฉ ุงูุชุนุฏูู
            if (currentUser.role === 'supervisor' && vehicle.createdBy !== currentUser.username) {
                showMessage('dashboardMessage', 'ูุง ุชููู ุตูุงุญูุฉ ูุชุนุฏูู ูุฐู ุงููุฑูุจุฉ', 'error');
                return;
            }
            
            document.getElementById('editId').value = vehicleId;
            document.getElementById('editPlate').value = vehicle.plateNumber || '';
            document.getElementById('editAdditionalInfo').value = vehicle.additionalInfo || '';
            
            const areaSelect = document.getElementById('editArea');
            areaSelect.innerHTML = `<option value="" data-i18n="selectArea">${translate('selectArea')}</option>`;
            saudiAreas[currentLanguage].forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                areaSelect.appendChild(option);
            });
            areaSelect.value = vehicle.area || '';
            
            document.getElementById('editPrevProject').value = vehicle.previousProject || '';
            document.getElementById('editCurrProject').value = vehicle.currentProject || '';
            
            const statusSelect = document.getElementById('editVehicleStatus');
            statusSelect.value = vehicle.vehicleStatus || '';
            
            setTimeout(() => {
                const editPrevList = document.getElementById('editPrevProjectsList');
                const editCurrList = document.getElementById('editCurrProjectsList');
                
                if (editPrevList) {
                    editPrevList.querySelectorAll('.project-item').forEach(item => {
                        if (item.textContent === vehicle.previousProject) {
                            item.classList.add('selected');
                        }
                    });
                }
                
                if (editCurrList) {
                    editCurrList.querySelectorAll('.project-item').forEach(item => {
                        if (item.textContent === vehicle.currentProject) {
                            item.classList.add('selected');
                        }
                    });
                }
            }, 100);
            
            document.getElementById('editModal').style.display = 'flex';
        }

        // ุงูุชุนุฏูู ุงูุซุงูุซ: ุงูุชุญูู ูู ุตูุงุญูุฉ ุงูุญุฐู
        async function deleteVehicle(vehicleId) {
            if (confirm(translate('confirmDelete'))) {
                const vehicleRef = database.ref('vehicles/' + vehicleId);
                const snapshot = await vehicleRef.once('value');
                const vehicle = snapshot.val();
                
                if (currentUser.role === 'supervisor' && vehicle.createdBy !== currentUser.username) {
                    showMessage('dashboardMessage', 'ูุง ุชููู ุตูุงุญูุฉ ูุญุฐู ูุฐู ุงููุฑูุจุฉ', 'error');
                    return;
                }
                
                await vehicleRef.remove();
                showMessage('dashboardMessage', translate('vehicleDeleted'), 'success');
                loadVehicleRecords();
                
                // ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏููู ุชููุงุฆูุงู ูููุณุคูู
                if (currentUser.role === 'admin') {
                    loadUserVehicleData();
                }
            }
        }

        // ุชุญููู ุณุฌู ุญุงูุงุช ุงููุฑูุจุงุช
        async function loadVehicleStatusHistory() {
            const historyBody = document.getElementById('statusHistoryBody');
            if (!historyBody) return;
            
            historyBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px;">ุฌุงุฑู ุงูุชุญููู...</td></tr>';
            
            const statusHistoryRef = database.ref('vehicleStatusHistory');
            const snapshot = await statusHistoryRef.orderByChild('updatedAt').limitToLast(50).once('value');
            const statusHistory = snapshot.val();
            
            historyBody.innerHTML = '';
            
            if (statusHistory) {
                // ุชุญููู ุฅูู ูุตูููุฉ ููุฑุฒ ุญุณุจ ุงูุชุงุฑูุฎ
                const historyArray = Object.values(statusHistory).sort((a, b) => 
                    new Date(b.updatedAt) - new Date(a.updatedAt)
                );
                
                historyArray.forEach(entry => {
                    const updateDate = entry.updatedAt ? 
                        new Date(entry.updatedAt).toLocaleString(currentLanguage === 'ar' ? 'ar-SA' : 'en-US') : 
                        'ุบูุฑ ูุนุฑูู';
                    
                    const statusText = entry.vehicleStatus === 'working' ? 
                        '<span class="status-badge status-working">ุชุนูู/Working</span>' : 
                        '<span class="status-badge status-stopped">ูุชูููุฉ/Stopped</span>';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${entry.plateNumber}</strong></td>
                        <td>${statusText}</td>
                        <td>${entry.statusNotes || 'ูุง ุชูุฌุฏ ููุงุญุธุงุช'}</td>
                        <td>${entry.updatedBy}</td>
                        <td><span class="timestamp-cell">${updateDate}</span></td>
                    `;
                    historyBody.appendChild(row);
                });
            } else {
                historyBody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 40px;">ูุง ุชูุฌุฏ ุชุญุฏูุซุงุช ุญุงูุงุช</td></tr>`;
            }
        }

        // ุชุญููู ุทูุจุงุช ุงูุดุฑุงุฆุญ
        async function loadChipRequests() {
            const requestsBody = document.getElementById('chipRequestsBody');
            if (!requestsBody) return;
            
            requestsBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px;">ุฌุงุฑู ุงูุชุญููู...</td></tr>';
            
            const chipRequestsRef = database.ref('chipRequests');
            const snapshot = await chipRequestsRef.orderByChild('requestedAt').limitToLast(20).once('value');
            const chipRequests = snapshot.val();
            
            requestsBody.innerHTML = '';
            
            if (chipRequests) {
                // ุชุญููู ุฅูู ูุตูููุฉ ููุฑุฒ ุญุณุจ ุงูุชุงุฑูุฎ
                const requestsArray = Object.values(chipRequests).sort((a, b) => 
                    new Date(b.requestedAt) - new Date(a.requestedAt)
                );
                
                requestsArray.forEach(request => {
                    const requestDate = request.requestedAt ? 
                        new Date(request.requestedAt).toLocaleString(currentLanguage === 'ar' ? 'ar-SA' : 'en-US') : 
                        'ุบูุฑ ูุนุฑูู';
                    
                    const urgentBadge = request.urgentRequest ? 
                        '<span class="status-badge status-pending">ุนุงุฌู/Urgent</span>' : 
                        '<span class="status-badge status-active">ุนุงุฏู/Normal</span>';
                    
                    const statusBadge = request.requestStatus === 'pending' ? 
                        '<span class="status-badge status-pending">ููุฏ ุงูุงูุชุธุงุฑ/Pending</span>' : 
                        request.requestStatus === 'approved' ? 
                        '<span class="status-badge status-active">ูุนุชูุฏุฉ/Approved</span>' : 
                        '<span class="status-badge status-inactive">${request.requestStatus}</span>';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${request.plateNumber}</strong></td>
                        <td>${request.requestType}</td>
                        <td>${request.currentChipNumber || 'ุบูุฑ ูุญุฏุฏ'}</td>
                        <td>${request.requestNotes || 'ูุง ุชูุฌุฏ ููุงุญุธุงุช'}</td>
                        <td>${urgentBadge}</td>
                        <td>${statusBadge}</td>
                        <td>${request.requestedBy}</td>
                        <td><span class="timestamp-cell">${requestDate}</span></td>
                    `;
                    requestsBody.appendChild(row);
                });
            } else {
                requestsBody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 40px;">ูุง ุชูุฌุฏ ุทูุจุงุช ุดุฑุงุฆุญ</td></tr>`;
            }
        }

        // ุชุญููู ุทูุจุงุช ุงูุดุฑุงุฆุญ ูููุณุคูู
        async function loadAdminChipRequests() {
            const requestsBody = document.getElementById('adminChipRequestsBody');
            if (!requestsBody) return;
            
            requestsBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 30px;">ุฌุงุฑู ุงูุชุญููู...</td></tr>';
            
            const chipRequestsRef = database.ref('chipRequests');
            const snapshot = await chipRequestsRef.once('value');
            const chipRequests = snapshot.val();
            
            requestsBody.innerHTML = '';
            let requestsCount = 0;
            
            if (chipRequests) {
                requestsCount = Object.keys(chipRequests).length;
                
                // ุชุญููู ุฅูู ูุตูููุฉ ููุฑุฒ ุญุณุจ ุงูุชุงุฑูุฎ
                const requestsArray = Object.values(chipRequests).sort((a, b) => 
                    new Date(b.requestedAt) - new Date(a.requestedAt)
                );
                
                requestsArray.forEach((request, index) => {
                    const requestId = Object.keys(chipRequests)[index];
                    const requestDate = request.requestedAt ? 
                        new Date(request.requestedAt).toLocaleString(currentLanguage === 'ar' ? 'ar-SA' : 'en-US') : 
                        'ุบูุฑ ูุนุฑูู';
                    
                    const urgentBadge = request.urgentRequest ? 
                        '<span class="status-badge status-pending">ุนุงุฌู/Urgent</span>' : 
                        '<span class="status-badge status-active">ุนุงุฏู/Normal</span>';
                    
                    const statusBadge = request.requestStatus === 'pending' ? 
                        '<span class="status-badge status-pending">ููุฏ ุงูุงูุชุธุงุฑ/Pending</span>' : 
                        request.requestStatus === 'approved' ? 
                        '<span class="status-badge status-active">ูุนุชูุฏุฉ/Approved</span>' : 
                        request.requestStatus === 'rejected' ? 
                        '<span class="status-badge status-inactive">ูุฑููุถุฉ/Rejected</span>' :
                        '<span class="status-badge status-success">ููุชููุฉ/Completed</span>';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${request.plateNumber}</strong></td>
                        <td>${request.requestType}</td>
                        <td>${request.currentChipNumber || 'ุบูุฑ ูุญุฏุฏ'}</td>
                        <td>${request.requestNotes || 'ูุง ุชูุฌุฏ ููุงุญุธุงุช'}</td>
                        <td>${urgentBadge}</td>
                        <td>${request.requestedBy}</td>
                        <td><span class="timestamp-cell">${requestDate}</span></td>
                        <td>${statusBadge}</td>
                        <td>
                            <div class="action-buttons">
                                ${request.requestStatus === 'pending' ? `
                                    <button class="action-btn approve-btn" onclick="updateChipRequestStatus('${requestId}', 'approved')">
                                        <i class="fas fa-check"></i> ${translate('approve')}
                                    </button>
                                    <button class="action-btn delete-btn" onclick="updateChipRequestStatus('${requestId}', 'rejected')">
                                        <i class="fas fa-times"></i> ุฑูุถ
                                    </button>
                                ` : request.requestStatus === 'approved' ? `
                                    <button class="action-btn approve-btn" onclick="updateChipRequestStatus('${requestId}', 'completed')">
                                        <i class="fas fa-check-double"></i> ุฅููุงู
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    `;
                    requestsBody.appendChild(row);
                });
            } else {
                requestsBody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 40px;">ูุง ุชูุฌุฏ ุทูุจุงุช ุดุฑุงุฆุญ</td></tr>`;
            }
            
            document.getElementById('chipRequestsCount').textContent = requestsCount;
        }

        // ุชุญุฏูุซ ุญุงูุฉ ุทูุจ ุงูุดุฑูุญุฉ
        async function updateChipRequestStatus(requestId, status) {
            const requestRef = database.ref('chipRequests/' + requestId);
            await requestRef.update({ 
                requestStatus: status,
                processedBy: currentUser.username,
                processedAt: new Date().toISOString()
            });
            
            showMessage('dashboardMessage', translate('chipRequestUpdated'), 'success');
            loadAdminChipRequests();
            loadChipRequests();
        }

        // ุชุตููุฉ ุทูุจุงุช ุงูุดุฑุงุฆุญ
        function filterChipRequests() {
            const statusFilter = document.getElementById('filterChipStatus');
            const urgentFilter = document.getElementById('filterUrgent');
            
            if (!statusFilter || !urgentFilter) return;
            
            const statusValue = statusFilter.value;
            const urgentValue = urgentFilter.value;
            
            const rows = document.querySelectorAll('#adminChipRequestsBody tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 8) return;
                
                const statusCell = cells[7];
                const status = statusCell.textContent.includes('ููุฏ ุงูุงูุชุธุงุฑ') ? 'pending' : 
                              statusCell.textContent.includes('ูุนุชูุฏุฉ') ? 'approved' :
                              statusCell.textContent.includes('ูุฑููุถุฉ') ? 'rejected' : 'completed';
                
                const urgentCell = cells[4];
                const isUrgent = urgentCell.textContent.includes('ุนุงุฌู');
                
                const statusMatch = !statusValue || status === statusValue;
                const urgentMatch = !urgentValue || 
                    (urgentValue === 'yes' && isUrgent) || 
                    (urgentValue === 'no' && !isUrgent);
                
                row.style.display = statusMatch && urgentMatch ? '' : 'none';
            });
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        async function loadPendingApprovals() {
            const pendingBody = document.getElementById('pendingBody');
            if (!pendingBody) return;
            
            pendingBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px;">ุฌุงุฑู ุงูุชุญููู...</td></tr>';
            
            const usersRef = database.ref('users');
            const snapshot = await usersRef.once('value');
            const users = snapshot.val();
            
            pendingBody.innerHTML = '';
            let pendingCount = 0;
            
            if (users) {
                Object.keys(users).forEach(key => {
                    const user = users[key];
                    if (user.status === 'pending' && user.role === 'supervisor') {
                        pendingCount++;
                        const registerDate = user.createdAt ? 
                            new Date(user.createdAt).toLocaleDateString(currentLanguage === 'ar' ? 'ar-SA' : 'en-US') : 
                            'ุบูุฑ ูุนุฑูู';
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><strong>${user.username}</strong></td>
                            <td>${user.password}</td>
                            <td>${user.project}</td>
                            <td>${user.area}</td>
                            <td>${registerDate}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn approve-btn" onclick="approveUser('${key}')">
                                        <i class="fas fa-check"></i> ${translate('approve')}
                                    </button>
                                    <button class="action-btn delete-btn" onclick="deleteUser('${key}')">
                                        <i class="fas fa-trash"></i> ${translate('delete')}
                                    </button>
                                </div>
                            </td>
                        `;
                        pendingBody.appendChild(row);
                    }
                });
            }
            
            document.getElementById('pendingCount').textContent = pendingCount;
            
            if (pendingCount === 0) {
                pendingBody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 40px;">ูุง ุชูุฌุฏ ุทูุจุงุช ูุนููุฉ</td></tr>`;
            }
        }

        async function loadAllUsers() {
            const usersBody = document.getElementById('usersBody');
            if (!usersBody) return;
            
            usersBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px;">ุฌุงุฑู ุงูุชุญููู...</td></tr>';
            
            const usersRef = database.ref('users');
            const snapshot = await usersRef.once('value');
            const users = snapshot.val();
            
            usersBody.innerHTML = '';
            let usersCount = 0;
            
            if (users) {
                Object.keys(users).forEach(key => {
                    const user = users[key];
                    if (user.username !== 'ูููุฏุง' && user.username !== 'Honda') {
                        usersCount++;
                        const lastLogin = user.lastLogin ? 
                            new Date(user.lastLogin).toLocaleString(currentLanguage === 'ar' ? 'ar-SA' : 'en-US') : 
                            'ูู ูุณุฌู ุฏุฎูู';
                        const statusClass = user.status === 'active' ? 'status-active' : 
                                           user.status === 'pending' ? 'status-pending' : 'status-inactive';
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><strong>${user.username}</strong></td>
                            <td>${user.password}</td>
                            <td>${user.project}</td>
                            <td>${user.area}</td>
                            <td><span class="status-badge ${statusClass}">${translate(user.status)}</span></td>
                            <td>${lastLogin}</td>
                            <td>
                                <div class="action-buttons">
                                    ${user.status === 'pending' ? `
                                        <button class="action-btn approve-btn" onclick="approveUser('${key}')">
                                            <i class="fas fa-check"></i> ${translate('approve')}
                                        </button>
                                    ` : user.status === 'active' ? `
                                        <button class="action-btn delete-btn" onclick="deactivateUser('${key}')">
                                            <i class="fas fa-user-slash"></i> ${translate('deactivateUser')}
                                        </button>
                                    ` : `
                                        <button class="action-btn approve-btn" onclick="activateUser('${key}')">
                                            <i class="fas fa-user-check"></i> ${translate('activateUser')}
                                        </button>
                                    `}
                                    <button class="action-btn delete-btn" onclick="deleteUser('${key}')">
                                        <i class="fas fa-trash"></i> ${translate('delete')}
                                    </button>
                                </div>
                            </td>
                        `;
                        usersBody.appendChild(row);
                    }
                });
            }
            
            document.getElementById('usersCount').textContent = usersCount;
            
            if (usersCount === 0) {
                usersBody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 40px;">ูุง ููุฌุฏ ูุณุชุฎุฏููู ูุณุฌููู</td></tr>`;
            }
            
            // ุชุญุฏูุซ ูุงุฆูุฉ ุงูุชุตููุฉ ูููุณุชุฎุฏููู
            updateUserFilterDropdown(users);
        }

        function updateUserFilterDropdown(users) {
            const userFilter = document.getElementById('filterUserVehicles');
            const adminUserFilter = document.getElementById('filterAdminUser');
            
            const filters = [userFilter, adminUserFilter];
            
            filters.forEach(filter => {
                if (!filter) return;
                
                filter.innerHTML = `<option value="" data-i18n="allUsers">${translate('allUsers')}</option>`;
                
                if (users) {
                    const uniqueUsers = new Set();
                    Object.values(users).forEach(user => {
                        if (user.username && user.username !== 'ูููุฏุง' && user.username !== 'Honda') {
                            uniqueUsers.add(user.username);
                        }
                    });
                    
                    uniqueUsers.forEach(username => {
                        const option = document.createElement('option');
                        option.value = username;
                        option.textContent = username;
                        filter.appendChild(option);
                    });
                }
            });
        }

        async function loadUserVehicleData() {
            const userVehicleDataBody = document.getElementById('userVehicleDataBody');
            if (!userVehicleDataBody) return;
            
            userVehicleDataBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px;">ุฌุงุฑู ุงูุชุญููู...</td></tr>';
            
            const vehiclesRef = database.ref('vehicles');
            const snapshot = await vehiclesRef.once('value');
            const vehicles = snapshot.val();
            
            userVehicleDataBody.innerHTML = '';
            let vehicleDataCount = 0;
            
            if (vehicles) {
                Object.keys(vehicles).forEach(key => {
                    const vehicle = vehicles[key];
                    vehicleDataCount++;
                    
                    const lastUpdate = vehicle.lastUpdatedAt ? 
                        new Date(vehicle.lastUpdatedAt).toLocaleString(currentLanguage === 'ar' ? 'ar-SA' : 'en-US') : 
                        new Date(vehicle.createdAt).toLocaleString(currentLanguage === 'ar' ? 'ar-SA' : 'en-US');
                    
                    const updateHistory = vehicle.updateHistory || [];
                    const historyText = updateHistory.map((entry, index) => {
                        const date = new Date(entry.updatedAt).toLocaleString(currentLanguage === 'ar' ? 'ar-SA' : 'en-US');
                        return `${index + 1}. ${date} - ${entry.updatedBy}: ${entry.changes || 'No details'}`;
                    }).join('<br>');
                    
                    const statusBadge = vehicle.vehicleStatus === 'working' ? 
                        '<span class="status-badge status-working">ุชุนูู/Working</span>' : 
                        '<span class="status-badge status-stopped">ูุชูููุฉ/Stopped</span>';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${vehicle.createdBy || 'Unknown'}</strong></td>
                        <td>${vehicle.plateNumber}</td>
                        <td>${vehicle.area}</td>
                        <td>${vehicle.previousProject}</td>
                        <td>${vehicle.currentProject}</td>
                        <td>${statusBadge}</td>
                        <td><span class="timestamp-cell">${lastUpdate}</span></td>
                        <td><div style="max-height: 100px; overflow-y: auto; font-size: 0.85rem;">${historyText || 'ูุง ููุฌุฏ ุณุฌู ุชุญุฏูุซุงุช'}</div></td>
                    `;
                    userVehicleDataBody.appendChild(row);
                });
            }
            
            document.getElementById('vehicleDataCount').textContent = vehicleDataCount;
            
            if (vehicleDataCount === 0) {
                userVehicleDataBody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 40px;">ูุง ุชูุฌุฏ ุจูุงูุงุช ูุฑูุจุงุช</td></tr>`;
            }
        }

        function filterUserVehicleData() {
            const userFilter = document.getElementById('filterUserVehicles');
            const dateFilter = document.getElementById('filterDate');
            
            if (!userFilter || !dateFilter) return;
            
            const selectedUser = userFilter.value;
            const selectedDate = dateFilter.value;
            
            const rows = document.querySelectorAll('#userVehicleDataBody tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 8) return;
                
                const username = cells[0].textContent.trim();
                const lastUpdateCell = cells[6].querySelector('.timestamp-cell');
                const lastUpdate = lastUpdateCell ? lastUpdateCell.textContent : '';
                
                const userMatch = !selectedUser || username === selectedUser;
                const dateMatch = !selectedDate || lastUpdate.includes(selectedDate);
                
                row.style.display = userMatch && dateMatch ? '' : 'none';
            });
        }

        // ุชุตููุฉ ุจูุงูุงุช ุงููุณุชุฎุฏููู ูู ููุญุฉ ุงููุณุคูู
        function filterAdminUserData() {
            const userFilter = document.getElementById('filterAdminUser');
            if (!userFilter) return;
            
            const selectedUser = userFilter.value;
            
            const rows = document.querySelectorAll('#usersBody tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 6) return;
                
                const username = cells[0].textContent.trim();
                const userMatch = !selectedUser || username === selectedUser;
                
                row.style.display = userMatch ? '' : 'none';
            });
        }

        async function approveUser(userId) {
            const userRef = database.ref('users/' + userId);
            await userRef.update({ 
                status: 'active',
                approvedAt: new Date().toISOString(),
                approvedBy: currentUser.username
            });
            showMessage('dashboardMessage', translate('userApproved'), 'success');
            loadPendingApprovals();
            loadAllUsers();
        }

        async function deactivateUser(userId) {
            if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุชุนุทูู ูุฐุง ุงููุณุชุฎุฏูุ')) {
                const userRef = database.ref('users/' + userId);
                await userRef.update({ status: 'inactive' });
                showMessage('dashboardMessage', 'ุชู ุชุนุทูู ุงููุณุชุฎุฏู ุจูุฌุงุญ', 'success');
                loadAllUsers();
            }
        }

        async function activateUser(userId) {
            const userRef = database.ref('users/' + userId);
            await userRef.update({ status: 'active' });
            showMessage('dashboardMessage', 'ุชู ุชูุนูู ุงููุณุชุฎุฏู ุจูุฌุงุญ', 'success');
            loadAllUsers();
        }

        async function deleteUser(userId) {
            if (confirm(translate('confirmDelete'))) {
                const userRef = database.ref('users/' + userId);
                await userRef.remove();
                showMessage('dashboardMessage', translate('userDeleted'), 'success');
                loadPendingApprovals();
                loadAllUsers();
            }
        }

        // ุชุญููู ุฌููุน ุงูุจูุงูุงุช ูููู Excel
        async function downloadAllDataExcel() {
            try {
                // ุฌูุจ ุฌููุน ุงูุจูุงูุงุช
                const vehiclesRef = database.ref('vehicles');
                const usersRef = database.ref('users');
                const chipRequestsRef = database.ref('chipRequests');
                
                const [vehiclesSnapshot, usersSnapshot, chipRequestsSnapshot] = await Promise.all([
                    vehiclesRef.once('value'),
                    usersRef.once('value'),
                    chipRequestsRef.once('value')
                ]);
                
                const vehicles = vehiclesSnapshot.val();
                const users = usersSnapshot.val();
                const chipRequests = chipRequestsSnapshot.val();
                
                // ุฅูุดุงุก ูุตูู Excel ูุชุนุฏุฏ ุงูุฃูุฑุงู
                const wb = XLSX.utils.book_new();
                
                // 1. ูุฑูุฉ ุงููุฑูุจุงุช
                const vehiclesHeaders = [[
                    'ุฑูู ุงูููุญุฉ/Plate Number',
                    'ุงูููุทูุฉ/Area',
                    'ุงููุดุฑูุน ุงูุณุงุจู/Previous Project',
                    'ุงููุดุฑูุน ุงูุญุงูู/Current Project',
                    'ุญุงูุฉ ุงููุฑูุจุฉ/Vehicle Status',
                    'ูุนูููุงุช ุฅุถุงููุฉ/Additional Info',
                    'ุฃูุดุฆ ุจูุงุณุทุฉ/Created By',
                    'ุชุงุฑูุฎ ุงูุฅูุดุงุก/Created At',
                    'ุขุฎุฑ ุชุญุฏูุซ ุจูุงุณุทุฉ/Last Updated By',
                    'ุขุฎุฑ ุชุญุฏูุซ/Last Updated At'
                ]];
                
                const vehiclesData = [];
                if (vehicles) {
                    Object.values(vehicles).forEach(vehicle => {
                        vehiclesData.push([
                            vehicle.plateNumber || '',
                            vehicle.area || '',
                            vehicle.previousProject || '',
                            vehicle.currentProject || '',
                            vehicle.vehicleStatus === 'working' ? 'ุชุนูู/Working' : 'ูุชูููุฉ/Stopped',
                            vehicle.additionalInfo || '',
                            vehicle.createdBy || '',
                            vehicle.createdAt ? new Date(vehicle.createdAt).toLocaleString('ar-SA') : '',
                            vehicle.lastUpdatedBy || '',
                            vehicle.lastUpdatedAt ? new Date(vehicle.lastUpdatedAt).toLocaleString('ar-SA') : ''
                        ]);
                    });
                }
                
                const vehiclesSheet = XLSX.utils.aoa_to_sheet(vehiclesHeaders.concat(vehiclesData));
                XLSX.utils.book_append_sheet(wb, vehiclesSheet, "ุงููุฑูุจุงุช");
                
                // 2. ูุฑูุฉ ุงููุณุชุฎุฏููู
                const usersHeaders = [[
                    'ุงุณู ุงููุณุชุฎุฏู/Username',
                    'ูููุฉ ุงููุฑูุฑ/Password',
                    'ุงููุดุฑูุน/Project',
                    'ุงูููุทูุฉ/Area',
                    'ุงูุฏูุฑ/Role',
                    'ุงูุญุงูุฉ/Status',
                    'ุชุงุฑูุฎ ุงูุชุณุฌูู/Registration Date',
                    'ุขุฎุฑ ุฏุฎูู/Last Login'
                ]];
                
                const usersData = [];
                if (users) {
                    Object.values(users).forEach(user => {
                        usersData.push([
                            user.username || '',
                            user.password || '',
                            user.project || '',
                            user.area || '',
                            user.role || '',
                            user.status || '',
                            user.createdAt ? new Date(user.createdAt).toLocaleString('ar-SA') : '',
                            user.lastLogin ? new Date(user.lastLogin).toLocaleString('ar-SA') : ''
                        ]);
                    });
                }
                
                const usersSheet = XLSX.utils.aoa_to_sheet(usersHeaders.concat(usersData));
                XLSX.utils.book_append_sheet(wb, usersSheet, "ุงููุณุชุฎุฏููู");
                
                // 3. ูุฑูุฉ ุทูุจุงุช ุงูุดุฑุงุฆุญ
                const chipRequestsHeaders = [[
                    'ุฑูู ุงูููุญุฉ/Plate Number',
                    'ููุน ุงูุทูุจ/Request Type',
                    'ุฑูู ุงูุดุฑูุญุฉ ุงูุญุงูู/Current Chip Number',
                    'ููุงุญุธุงุช ุงูุทูุจ/Request Notes',
                    'ุทูุจ ุนุงุฌู/Urgent Request',
                    'ุญุงูุฉ ุงูุทูุจ/Request Status',
                    'ููุฏู ุงูุทูุจ/Requested By',
                    'ุชุงุฑูุฎ ุงูุทูุจ/Request Date',
                    'ูุนุงูุฌ ุจูุงุณุทุฉ/Processed By',
                    'ุชุงุฑูุฎ ุงููุนุงูุฌุฉ/Processed At'
                ]];
                
                const chipRequestsData = [];
                if (chipRequests) {
                    Object.values(chipRequests).forEach(request => {
                        chipRequestsData.push([
                            request.plateNumber || '',
                            request.requestType || '',
                            request.currentChipNumber || '',
                            request.requestNotes || '',
                            request.urgentRequest ? 'ูุนู/Yes' : 'ูุง/No',
                            request.requestStatus || '',
                            request.requestedBy || '',
                            request.requestedAt ? new Date(request.requestedAt).toLocaleString('ar-SA') : '',
                            request.processedBy || '',
                            request.processedAt ? new Date(request.processedAt).toLocaleString('ar-SA') : ''
                        ]);
                    });
                }
                
                const chipRequestsSheet = XLSX.utils.aoa_to_sheet(chipRequestsHeaders.concat(chipRequestsData));
                XLSX.utils.book_append_sheet(wb, chipRequestsSheet, "ุทูุจุงุช ุงูุดุฑุงุฆุญ");
                
                // ุชุญููู ุงูููู
                const filename = `ุฌููุน_ุงูุจูุงูุงุช_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, filename);
                showMessage('dashboardMessage', 'ุชู ุชุญููู ุฌููุน ุงูุจูุงูุงุช ุจูุฌุงุญ', 'success');
                
            } catch (error) {
                console.error('Error downloading all data:', error);
                showMessage('dashboardMessage', 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูุจูุงูุงุช', 'error');
            }
        }

        // ุชุญููู ุจูุงูุงุช ุงููุณุชุฎุฏููู
        async function downloadUsersDataExcel() {
            try {
                const usersRef = database.ref('users');
                const snapshot = await usersRef.once('value');
                const users = snapshot.val();
                
                const headers = [[
                    'ุงุณู ุงููุณุชุฎุฏู/Username',
                    'ูููุฉ ุงููุฑูุฑ/Password',
                    'ุงููุดุฑูุน/Project',
                    'ุงูููุทูุฉ/Area',
                    'ุงูุฏูุฑ/Role',
                    'ุงูุญุงูุฉ/Status',
                    'ุชุงุฑูุฎ ุงูุชุณุฌูู/Registration Date',
                    'ุขุฎุฑ ุฏุฎูู/Last Login'
                ]];
                
                const data = [];
                if (users) {
                    Object.values(users).forEach(user => {
                        data.push([
                            user.username || '',
                            user.password || '',
                            user.project || '',
                            user.area || '',
                            user.role || '',
                            user.status || '',
                            user.createdAt ? new Date(user.createdAt).toLocaleString('ar-SA') : '',
                            user.lastLogin ? new Date(user.lastLogin).toLocaleString('ar-SA') : ''
                        ]);
                    });
                }
                
                const allData = headers.concat(data);
                const ws = XLSX.utils.aoa_to_sheet(allData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "ุงููุณุชุฎุฏููู");
                
                // ุชุญููู ุงูููู
                const filename = `ุจูุงูุงุช_ุงููุณุชุฎุฏููู_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, filename);
                showMessage('dashboardMessage', `ุชู ุชุญููู ${data.length} ูุณุชุฎุฏู ุจูุฌุงุญ`, 'success');
                
            } catch (error) {
                console.error('Error downloading users data:', error);
                showMessage('dashboardMessage', 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุจูุงูุงุช ุงููุณุชุฎุฏููู', 'error');
            }
        }

        // ุชุญููู ุทูุจุงุช ุงูุดุฑุงุฆุญ
        async function downloadChipRequestsExcel() {
            try {
                const chipRequestsRef = database.ref('chipRequests');
                const snapshot = await chipRequestsRef.once('value');
                const chipRequests = snapshot.val();
                
                const headers = [[
                    'ุฑูู ุงูููุญุฉ/Plate Number',
                    'ููุน ุงูุทูุจ/Request Type',
                    'ุฑูู ุงูุดุฑูุญุฉ ุงูุญุงูู/Current Chip Number',
                    'ููุงุญุธุงุช ุงูุทูุจ/Request Notes',
                    'ุทูุจ ุนุงุฌู/Urgent Request',
                    'ุญุงูุฉ ุงูุทูุจ/Request Status',
                    'ููุฏู ุงูุทูุจ/Requested By',
                    'ุชุงุฑูุฎ ุงูุทูุจ/Request Date',
                    'ุฑูู ุงูุทูุจ/Request ID'
                ]];
                
                const data = [];
                if (chipRequests) {
                    Object.values(chipRequests).forEach(request => {
                        data.push([
                            request.plateNumber || '',
                            request.requestType || '',
                            request.currentChipNumber || '',
                            request.requestNotes || '',
                            request.urgentRequest ? 'ูุนู/Yes' : 'ูุง/No',
                            request.requestStatus || '',
                            request.requestedBy || '',
                            request.requestedAt ? new Date(request.requestedAt).toLocaleString('ar-SA') : '',
                            request.requestId || ''
                        ]);
                    });
                }
                
                const allData = headers.concat(data);
                const ws = XLSX.utils.aoa_to_sheet(allData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "ุทูุจุงุช ุงูุดุฑุงุฆุญ");
                
                // ุชุญููู ุงูููู
                const filename = `ุทูุจุงุช_ุงูุดุฑุงุฆุญ_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, filename);
                showMessage('dashboardMessage', `ุชู ุชุญููู ${data.length} ุทูุจ ุดุฑูุญุฉ ุจูุฌุงุญ`, 'success');
                
            } catch (error) {
                console.error('Error downloading chip requests:', error);
                showMessage('dashboardMessage', 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุทูุจุงุช ุงูุดุฑุงุฆุญ', 'error');
            }
        }

        // ุชุญููู ุจูุงูุงุช ูุณุชุฎุฏู ูุญุฏุฏ
        async function downloadUserSpecificData() {
            const userFilter = document.getElementById('filterAdminUser');
            if (!userFilter) return;
            
            const selectedUser = userFilter.value;
            if (!selectedUser) {
                showMessage('dashboardMessage', 'ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ูุณุชุฎุฏู ุฃููุงู', 'error');
                return;
            }
            
            try {
                // ุฌูุจ ุจูุงูุงุช ุงููุฑูุจุงุช ููุฐุง ุงููุณุชุฎุฏู
                const vehiclesRef = database.ref('vehicles');
                const snapshot = await vehiclesRef.orderByChild('createdBy').equalTo(selectedUser).once('value');
                const vehicles = snapshot.val();
                
                const headers = [[
                    'ุฑูู ุงูููุญุฉ/Plate Number',
                    'ุงูููุทูุฉ/Area',
                    'ุงููุดุฑูุน ุงูุณุงุจู/Previous Project',
                    'ุงููุดุฑูุน ุงูุญุงูู/Current Project',
                    'ุญุงูุฉ ุงููุฑูุจุฉ/Vehicle Status',
                    'ุชุงุฑูุฎ ุงูุฅูุดุงุก/Created At',
                    'ุขุฎุฑ ุชุญุฏูุซ/Last Update',
                    'ุนุฏุฏ ุงูุชุญุฏูุซุงุช/Update Count'
                ]];
                
                const data = [];
                if (vehicles) {
                    Object.values(vehicles).forEach(vehicle => {
                        const updateHistory = vehicle.updateHistory || [];
                        data.push([
                            vehicle.plateNumber || '',
                            vehicle.area || '',
                            vehicle.previousProject || '',
                            vehicle.currentProject || '',
                            vehicle.vehicleStatus === 'working' ? 'ุชุนูู/Working' : 'ูุชูููุฉ/Stopped',
                            vehicle.createdAt ? new Date(vehicle.createdAt).toLocaleString('ar-SA') : '',
                            vehicle.lastUpdatedAt ? new Date(vehicle.lastUpdatedAt).toLocaleString('ar-SA') : '',
                            updateHistory.length
                        ]);
                    });
                }
                
                if (data.length === 0) {
                    showMessage('dashboardMessage', 'ูุง ุชูุฌุฏ ุจูุงูุงุช ููุฐุง ุงููุณุชุฎุฏู', 'info');
                    return;
                }
                
                const allData = headers.concat(data);
                const ws = XLSX.utils.aoa_to_sheet(allData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, `ุจูุงูุงุช_${selectedUser}`);
                
                // ุชุญููู ุงูููู
                const filename = `ุจูุงูุงุช_${selectedUser}_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, filename);
                showMessage('dashboardMessage', `ุชู ุชุญููู ${data.length} ูุฑูุจุฉ ูููุณุชุฎุฏู ${selectedUser}`, 'success');
                
            } catch (error) {
                console.error('Error downloading user data:', error);
                showMessage('dashboardMessage', 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุจูุงูุงุช ุงููุณุชุฎุฏู', 'error');
            }
        }

        // ุชุญููู ุงูุจูุงูุงุช ุงููุตูุงุฉ
        async function downloadFilteredVehicleData() {
            try {
                const userFilter = document.getElementById('filterUserVehicles');
                const dateFilter = document.getElementById('filterDate');
                
                const selectedUser = userFilter ? userFilter.value : '';
                const selectedDate = dateFilter ? dateFilter.value : '';
                
                // ุฌูุจ ุฌููุน ุงูุจูุงูุงุช
                const vehiclesRef = database.ref('vehicles');
                const snapshot = await vehiclesRef.once('value');
                const vehicles = snapshot.val();
                
                if (!vehicles) {
                    showMessage('dashboardMessage', 'ูุง ุชูุฌุฏ ุจูุงูุงุช ูุฑูุจุงุช', 'info');
                    return;
                }
                
                // ุชุตููุฉ ุงูุจูุงูุงุช
                const filteredData = [];
                Object.values(vehicles).forEach(vehicle => {
                    // ุชุทุจูู ุงูููุงุชุฑ
                    if (selectedUser && vehicle.createdBy !== selectedUser) return;
                    
                    if (selectedDate) {
                        const vehicleDate = vehicle.createdAt ? 
                            new Date(vehicle.createdAt).toISOString().slice(0, 10) : '';
                        if (vehicleDate !== selectedDate) return;
                    }
                    
                    filteredData.push([
                        vehicle.plateNumber || '',
                        vehicle.area || '',
                        vehicle.previousProject || '',
                        vehicle.currentProject || '',
                        vehicle.vehicleStatus === 'working' ? 'ุชุนูู/Working' : 'ูุชูููุฉ/Stopped',
                        vehicle.createdBy || '',
                        vehicle.createdAt ? new Date(vehicle.createdAt).toLocaleString('ar-SA') : '',
                        vehicle.lastUpdatedAt ? new Date(vehicle.lastUpdatedAt).toLocaleString('ar-SA') : ''
                    ]);
                });
                
                if (filteredData.length === 0) {
                    showMessage('dashboardMessage', 'ูุง ุชูุฌุฏ ุจูุงูุงุช ูุทุงุจูุฉ ููููุงุชุฑ', 'info');
                    return;
                }
                
                const headers = [[
                    'ุฑูู ุงูููุญุฉ/Plate Number',
                    'ุงูููุทูุฉ/Area',
                    'ุงููุดุฑูุน ุงูุณุงุจู/Previous Project',
                    'ุงููุดุฑูุน ุงูุญุงูู/Current Project',
                    'ุญุงูุฉ ุงููุฑูุจุฉ/Vehicle Status',
                    'ุฃูุดุฆ ุจูุงุณุทุฉ/Created By',
                    'ุชุงุฑูุฎ ุงูุฅูุดุงุก/Created At',
                    'ุขุฎุฑ ุชุญุฏูุซ/Last Update'
                ]];
                
                const allData = headers.concat(filteredData);
                const ws = XLSX.utils.aoa_to_sheet(allData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "ุงููุฑูุจุงุช ุงููุตูุงุฉ");
                
                // ุชุญููู ุงูููู
                const filename = `ูุฑูุจุงุช_ูุตูุงุฉ_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, filename);
                showMessage('dashboardMessage', `ุชู ุชุญููู ${filteredData.length} ูุฑูุจุฉ ุจูุฌุงุญ`, 'success');
                
            } catch (error) {
                console.error('Error downloading filtered data:', error);
                showMessage('dashboardMessage', 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูุจูุงูุงุช ุงููุตูุงุฉ', 'error');
            }
        }

        function checkAuth() {
            const savedUser = localStorage.getItem('petroweb_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showDashboard();
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('petroweb_user');
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('loginForm').reset();
            document.getElementById('registerForm').reset();
        }

        // ===== ุฏูุงู ุงูุชุญุฏูุซ ุงูุฌูุงุนู - ูุตุญุญุฉ =====

        // Select update option
        function selectUpdateOption(option, element) {
            bulkUpdateOption = option;
            
            // Update button states
            document.querySelectorAll('.selection-option').forEach(btn => {
                btn.classList.remove('active');
            });
            element.classList.add('active');
            
            // Show/hide checkboxes
            const showCheckboxes = option === 'manual';
            document.getElementById('selectAllHeader').style.display = showCheckboxes ? 'table-cell' : 'none';
            document.querySelectorAll('.vehicle-checkbox').forEach(cb => {
                cb.style.display = showCheckboxes ? 'table-cell' : 'none';
            });
            
            // Update selection
            updateVehicleSelection();
        }

        // Load vehicles for bulk update
        async function loadVehiclesForBulkUpdate() {
            const selectionBody = document.getElementById('selectionBody');
            if (!selectionBody) return;
            
            selectionBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">ุฌุงุฑู ุชุญููู ุงููุฑูุจุงุช...</td></tr>';
            
            let query = database.ref('vehicles');
            if (currentUser.role === 'supervisor') {
                query = query.orderByChild('createdBy').equalTo(currentUser.username);
            }
            
            const snapshot = await query.once('value');
            const vehicles = snapshot.val();
            
            allVehiclesData = [];
            selectionBody.innerHTML = '';
            selectedVehicles.clear();
            
            if (vehicles) {
                Object.keys(vehicles).forEach(key => {
                    const vehicle = vehicles[key];
                    vehicle.id = key;
                    allVehiclesData.push(vehicle);
                    
                    const lastUpdate = vehicle.lastUpdatedAt ? 
                        new Date(vehicle.lastUpdatedAt).toLocaleString(currentLanguage === 'ar' ? 'ar-SA' : 'en-US') : 
                        new Date(vehicle.createdAt).toLocaleString(currentLanguage === 'ar' ? 'ar-SA' : 'en-US');
                    
                    const statusBadge = vehicle.vehicleStatus === 'working' ? 
                        '<span class="status-badge status-working">ุชุนูู/Working</span>' : 
                        '<span class="status-badge status-stopped">ูุชูููุฉ/Stopped</span>';
                    
                    const row = document.createElement('tr');
                    row.dataset.vehicleId = key;
                    row.dataset.currentStatus = vehicle.vehicleStatus;
                    
                    row.innerHTML = `
                        <td class="vehicle-checkbox" style="display: none; text-align: center;">
                            <input type="checkbox" class="vehicle-select" onchange="updateVehicleSelection()" data-vehicle-id="${key}">
                        </td>
                        <td><strong>${vehicle.plateNumber}</strong></td>
                        <td>${vehicle.area}</td>
                        <td>${vehicle.currentProject}</td>
                        <td>${statusBadge}</td>
                        <td><span class="timestamp-cell">${lastUpdate}</span></td>
                        <td id="needsUpdate-${key}">
                            <span class="status-badge status-pending">ูุชู ุงูุชุญูู...</span>
                        </td>
                    `;
                    selectionBody.appendChild(row);
                });
            } else {
                selectionBody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 40px;">ูุง ุชูุฌุฏ ูุฑูุจุงุช</td></tr>`;
            }
            
            document.getElementById('totalCount').textContent = allVehiclesData.length;
            updateVehicleSelection();
        }

        // Update vehicle selection based on current option - ูุตุญุญุฉ
        function updateVehicleSelection() {
            const newStatus = document.getElementById('bulkNewStatus').value;
            selectedVehicles.clear();
            
            if (!newStatus) {
                document.getElementById('selectedCount').textContent = '0';
                document.getElementById('bulkCount').textContent = '0';
                document.getElementById('bulkUpdateBtn').disabled = true;
                document.getElementById('updateInfo').style.display = 'none';
                
                // ุฅุนุงุฏุฉ ุชุนููู ุฌููุน ุงููุฑูุจุงุช ุจู "ูุชู ุงูุชุญูู"
                allVehiclesData.forEach(vehicle => {
                    const needsUpdateCell = document.getElementById(`needsUpdate-${vehicle.id}`);
                    if (needsUpdateCell) {
                        needsUpdateCell.innerHTML = '<span class="status-badge status-pending">ูุชู ุงูุชุญูู...</span>';
                    }
                });
                return;
            }
            
            let count = 0;
            let needsUpdateCount = 0;
            
            allVehiclesData.forEach(vehicle => {
                let shouldSelect = false;
                let needsUpdate = false;
                
                // ุงูุชุญูู ูู ุฃู ุงููุฑูุจุฉ ุชุณุชููู ุดุฑูุท ุงูุฎูุงุฑ ุงููุญุฏุฏ
                const statusMatch = (bulkUpdateOption === 'working' && vehicle.vehicleStatus === 'working') ||
                                   (bulkUpdateOption === 'stopped' && vehicle.vehicleStatus === 'stopped') ||
                                   (bulkUpdateOption === 'all');
                
                if (bulkUpdateOption === 'manual') {
                    const checkbox = document.querySelector(`.vehicle-select[data-vehicle-id="${vehicle.id}"]`);
                    shouldSelect = checkbox ? checkbox.checked : false;
                    needsUpdate = shouldSelect && vehicle.vehicleStatus !== newStatus;
                } else if (statusMatch) {
                    shouldSelect = true;
                    needsUpdate = vehicle.vehicleStatus !== newStatus;
                }
                
                if (shouldSelect) {
                    selectedVehicles.add(vehicle.id);
                    count++;
                    
                    if (needsUpdate) {
                        needsUpdateCount++;
                    }
                }
                
                // ุชุญุฏูุซ ูุคุดุฑ "ูุญุชุงุฌ ุชุญุฏูุซ"
                const needsUpdateCell = document.getElementById(`needsUpdate-${vehicle.id}`);
                if (needsUpdateCell) {
                    if (vehicle.vehicleStatus === newStatus) {
                        needsUpdateCell.innerHTML = '<span class="status-badge status-active">ูุง ูุญุชุงุฌ</span>';
                    } else if (statusMatch || (bulkUpdateOption === 'manual' && shouldSelect)) {
                        needsUpdateCell.innerHTML = '<span class="status-badge status-warning">ูุญุชุงุฌ ุชุญุฏูุซ</span>';
                    } else {
                        needsUpdateCell.innerHTML = '<span class="status-badge status-inactive">ุบูุฑ ูุทููุจ</span>';
                    }
                }
            });
            
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('bulkCount').textContent = needsUpdateCount;
            document.getElementById('updateInfo').style.display = needsUpdateCount > 0 ? 'flex' : 'none';
            document.getElementById('bulkUpdateBtn').disabled = needsUpdateCount === 0;
        }

        // Toggle select all
        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.vehicle-select');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateVehicleSelection();
        }

        // Confirm bulk update
        function confirmBulkUpdate() {
            const newStatus = document.getElementById('bulkNewStatus').value;
            const notes = document.getElementById('bulkStatusNotes').value;
            const needsUpdateCount = parseInt(document.getElementById('bulkCount').textContent);
            
            if (needsUpdateCount === 0) {
                showMessage('dashboardMessage', 'ูุง ุชูุฌุฏ ูุฑูุจุงุช ุชุญุชุงุฌ ููุชุญุฏูุซ', 'info');
                return;
            }
            
            const statusText = newStatus === 'working' ? 'ุชุนูู' : 'ูุชูููุฉ';
            const currentOptionText = bulkUpdateOption === 'all' ? 'ุฌููุน ุงููุฑูุจุงุช' :
                             bulkUpdateOption === 'working' ? 'ุงููุฑูุจุงุช ุงูุชู ุชุนูู ููุท' :
                             bulkUpdateOption === 'stopped' ? 'ุงููุฑูุจุงุช ุงููุชูููุฉ ููุท' : 'ุงููุฑูุจุงุช ุงููุญุฏุฏุฉ ูุฏููุงู';
            
            const confirmationMessage = `
                <div style="text-align: right; padding: 20px;">
                    <h3 style="color: var(--primary); margin-bottom: 15px;">ุชุฃููุฏ ุงูุชุญุฏูุซ ุงูุฌูุงุนู</h3>
                    <p><strong>ุฎูุงุฑ ุงูุชุญุฏูุซ:</strong> ${currentOptionText}</p>
                    <p><strong>ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ:</strong> ${statusText}</p>
                    <p><strong>ุนุฏุฏ ุงููุฑูุจุงุช ุงูุชู ุณูุชู ุชุญุฏูุซูุง:</strong> ${needsUpdateCount}</p>
                    ${notes ? `<p><strong>ุงูููุงุญุธุงุช:</strong> ${notes}</p>` : ''}
                    <p style="color: var(--warning); margin-top: 20px;">ูู ุฃูุช ูุชุฃูุฏ ูู ุชูููุฐ ูุฐุง ุงูุชุญุฏูุซุ</p>
                </div>
            `;
            
            // ุฅูุดุงุก ููุฏุงู ุชุฃููุฏ ูุฎุตุต
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2><i class="fas fa-exclamation-triangle"></i> ุชุฃููุฏ ุงูุชุญุฏูุซ</h2>
                        <button class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${confirmationMessage}
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-success" onclick="this.closest('.modal-overlay').remove(); performBulkUpdate('${newStatus}', '${notes}')" style="flex: 1;">
                                <i class="fas fa-check"></i> ุชุฃููุฏ ุงูุชุญุฏูุซ
                            </button>
                            <button class="btn btn-danger" onclick="this.closest('.modal-overlay').remove()" style="flex: 1;">
                                <i class="fas fa-times"></i> ุฅูุบุงุก
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Perform bulk update - ูุตุญุญุฉ
        async function performBulkUpdate(newStatus, notes) {
            showMessage('dashboardMessage', 'ุฌุงุฑู ุชุญุฏูุซ ุงููุฑูุจุงุช...', 'info');
            
            const now = new Date();
            let successCount = 0;
            let errorCount = 0;
            let skippedCount = 0;
            
            // ุฅูุดุงุก ูุตูููุฉ ูู ุงููุฑูุจุงุช ุงููุญุฏุฏุฉ ููุชุญุฏูุซ
            const vehiclesToUpdate = Array.from(selectedVehicles);
            
            console.log('Vehicles to update:', vehiclesToUpdate);
            
            for (const vehicleId of vehiclesToUpdate) {
                try {
                    // ุงูุจุญุซ ุนู ุจูุงูุงุช ุงููุฑูุจุฉ
                    const vehicle = allVehiclesData.find(v => v.id === vehicleId);
                    if (!vehicle) {
                        console.error('Vehicle not found in local data:', vehicleId);
                        continue;
                    }
                    
                    // ุงูุชุญูู ุฅุฐุง ูุงูุช ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ ุชุฎุชูู ุนู ุงูุญุงูุฉ ุงูุญุงููุฉ
                    if (vehicle.vehicleStatus === newStatus) {
                        console.log(`Skipping ${vehicle.plateNumber} - already ${newStatus}`);
                        skippedCount++;
                        continue;
                    }
                    
                    // ุชุญุฏูุซ ุงูุญุงูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
                    const vehicleRef = database.ref('vehicles/' + vehicleId);
                    
                    const updates = {
                        vehicleStatus: newStatus,
                        lastUpdatedBy: currentUser.username,
                        lastUpdatedAt: now.toISOString()
                    };
                    
                    const updateEntry = {
                        updatedBy: currentUser.username,
                        updatedAt: now.toISOString(),
                        changes: `Bulk update: Status changed from ${vehicle.vehicleStatus} to ${newStatus}`,
                        notes: notes || 'Bulk update'
                    };
                    
                    const updateHistory = vehicle.updateHistory || [];
                    updateHistory.push(updateEntry);
                    updates.updateHistory = updateHistory;
                    
                    await vehicleRef.update(updates);
                    
                    // ุฅุถุงูุฉ ุฅูู ุณุฌู ุญุงูุงุช ุงููุฑูุจุงุช
                    const statusHistoryRef = database.ref('vehicleStatusHistory');
                    await statusHistoryRef.push({
                        plateNumber: vehicle.plateNumber,
                        vehicleStatus: newStatus,
                        statusNotes: notes || 'Bulk update',
                        updatedBy: currentUser.username,
                        updatedAt: now.toISOString(),
                        vehicleId: vehicleId,
                        bulkUpdate: true
                    });
                    
                    successCount++;
                    
                    // ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููุญููุฉ ููุฑุงู
                    vehicle.vehicleStatus = newStatus;
                    vehicle.lastUpdatedAt = now.toISOString();
                    vehicle.lastUpdatedBy = currentUser.username;
                    
                    // ุชุญุฏูุซ ูุงุฌูุฉ ุงููุณุชุฎุฏู ููุฑุงู
                    const row = document.querySelector(`tr[data-vehicle-id="${vehicleId}"]`);
                    if (row) {
                        const statusCell = row.querySelector('td:nth-child(5)');
                        if (statusCell) {
                            statusCell.innerHTML = newStatus === 'working' ? 
                                '<span class="status-badge status-working">ุชุนูู/Working</span>' : 
                                '<span class="status-badge status-stopped">ูุชูููุฉ/Stopped</span>';
                        }
                        
                        const needsUpdateCell = document.getElementById(`needsUpdate-${vehicleId}`);
                        if (needsUpdateCell) {
                            needsUpdateCell.innerHTML = '<span class="status-badge status-active">ุชู ุงูุชุญุฏูุซ</span>';
                        }
                    }
                    
                } catch (error) {
                    console.error('Error updating vehicle:', error, vehicleId);
                    errorCount++;
                }
            }
            
            const message = `ุชู ุชุญุฏูุซ ${successCount} ูุฑูุจุฉ ุจูุฌุงุญ${skippedCount > 0 ? `ุ ุชู ุชุฎุทู ${skippedCount} ูุฑูุจุฉ` : ''}${errorCount > 0 ? `ุ ูุดู ุชุญุฏูุซ ${errorCount} ูุฑูุจุฉ` : ''}`;
            showMessage('dashboardMessage', message, successCount > 0 ? 'success' : 'error');
            
            // ุชุญุฏูุซ ุงูุนุฏุงุฏุงุช
            document.getElementById('selectedCount').textContent = '0';
            document.getElementById('bulkCount').textContent = '0';
            document.getElementById('bulkUpdateBtn').disabled = true;
            
            // ุชุญุฏูุซ ุณุฌูุงุช ุงููุฑูุจุงุช ูุชุงุฑูุฎ ุงูุญุงูุงุช ุจุนุฏ ุงูุชุญุฏูุซ
            setTimeout(() => {
                loadVehicleRecords();
                loadVehicleStatusHistory();
                // ุฅุนุงุฏุฉ ุชุญููู ุจูุงูุงุช ุงูุชุญุฏูุซ ุงูุฌูุงุนู
                loadVehiclesForBulkUpdate();
            }, 1500);
        }

        // ุชุญุฏูุซ: ุฅุถุงูุฉ ุญุฏุซ ุชุบููุฑ ููุญุงูุฉ ุงูุฌุฏูุฏุฉ
        document.getElementById('bulkNewStatus').addEventListener('change', function() {
            updateVehicleSelection();
        });

        // ุชููุฆุฉ ุงูุชุทุจูู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
        window.onload = initApp;
    </script>
</body>
</html>
